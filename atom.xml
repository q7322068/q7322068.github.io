<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>足迹|成长之路</title>
  
  <subtitle>实战经验梳理，分享与你，分享与自己！</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.onecoderspace.com/"/>
  <updated>2017-10-29T12:51:39.000Z</updated>
  <id>http://www.onecoderspace.com/</id>
  
  <author>
    <name>杨文魁</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>代码生成器</title>
    <link href="http://www.onecoderspace.com/2017/10/29/code-generator/"/>
    <id>http://www.onecoderspace.com/2017/10/29/code-generator/</id>
    <published>2017-10-29T11:14:45.000Z</published>
    <updated>2017-10-29T12:51:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>在规模较小的公司里，大部分的项目规模不是特别大，技术实现难度不是很高，关注点更多是在业务功能的开发及保证业务流程的正确性上。当有一个新的项目来时，通常会找一个项目进行copy，删除不用的包和类，然后以此为基础，进行后续的开发，开发某个模块，就copy出一份controller、service、serviceImpl、dao、daoImpl、model、jsp，然后改变类名。<br>项目内40%以上的代码都是模板性的，如果用手工copy、修改的方式来实现，就太烦人也没效率，而这时就是代码生成器小展身手的时候，<strong>使用代码生成器生成模板性的代码，减少手工操作的繁琐，集中精力在业务开发上，提升开发效率，代码生成器是一个很简单的东西，一点都不高深。</strong><br><a id="more"></a></p><h3 id="一、代码生成器能干什么？"><a href="#一、代码生成器能干什么？" class="headerlink" title="一、代码生成器能干什么？"></a>一、代码生成器能干什么？</h3><p>一个小型的业务项目（100张表以内），通常不需要很复杂的架构，一般就是通过单个或两个项目来实现。我们先来看下最基础的开发流程：</p><ol><li>了解需求（项目负责人）  </li><li>设计表结构（项目负责人）  </li><li>创建基础框架（项目负责人）  </li><li>制定开发计划，按模块分配任务（项目负责人）  </li><li>进行模块开发（程序员A、B、C）  </li><li>测试、上线</li></ol><p>程序员进行模块开发的方式有以下几种：  </p><ol><li>根据表结构设计，手工创建model，然后copy UserDao改名为CompanyDao，copy UserServiceImpl改名为CompanyServiceImpl，并修改引用的UserDao为CompanyDao等；  </li><li>根据表结构设计，使用工具生成model，后续步骤同1</li></ol><p>如果不细心，总是要修改个两三遍才能让一个模块有一个架子，然后再开始进行真正关心的业务开发，而这时候时间可能已经过去了一个小时，或许更久。</p><p>程序员在开发时应该“懒”一点，如果类似的代码多次出现，不要在copy了，提取为公共的方法；如果类似的copy、修改的操作重复的出现的一个项目、不同的项目里，那就写个代码生成器吧，一键完成你手工几十步的操作。</p><p><strong>代码生成器是用来生成有规律的代码的，就如controller、service、serviceImpl、dao、daoImpl、model、jsp的结构，用户、角色、权限等等模块都有类似的结构，代码生成器可以代替我们的copy操作，自动生成这些不同业务对象的模板代码。</strong></p><h3 id="二、代码生成器怎么实现？"><a href="#二、代码生成器怎么实现？" class="headerlink" title="二、代码生成器怎么实现？"></a>二、代码生成器怎么实现？</h3><p>代码生成器的实现由很多种，我们以从mysql数据库表结构生成对应代码为例来说明如何实现一个代码生成器。有以下几个重点：</p><ol><li>提前搭建好项目基础框架，因为生成的就是基础框架的模板代码</li><li>获取某个数据库内的表及表结构信息，用于生成model及其他代码</li><li>使用freemarker进行模板生成</li></ol><h4 id="1、提取基础框架"><a href="#1、提取基础框架" class="headerlink" title="1、提取基础框架"></a>1、提取基础框架</h4><p>如公司项目都是前后端分离的，那我就提取了一个<a href="https://github.com/q7322068/rest-base" target="_blank" rel="external">rest-base</a>项目作为基础框架，该框架满足绝大部分公司项目开发所需的基础功能</p><h4 id="2、获取数据库表结构"><a href="#2、获取数据库表结构" class="headerlink" title="2、获取数据库表结构"></a>2、获取数据库表结构</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line"> </div><div class="line">//获取所有库</div><div class="line"><span class="keyword">select</span> <span class="keyword">DISTINCT</span>(TABLE_SCHEMA) <span class="keyword">from</span> information_schema.<span class="string">`TABLES`</span>;</div><div class="line"></div><div class="line">//获取所有表</div><div class="line"><span class="keyword">SELECT</span> TABLE_NAME <span class="keyword">as</span> tableName,TABLE_COMMENT <span class="keyword">as</span> tableComment <span class="keyword">from</span> information_schema.<span class="string">`TABLES`</span> <span class="keyword">where</span> TABLE_SCHEMA=<span class="string">'test'</span>;</div><div class="line"></div><div class="line">//获取某个表的结构</div><div class="line"></div><div class="line"><span class="keyword">select</span> COLUMN_NAME <span class="keyword">as</span> columnName,COLUMN_TYPE <span class="keyword">as</span> columnType,COLUMN_DEFAULT <span class="keyword">as</span> columnDefault,COLUMN_COMMENT <span class="keyword">as</span> columnComment,CHARACTER_MAXIMUM_LENGTH <span class="keyword">as</span> columnCharacterMaximumLength <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema = <span class="string">'test'</span> <span class="keyword">and</span> table_name = <span class="string">'rule'</span>; </div><div class="line"></div></pre></td></tr></table></figure> <p>通过查询information_schema库内的TABLES、columns表，可以获取数据内的表、表字段属性等。然后就可以以此来确定model的内容，如表user_role对应的实体就是UserRole，表字段和实体属性可以根据类型和规则进行映射。</p><h3 id="3、freemarker生成模板代码"><a href="#3、freemarker生成模板代码" class="headerlink" title="3、freemarker生成模板代码"></a>3、freemarker生成模板代码</h3><p>先大致讲下思路：</p><ol><li>根据表明，按规则获取实体名称，从而也确认了dao、service等的类名；  </li><li>将表字段转为map结构，作为参数传入model对于的模板内，从而生成对应的model类；  </li><li>依次传入参数，通过模板生成dao、service等代码</li></ol><p>需要会一点freemarker的语法，基本上看个一小时就达到了写简单模板的程度了。</p><p><strong>接口：</strong><br><figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">public interface GeneratorHelperService &#123;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 设置公共参数，如</div><div class="line"> * projectPath 要生成代码的项目的路径：  D:/workspace/code-generator</div><div class="line"> * packagePath 要生成代码的项目的包的根路径：/src/main/java/com/hexun/bdc/generator</div><div class="line"> * templetePath 本项目内代码模板路径： /src/main/resources/code-templete</div><div class="line"> */</div><div class="line">boolean setProperty(Map&lt;String, String&gt; map);</div><div class="line"></div><div class="line">/**</div><div class="line"> * 生成某个库内所有表对应的代码</div><div class="line"> * @author yangwenkui</div><div class="line"> * @time 2017年10月29日 下午8:22:35</div><div class="line"> * @param dbname 数据库名称</div><div class="line"> * @return</div><div class="line"> */</div><div class="line">boolean allTables(String dbname);</div><div class="line"></div><div class="line">/**</div><div class="line"> * 生成某个库内某个表对应的代码</div><div class="line"> * @author yangwenkui</div><div class="line"> * @time 2017年10月29日 下午8:22:35</div><div class="line"> * @param dbname 数据库名称</div><div class="line"> * @param tableName 表名称</div><div class="line"> * @return</div><div class="line"> */</div><div class="line">boolean oneTable(String dbname, String tableName);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure><br><strong>实现：</strong><br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@Service(<span class="string">"generatorHelperService"</span>)</div><div class="line"><span class="keyword">public</span> class GeneratorHelperServiceImpl implements GeneratorHelperService &#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory</div><div class="line">.getLogger(GeneratorHelperServiceImpl.class);</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; propertyMap = Maps.newConcurrentMap();</div><div class="line"></div><div class="line">@Autowired</div><div class="line">GeneratorHelperDao generatorHelperDao;</div><div class="line"></div><div class="line">@Value(<span class="string">"$&#123;generator.project.path&#125;"</span>)</div><div class="line"><span class="keyword">private</span> <span class="keyword">String</span> localProjectPath;</div><div class="line"></div><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> setProperty(Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span>) &#123;</div><div class="line">propertyMap.putAll(<span class="built_in">map</span>);</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> allTables(<span class="keyword">String</span> dbname) &#123;</div><div class="line">List&lt;<span class="keyword">Object</span>&gt; tables = generatorHelperDao.listAllTable(dbname);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">Object</span> item : tables) &#123;</div><div class="line"><span class="keyword">Object</span>[] arr = (<span class="keyword">Object</span>[]) item;</div><div class="line">TableInfo tableInfo = <span class="keyword">new</span> TableInfo(arr);</div><div class="line"><span class="built_in">boolean</span> success = generateCode(dbname, tableInfo);</div><div class="line"><span class="keyword">if</span> (!success) &#123;</div><div class="line">logger.error(<span class="string">"generator code table=[&#123;&#125;] fail"</span>, item.toString());</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> oneTable(<span class="keyword">String</span> dbname, <span class="keyword">String</span> tableName) &#123;</div><div class="line"><span class="keyword">Object</span> entity = generatorHelperDao.findTableInfo(dbname, tableName);</div><div class="line"><span class="keyword">Object</span>[] arr = (<span class="keyword">Object</span>[]) entity;</div><div class="line">TableInfo tableInfo = <span class="keyword">new</span> TableInfo(arr);</div><div class="line"><span class="keyword">return</span> generateCode(dbname, tableInfo);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="built_in">boolean</span> generateCode(<span class="keyword">String</span> dbname, TableInfo item) &#123;</div><div class="line">List&lt;<span class="keyword">Object</span>&gt; list = generatorHelperDao.listColumInfos(dbname,</div><div class="line">item.getTabelName());</div><div class="line">List&lt;ColumnInfo&gt; columnInfos = <span class="keyword">new</span> ArrayList&lt;ColumnInfo&gt;(list.<span class="built_in">size</span>());</div><div class="line"><span class="keyword">String</span> idType = <span class="string">"String"</span>;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">Object</span> obj : list) &#123;</div><div class="line"><span class="keyword">Object</span>[] arr = (<span class="keyword">Object</span>[]) obj;</div><div class="line">ColumnInfo columnInfo = <span class="keyword">new</span> ColumnInfo(arr);</div><div class="line">columnInfos.<span class="built_in">add</span>(columnInfo);</div><div class="line"><span class="keyword">if</span>(<span class="string">"id"</span>.equals(arr[<span class="number">0</span>]))&#123;</div><div class="line"><span class="keyword">if</span>(<span class="string">"int"</span>.equals(columnInfo.getModelType()))&#123;</div><div class="line">idType = <span class="string">"Integer"</span>;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"long"</span>.equals(columnInfo.getModelType()))&#123;</div><div class="line">idType = <span class="string">"Long"</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">item.setIdType(idType);</div><div class="line">createModel(item, columnInfos);</div><div class="line">createOther(item,<span class="string">"dao"</span>);</div><div class="line">createOther(item,<span class="string">"service"</span>);</div><div class="line">createOther(item,<span class="string">"serviceImpl"</span>);</div><div class="line">createOther(item,<span class="string">"controller"</span>);</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> createModel(TableInfo item, List&lt;ColumnInfo&gt; columnInfos) &#123;</div><div class="line"><span class="keyword">String</span> path = getUpPath();</div><div class="line"><span class="keyword">String</span> dir = <span class="keyword">String</span>.format(<span class="string">"%s/domain"</span>,path);</div><div class="line">File file = <span class="keyword">new</span> File(dir);</div><div class="line"><span class="keyword">if</span>(!file.exists())&#123;</div><div class="line">file.mkdirs();</div><div class="line">&#125;</div><div class="line"><span class="keyword">String</span> templetePath = <span class="keyword">String</span>.format(<span class="string">"%s%s"</span>, localProjectPath,propertyMap.<span class="built_in">get</span>(<span class="string">"templetePath"</span>));</div><div class="line"><span class="keyword">String</span> filePath = <span class="keyword">String</span>.format(<span class="string">"%s/%s.java"</span>, dir,item.getModleName());</div><div class="line"></div><div class="line">Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; data = Maps.newHashMap();</div><div class="line">data.put(<span class="string">"proList"</span>, columnInfos);</div><div class="line">data.put(<span class="string">"modelParam"</span>, <span class="keyword">String</span>.format(<span class="string">"%s%s"</span>,item.getModleName().substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase(),item.getModleName().substring(<span class="number">1</span>)));</div><div class="line">data.put(<span class="string">"modellower"</span>, item.getModleName().toLowerCase());</div><div class="line">data.put(<span class="string">"tableInfo"</span>, item);</div><div class="line">data.put(<span class="string">"packagePath"</span>, Joiner.on(<span class="string">"."</span>).<span class="built_in">join</span>(propertyMap.<span class="built_in">get</span>(<span class="string">"packagePath"</span>).<span class="built_in">split</span>(<span class="string">"/"</span>)).substring(<span class="number">15</span>));</div><div class="line">createTempleteFile(filePath,templetePath,<span class="string">"domain.flt"</span>,data);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> createTempleteFile(<span class="keyword">String</span> filename, <span class="keyword">String</span> templetePath,<span class="keyword">String</span> templeteName,</div><div class="line">Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; data) &#123;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">Configuration cfg = <span class="keyword">new</span> Configuration();  </div><div class="line">cfg.setDirectoryForTemplateLoading(<span class="keyword">new</span> File(templetePath)); </div><div class="line">cfg.setObjectWrapper(<span class="keyword">new</span> DefaultObjectWrapper());  </div><div class="line">  </div><div class="line"><span class="comment">//设置字符集  </span></div><div class="line">cfg.setDefaultEncoding(<span class="string">"UTF-8"</span>);  </div><div class="line">  </div><div class="line"><span class="comment">//设置尖括号语法和方括号语法,默认是自动检测语法  </span></div><div class="line"><span class="comment">//  自动 AUTO_DETECT_TAG_SYNTAX  </span></div><div class="line"><span class="comment">//  尖括号 ANGLE_BRACKET_TAG_SYNTAX  </span></div><div class="line"><span class="comment">//  方括号 SQUARE_BRACKET_TAG_SYNTAX  </span></div><div class="line">cfg.setTagSyntax(Configuration.AUTO_DETECT_TAG_SYNTAX);  </div><div class="line">  </div><div class="line">Writer out = <span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(filename),<span class="string">"UTF-8"</span>);  </div><div class="line">Template temp = cfg.getTemplate(templeteName);  </div><div class="line">temp.process(data, out); </div><div class="line">out.flush();</div><div class="line">out.close();</div><div class="line">&#125;<span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">logger.error(<span class="string">"process due to erro"</span>,e);</div><div class="line">&#125;  </div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">String</span> getUpPath() &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">String</span>.format(<span class="string">"%s/%s"</span>, propertyMap.<span class="built_in">get</span>(<span class="string">"projectPath"</span>),</div><div class="line">propertyMap.<span class="built_in">get</span>(<span class="string">"packagePath"</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> createOther(TableInfo item,<span class="keyword">String</span> type) &#123;</div><div class="line"><span class="keyword">String</span> path = getUpPath();</div><div class="line"><span class="keyword">String</span> lastDir = type;</div><div class="line"><span class="keyword">if</span>(<span class="string">"serviceImpl"</span>.equals(type))&#123;</div><div class="line">lastDir = <span class="string">"service/impl"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">String</span> dir = <span class="keyword">String</span>.format(<span class="string">"%s/%s"</span>,path,lastDir);</div><div class="line">File file = <span class="keyword">new</span> File(dir);</div><div class="line"><span class="keyword">if</span>(!file.exists())&#123;</div><div class="line">file.mkdirs();</div><div class="line">&#125;</div><div class="line"><span class="keyword">String</span> templetePath = <span class="keyword">String</span>.format(<span class="string">"%s%s"</span>, localProjectPath,propertyMap.<span class="built_in">get</span>(<span class="string">"templetePath"</span>));</div><div class="line"><span class="keyword">String</span> filePath = <span class="keyword">String</span>.format(<span class="string">"%s/%s.java"</span>, dir,item.getModleName()+type.substring(<span class="number">0</span>,<span class="number">1</span>).toUpperCase()+type.substring(<span class="number">1</span>));</div><div class="line"></div><div class="line">Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; data = Maps.newHashMap();</div><div class="line">data.put(<span class="string">"modelParam"</span>, <span class="keyword">String</span>.format(<span class="string">"%s%s"</span>,item.getModleName().substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase(),item.getModleName().substring(<span class="number">1</span>)));</div><div class="line">data.put(<span class="string">"modellower"</span>, item.getModleName().toLowerCase());</div><div class="line">data.put(<span class="string">"item"</span>, item);</div><div class="line">data.put(<span class="string">"packagePath"</span>, Joiner.on(<span class="string">"."</span>).<span class="built_in">join</span>(propertyMap.<span class="built_in">get</span>(<span class="string">"packagePath"</span>).<span class="built_in">split</span>(<span class="string">"/"</span>)).substring(<span class="number">15</span>));</div><div class="line"></div><div class="line">createTempleteFile(filePath,templetePath,<span class="keyword">String</span>.format(<span class="string">"%s.flt"</span>, type),data);</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure><br><strong>model模板（domain.flt）：</strong><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> $&#123;packagePath&#125;.domain;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</div><div class="line"><span class="keyword">import</span> javax.persistence.Column;</div><div class="line"><span class="keyword">import</span> javax.persistence.Entity;</div><div class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</div><div class="line"><span class="keyword">import</span> javax.persistence.GenerationType;</div><div class="line"><span class="keyword">import</span> javax.persistence.Id;</div><div class="line"><span class="keyword">import</span> javax.persistence.Table;</div><div class="line"><span class="keyword">import</span> java.sql.Timestamp;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * $&#123;tableInfo.tableComment&#125;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Entity</span></div><div class="line"><span class="meta">@Table(name = <span class="meta-string">"<span class="subst">$&#123;tableInfo.tabelName&#125;</span>"</span>)</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span>  $</span>&#123;tableInfo.modleName&#125; &#123;</div><div class="line"></div><div class="line">&lt;#list proList <span class="keyword">as</span> item&gt;</div><div class="line">&lt;#<span class="keyword">if</span> item.modelName == <span class="string">"id"</span>&gt;</div><div class="line"></div><div class="line"><span class="meta">@ApiModelProperty(value=<span class="meta-string">"主键"</span>)</span></div><div class="line"><span class="meta">@Id</span></div><div class="line">&lt;#<span class="keyword">if</span> item.modelType == <span class="string">"int"</span>&gt;</div><div class="line"><span class="meta">@GeneratedValue(strategy=GenerationType.AUTO)</span></div><div class="line"><span class="keyword">private</span> Integer id;</div><div class="line"></div><div class="line">&lt;/#<span class="keyword">if</span>&gt;</div><div class="line">&lt;#<span class="keyword">if</span> item.modelType == <span class="string">"long"</span>&gt;</div><div class="line"><span class="meta">@GeneratedValue(strategy=GenerationType.AUTO)</span></div><div class="line"><span class="keyword">private</span> <span class="built_in">Long</span> id;</div><div class="line"></div><div class="line">&lt;/#<span class="keyword">if</span>&gt;</div><div class="line">&lt;#<span class="keyword">if</span> item.modelType == <span class="string">"String"</span>&gt;</div><div class="line"><span class="meta">@GeneratedValue(generator=<span class="meta-string">"system-uuid"</span>)</span></div><div class="line"><span class="meta">@GenericGenerator(name=<span class="meta-string">"system-uuid"</span>,strategy=<span class="meta-string">"uuid"</span>)</span></div><div class="line"><span class="meta">@Column(length=$&#123;item.modelCharacterMaximumLength&#125;)</span></div><div class="line"><span class="keyword">private</span> String id;<span class="comment">//主键</span></div><div class="line"></div><div class="line">&lt;/#<span class="keyword">if</span>&gt;</div><div class="line">&lt;#<span class="keyword">else</span>&gt;</div><div class="line"><span class="meta">@ApiModelProperty(value=<span class="meta-string">"<span class="subst">$&#123;item.modelComment&#125;</span>"</span>)</span> </div><div class="line"><span class="meta">@Column(name=<span class="meta-string">"<span class="subst">$&#123;item.columnName&#125;</span>"</span>&lt;#if (item.modelCharacterMaximumLength?exists &amp;&amp; item.modelType == <span class="meta-string">"String"</span> &amp;&amp; item.modelCharacterMaximumLength?number&lt;=255)</span>&gt;,length=$&#123;item.modelCharacterMaximumLength&#125;&lt;/#<span class="keyword">if</span>&gt;&lt;#<span class="keyword">if</span> item.modelDefault?exists &amp;&amp; item.modelDefault != <span class="string">""</span>&gt;,columnDefinition=<span class="string">"<span class="subst">$&#123;item.modelDefault&#125;</span>"</span>&lt;/#<span class="keyword">if</span>&gt;)</div><div class="line"><span class="keyword">private</span> $&#123;item.modelType&#125; $&#123;item.modelName&#125;;</div><div class="line"></div><div class="line">&lt;/#<span class="keyword">if</span>&gt;</div><div class="line">&lt;/#list&gt;</div><div class="line">&lt;#list proList <span class="keyword">as</span> item&gt;</div><div class="line">   <span class="keyword">public</span> $&#123;item.modelType&#125; <span class="keyword">get</span>$&#123;item.modelNameFirstUpper&#125;() &#123;</div><div class="line"><span class="keyword">return</span> $&#123;item.modelName&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> void <span class="keyword">set</span>$&#123;item.modelNameFirstUpper&#125;($&#123;item.modelType&#125; $&#123;item.modelName&#125;) &#123;</div><div class="line"><span class="keyword">this</span>.$&#123;item.modelName&#125; = $&#123;item.modelName&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&lt;/#list&gt;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> String toString() &#123;</div><div class="line"><span class="keyword">return</span> String.format(<span class="string">"<span class="subst">$&#123;tableInfo.modleName&#125;</span> [&lt;#list proList as item&gt;, <span class="subst">$&#123;item.modelName&#125;</span>=%s&lt;/#list&gt;]"</span></div><div class="line">  &lt;#list proList <span class="keyword">as</span> item&gt;, $&#123;item.modelName&#125;&lt;/#list&gt;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure><br><strong>dao模板（dao.flt）：</strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">package <span class="variable">$&#123;packagePath&#125;</span>.dao;</div><div class="line"></div><div class="line">import com.hexun.bdc.base.component.common.BaseDao;</div><div class="line">import <span class="variable">$&#123;packagePath&#125;</span>.domain.<span class="variable">$&#123;item.modleName&#125;</span>;</div><div class="line"></div><div class="line">public<span class="built_in"> interface </span><span class="variable">$&#123;item.modleName&#125;</span>Dao extends BaseDao&lt;<span class="variable">$&#123;item.modleName&#125;</span>, <span class="variable">$&#123;item.idType&#125;</span>&gt;&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure><br>代码逻辑不复杂，service提供了三个接口，setProperty用于设置要生成的代码的路径及包名等，allTables用于初次生成，一次生成一个库内所有表对应的代码；oneTable用于生成指定表对应的代码，注意代码开发一段时间后，不要在上传至svn之前给覆盖了。<br>完整代码在<a href="https://github.com/q7322068/code-generation" target="_blank" rel="external">code-generation</a>，在此基础上，你可以很快修改出适合你公司的代码生成器！</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul><li>提取一个基础框架吧，不要再copy项目，删除不用的类，改来改去，复制来复制去了</li><li>不要再花半个小时甚至更多时间在模板代码的copy修改上了，写个代码生成器，10s搞定</li></ul><p>最后再插嘴一句，项目负责人要有意识的提高团队的开发效率，代码生成器是一个比较好的提示，希望能让你由此想到更多！  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在规模较小的公司里，大部分的项目规模不是特别大，技术实现难度不是很高，关注点更多是在业务功能的开发及保证业务流程的正确性上。当有一个新的项目来时，通常会找一个项目进行copy，删除不用的包和类，然后以此为基础，进行后续的开发，开发某个模块，就copy出一份controller、service、serviceImpl、dao、daoImpl、model、jsp，然后改变类名。&lt;br&gt;项目内40%以上的代码都是模板性的，如果用手工copy、修改的方式来实现，就太烦人也没效率，而这时就是代码生成器小展身手的时候，&lt;strong&gt;使用代码生成器生成模板性的代码，减少手工操作的繁琐，集中精力在业务开发上，提升开发效率，代码生成器是一个很简单的东西，一点都不高深。&lt;/strong&gt;&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="代码生成器" scheme="http://www.onecoderspace.com/tags/%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>spring boot项目实战之工具篇（ognl）</title>
    <link href="http://www.onecoderspace.com/2017/10/07/spring-boot-util-ognl/"/>
    <id>http://www.onecoderspace.com/2017/10/07/spring-boot-util-ognl/</id>
    <published>2017-10-07T11:43:10.000Z</published>
    <updated>2017-10-07T12:54:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>当解析复杂的json结构时，ognl是一个很方便的工具，实现基于图对属性的访问，类似于以(user.name | user.depart[0])的方式获取json内的嵌套对象字段值。<br><a id="more"></a></p><p>请看以下示例，你将对ognl的作用有一个更清晰的理解：<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">String</span> json = <span class="string">"&#123;\"</span>user\<span class="string">":&#123;\"</span>name\<span class="string">":\"</span><span class="number">123</span>\<span class="string">",\"</span>depart\<span class="string">":[1,2]&#125;&#125;"</span>;</div><div class="line">Map&lt;?, ?&gt; map = JacksonHelper.fromJson(json, Map.<span class="keyword">class</span>);</div><div class="line">OgnlWrapper ognlWrapper = <span class="keyword">new</span> OgnlWrapper(map);</div><div class="line">System.<span class="built_in">err</span>.println(ognlWrapper.<span class="keyword">get</span>(<span class="string">"user.name"</span>));</div><div class="line">System.<span class="built_in">err</span>.println(ognlWrapper.<span class="keyword">get</span>(<span class="string">"user.depart.size"</span>));</div><div class="line">System.<span class="built_in">err</span>.println(ognlWrapper.<span class="keyword">get</span>(<span class="string">"user.depart[0]"</span>));</div><div class="line"></div></pre></td></tr></table></figure></p><ul><li>内部对象的普通字段可以通过user.name这样的方式获取</li><li>内部对象的集合字段可以通过user.depart.size获取其集合长度</li><li>内部对象的集合字段可以通过user.depart[0]的方式获取对应下标出的值</li></ul><p>通常json对象解析可以通过一层一层的转换为map来实现，但如果嵌套对象层次有3层以上，内部结构较复杂，那实现起来就很繁琐，代码冗长，这种情况下使用ognl能让代码精简很多。</p><h3 id="1、添加maven依赖"><a href="#1、添加maven依赖" class="headerlink" title="1、添加maven依赖"></a>1、添加maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">&lt;!-- ognl --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ognl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ognl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="2、OgnlWrapper"><a href="#2、OgnlWrapper" class="headerlink" title="2、OgnlWrapper"></a>2、OgnlWrapper</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@SuppressWarnings(<span class="string">"unchecked"</span>)</div><div class="line"><span class="keyword">public</span> class OgnlWrapper &#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(OgnlWrapper.class);</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</div><div class="line"><span class="keyword">private</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; payload;</div><div class="line"></div><div class="line"><span class="keyword">public</span> OgnlWrapper(Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; playload) &#123;</div><div class="line">Validate.notEmpty(playload, <span class="string">"can not construct with none playload!"</span>);</div><div class="line"><span class="keyword">this</span>.payload = playload;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> OgnlWrapper(<span class="keyword">Object</span> playload) &#123;</div><div class="line"><span class="keyword">this</span>.payload = om.convertValue(playload, Map.class);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="built_in">get</span>(<span class="keyword">String</span> expression) &#123;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">return</span> (T) Ognl.getValue(expression, <span class="keyword">this</span>.payload);</div><div class="line">&#125; <span class="keyword">catch</span> (OgnlException e) &#123;</div><div class="line">logger.trace(<span class="keyword">String</span>.format(<span class="string">"get value with expression:[%s] due to error, return null instead of"</span>,</div><div class="line">expression), e);</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> Long getLong(<span class="keyword">String</span> expression) &#123;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">Object</span> obj = Ognl.getValue(expression, <span class="keyword">this</span>.payload);</div><div class="line"><span class="keyword">if</span> (<span class="keyword">null</span> == obj)</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">return</span> Long.parseLong(obj.toString());</div><div class="line">&#125; <span class="keyword">catch</span> (NumberFormatException nfe) &#123;</div><div class="line">logger.warn(<span class="keyword">String</span>.format(<span class="string">"get value with expression:[%s] due to error, return null. value[%s] cannot be cast to java.lang.Long"</span>,</div><div class="line">expression,</div><div class="line">obj.toString()));</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line">&#125; <span class="keyword">catch</span> (OgnlException e) &#123;</div><div class="line">logger.trace(<span class="keyword">String</span>.format(<span class="string">"get value with expression:[%s] due to error, return null instead of"</span>,</div><div class="line">expression), e);</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> Integer getInt(<span class="keyword">String</span> expression) &#123;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">Object</span> obj = Ognl.getValue(expression, <span class="keyword">this</span>.payload);</div><div class="line"><span class="keyword">if</span> (<span class="keyword">null</span> == obj)</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">return</span> Integer.parseInt(obj.toString());</div><div class="line">&#125; <span class="keyword">catch</span> (NumberFormatException nfe) &#123;</div><div class="line">logger.warn(<span class="keyword">String</span>.format(<span class="string">"get value with expression:[%s] due to error, return null. value[%s] cannot be cast to java.lang.Integer"</span>,</div><div class="line">expression,</div><div class="line">obj.toString()));</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line">&#125; <span class="keyword">catch</span> (OgnlException e) &#123;</div><div class="line">logger.trace(<span class="keyword">String</span>.format(<span class="string">"get value with expression:[%s] due to error, return null instead of"</span>,</div><div class="line">expression), e);</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="keyword">String</span> toString() &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">String</span>.format(<span class="string">"OgnlWrapper[%s]"</span>, <span class="keyword">this</span>.payload.toString());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</div><div class="line"><span class="keyword">String</span> json = <span class="string">"&#123;\"user\":&#123;\"name\":\"123\",\"depart\":[1,2]&#125;&#125;"</span>;</div><div class="line">Map&lt;?, ?&gt; <span class="built_in">map</span> = JacksonHelper.fromJson(json, Map.class);</div><div class="line">OgnlWrapper ognlWrapper = <span class="keyword">new</span> OgnlWrapper(<span class="built_in">map</span>);</div><div class="line">System.err.<span class="built_in">println</span>(ognlWrapper.<span class="built_in">get</span>(<span class="string">"user.name"</span>));</div><div class="line">System.err.<span class="built_in">println</span>(ognlWrapper.<span class="built_in">get</span>(<span class="string">"user.depart.size"</span>));</div><div class="line">System.err.<span class="built_in">println</span>(ognlWrapper.<span class="built_in">get</span>(<span class="string">"user.depart[0]"</span>));</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3、使用手册"><a href="#3、使用手册" class="headerlink" title="3、使用手册"></a>3、使用手册</h3><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>OgnlWrapper是基于ognl.Ognl类的一个工具类，实现基于图对属性的访问，支持ognl的所有语法。 提供三个核心方法:<br>get();<br>getLong(); //如果值非long型，将返回null<br>getInt(); //如果值非int型，将返回null</p><h4 id="使用注意"><a href="#使用注意" class="headerlink" title="使用注意"></a>使用注意</h4><p>在使用Long longvalue = ognlWrapper.get(“body.payload.page.page_size”); 时出现如下错误: java.lang.ClassCastException: java.lang.Long cannot be cast to java.lang.Integer<br>解决方法:使用getLong方法<br>Long longvalue = ognlWrapper.getLong(“body.payload.page.page_size”);</p><p>获取不存在的属性时返回null，日志中会打印warn警告日志。 如:ognlWrapper.getLong(“body.payload[0].childrens[0].childrens.size”); // return null</p><h4 id="单个对象"><a href="#单个对象" class="headerlink" title="单个对象"></a>单个对象</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">User user = <span class="keyword">new</span> <span class="type">User</span>(); <span class="comment">//设置用户的相关属性</span></div><div class="line"><span class="comment">//...省略属性设置</span></div><div class="line"><span class="comment">//使用OgnlWrapper</span></div><div class="line">OgnlWrapper ognlWrapper = <span class="keyword">new</span> <span class="type">OgnlWrapper</span>(user);</div><div class="line"><span class="keyword">String</span> id = ognlWrapper.<span class="keyword">get</span>(<span class="string">"id"</span>);<span class="comment">//获取id</span></div><div class="line"></div><div class="line"><span class="comment">//状态. 请使用基本数据类型的封装类型</span></div><div class="line">Integer status = ognlWrapper.getInt(<span class="string">"status"</span>);</div><div class="line"><span class="comment">//联系信息中的邮件地址</span></div><div class="line"><span class="keyword">String</span> email = ognlWrapper.<span class="keyword">get</span>(<span class="string">"contact_info.email"</span>);</div><div class="line"></div><div class="line"><span class="comment">//获取一个不存在的属性</span></div><div class="line"><span class="comment">//将返回null</span></div><div class="line"><span class="keyword">String</span> noexist = ognlWrapper.<span class="keyword">get</span>(<span class="string">"noexist"</span>);</div><div class="line"> </div><div class="line"><span class="comment">//将返回null</span></div><div class="line">noexist = ognlWrapper.<span class="keyword">get</span>(<span class="string">"contact_info.noexist"</span>);</div></pre></td></tr></table></figure><h4 id="对list操作"><a href="#对list操作" class="headerlink" title="对list操作"></a>对list操作</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//将存放用户的列表数据放到map中 map.put("users",list);</span></div><div class="line"><span class="comment">//使用OgnlWrapper获取用户列表数据</span></div><div class="line">OgnlWrapper ognlWrapper = <span class="keyword">new</span> OgnlWrapper(<span class="built_in">map</span>);</div><div class="line"></div><div class="line"><span class="comment">//获取list大小。如果map未存放list则返回null</span></div><div class="line">Integer <span class="built_in">size</span> = ognlWrapper.getInt(<span class="string">"users.size"</span>); </div><div class="line"><span class="keyword">if</span>(<span class="keyword">null</span> == <span class="built_in">size</span> || <span class="number">0</span> == <span class="built_in">size</span>.intValue())  <span class="keyword">return</span> ;</div><div class="line"></div><div class="line"><span class="comment">//获取list中第一用户的用户id和name 注意:下标从0开始</span></div><div class="line"><span class="keyword">String</span> id = ognlWrapper.<span class="built_in">get</span>(<span class="string">"users[0].id"</span>);</div><div class="line"><span class="keyword">String</span> name = ognlWrapper.<span class="built_in">get</span>(<span class="string">"users[0].name"</span>);</div><div class="line"></div><div class="line"><span class="comment">//如果索引超出list的大小，将返回null</span></div><div class="line"><span class="keyword">String</span> nullvalue = ognlWrapper.<span class="built_in">get</span>(<span class="string">"users[9999999].id"</span>);</div></pre></td></tr></table></figure><p><strong>使用OgnlWrapper获取属性值时，请使用对象类型。如int 使用Integer类型。</strong></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;当解析复杂的json结构时，ognl是一个很方便的工具，实现基于图对属性的访问，类似于以(user.name | user.depart[0])的方式获取json内的嵌套对象字段值。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="ognl" scheme="http://www.onecoderspace.com/tags/ognl/"/>
    
  </entry>
  
  <entry>
    <title>spring boot项目实战-json</title>
    <link href="http://www.onecoderspace.com/2017/10/07/spring-boot-json-util/"/>
    <id>http://www.onecoderspace.com/2017/10/07/spring-boot-json-util/</id>
    <published>2017-10-07T10:49:45.000Z</published>
    <updated>2017-10-07T11:23:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>对象转json、json转对象是我们开发过程中经常遇到的，提取一套高效、易用的工具类会让开发过程舒爽不少，下面提供一个基于jackson包的常用json工具方法。<br><a id="more"></a></p><h3 id="1、添加maven依赖"><a href="#1、添加maven依赖" class="headerlink" title="1、添加maven依赖"></a>1、添加maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.jackson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-mapper-asl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="2、对象转为json"><a href="#2、对象转为json" class="headerlink" title="2、对象转为json"></a>2、对象转为json</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 将对象转化为json</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年3月16日 下午2:55:10</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> obj 待转化的对象</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> 当转化发生异常时返回null</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">String <span class="title">toJson</span><span class="params">(Object obj)</span></span>&#123;</div><div class="line"><span class="keyword">if</span>(obj == <span class="keyword">null</span>)&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="function"><span class="keyword">return</span> mapper.<span class="title">writeValueAsString</span><span class="params">(obj)</span></span>;</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">logger.<span class="keyword">error</span>(String.format(<span class="string">"obj=[%s]"</span>, obj.toString()), e);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3、json转为对象"><a href="#3、json转为对象" class="headerlink" title="3、json转为对象"></a>3、json转为对象</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 将json转化为对象</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年3月16日 下午2:56:26</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> json json对象</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> clazz 待转化的对象类型</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> 当转化发生异常时返回null</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(String json,Class&lt;T&gt; clazz)</span></span>&#123;</div><div class="line"><span class="keyword">if</span>(json == <span class="keyword">null</span>)&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="function"><span class="keyword">return</span> mapper.<span class="title">readValue</span><span class="params">(json, clazz)</span></span>;</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">logger.<span class="keyword">error</span>(String.format(<span class="string">"json=[%s]"</span>, json), e);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="4、json转为集合对象"><a href="#4、json转为集合对象" class="headerlink" title="4、json转为集合对象"></a>4、json转为集合对象</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 将json对象转化为集合类型</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年3月16日 下午2:57:15</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> json json对象</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> collectionClazz 具体的集合类的class，如：ArrayList.class</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> clazz 集合内存放的对象的class</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line">@SuppressWarnings(<span class="string">"rawtypes"</span>)</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Collection&lt;T&gt; fromJson(String json,<span class="class"><span class="keyword">Class</span>&lt;? <span class="keyword">extends</span> <span class="title">Collection</span>&gt; <span class="title">collectionClazz</span>,<span class="title">Class</span>&lt;<span class="title">T</span>&gt; <span class="title">clazz</span>)</span>&#123;</div><div class="line"><span class="keyword">if</span>(json == <span class="keyword">null</span>)&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">Collection&lt;T&gt; collection =  mapper.readValue(json, getCollectionType(collectionClazz,clazz));</div><div class="line"><span class="keyword">return</span> collection;</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">logger.error(String.format(<span class="string">"json=[%s]"</span>, json), e);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> JavaType getCollectionType(<span class="class"><span class="keyword">Class</span>&lt;?&gt; <span class="title">collectionClass</span>, <span class="title">Class</span>&lt;?&gt;... <span class="title">elementClasses</span>) </span>&#123;   </div><div class="line"><span class="keyword">return</span> mapper.getTypeFactory().constructParametricType(collectionClass, elementClasses);   </div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ol><li>常用的JSON技术有，json-lib、Jackson、Gson、FastJson，在易用性、性能等方面Jackson都表现不错，推荐使用Jackson包；</li><li>将对象对象存入缓存、从缓存内取出字符串转为对象、REST API接口返回结果转为对象等诸多场景下都有对象和json之间的转换操作，<strong>“见到经常出现的重复代码，提取出来作为通用方法是一个好的习惯”。</strong></li></ol><p>完整代码请参考github内rest-base项目com.onecoderspace.base.util.JacksonHelper。<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对象转json、json转对象是我们开发过程中经常遇到的，提取一套高效、易用的工具类会让开发过程舒爽不少，下面提供一个基于jackson包的常用json工具方法。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="json" scheme="http://www.onecoderspace.com/tags/json/"/>
    
  </entry>
  
  <entry>
    <title>spring boot实战之集合操作</title>
    <link href="http://www.onecoderspace.com/2017/10/07/spring-boot-collection-util/"/>
    <id>http://www.onecoderspace.com/2017/10/07/spring-boot-collection-util/</id>
    <published>2017-10-07T01:14:19.000Z</published>
    <updated>2017-10-07T08:47:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>集合操作在web应用开发中也是很常见的，目前也有一些比较方便的工具如java.util.Collections、org.apache.commons.collections.CollectionUtils等，但是根据自己公司项目开发中的具体情况提取一套更何用的集合操作工具类也是很有帮助的。<br><a id="more"></a></p><h3 id="1、获取在集合A而不在集合B内的元素（差集）"><a href="#1、获取在集合A而不在集合B内的元素（差集）" class="headerlink" title="1、获取在集合A而不在集合B内的元素（差集）"></a>1、获取在集合A而不在集合B内的元素（差集）</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取在first集合内而不在second集合内的元素</span></div><div class="line"><span class="comment"> * @param first</span></div><div class="line"><span class="comment"> * @param second</span></div><div class="line"><span class="comment"> * @return</span></div><div class="line"><span class="comment"> */</span></div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="keyword">String</span>&gt; getDiffList(Collection&lt;<span class="keyword">String</span>&gt; first, Collection&lt;<span class="keyword">String</span>&gt; <span class="built_in">second</span>) &#123;  </div><div class="line">    <span class="keyword">long</span> t = System.currentTimeMillis();</div><div class="line">    Set&lt;<span class="keyword">String</span>&gt; sameString = <span class="keyword">new</span> HashSet&lt;<span class="keyword">String</span>&gt;(<span class="built_in">second</span>);</div><div class="line">       List&lt;<span class="keyword">String</span>&gt; result = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">String</span>&gt;(first.<span class="built_in">size</span>());  </div><div class="line">       <span class="keyword">for</span> (<span class="keyword">String</span> s : first) &#123; </div><div class="line">           <span class="keyword">if</span> (!sameString.contains(s)) &#123;  </div><div class="line">               result.<span class="built_in">add</span>(s);  </div><div class="line">           &#125;  </div><div class="line">       &#125;  </div><div class="line">       <span class="keyword">if</span>(System.currentTimeMillis() - t &gt; <span class="number">1</span>)&#123;</div><div class="line">       logger.debug(<span class="string">"getDiffList with list first.size=&#123;&#125;,sencond.size=&#123;&#125;,use time=&#123;&#125;ms"</span>,first.<span class="built_in">size</span>(),<span class="built_in">second</span>.<span class="built_in">size</span>(),System.currentTimeMillis()-t);</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       <span class="keyword">return</span> result;  </div><div class="line">   &#125;</div></pre></td></tr></table></figure><ul><li>比较重要的点是将second集合转换为set，因为set判断是否包含一个元素时间复杂度是O(1)</li></ul><h3 id="2、获得在集合A内同时在集合B内的元素（交集）"><a href="#2、获得在集合A内同时在集合B内的元素（交集）" class="headerlink" title="2、获得在集合A内同时在集合B内的元素（交集）"></a>2、获得在集合A内同时在集合B内的元素（交集）</h3><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * 获得在list内同时在list2内的元素</span></div><div class="line"><span class="comment">    * 注意：在结果集内并不去重，如果list内本身有重复，返回的结果内可能包含相同元素</span></div><div class="line"><span class="comment">    * @param list</span></div><div class="line"><span class="comment">    * @param list2</span></div><div class="line"><span class="comment">    * @return</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">public</span> static <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; getSameElements(Collection&lt;<span class="built_in">String</span>&gt; <span class="built_in">list</span>, Collection&lt;<span class="built_in">String</span>&gt; list2) &#123;</div><div class="line">    long t = System.nanoTime();</div><div class="line">    <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; <span class="built_in">set</span> = <span class="literal">new</span> HashSet&lt;<span class="built_in">String</span>&gt;(list2);</div><div class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; sameElements = <span class="literal">new</span> ArrayList&lt;<span class="built_in">String</span>&gt;(<span class="built_in">list</span>.size());  </div><div class="line">for(<span class="built_in">String</span> item : <span class="built_in">list</span>)&#123;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">set</span>.contains(item))&#123;</div><div class="line">sameElements.add(item);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(logger.isDebugEnabled())&#123;</div><div class="line">logger.debug(<span class="string">"getSameElements list.size=&#123;&#125;,list2.size=&#123;&#125;,use time=&#123;&#125;ns"</span>,<span class="built_in">list</span>.size(),list2.size(),System.nanoTime()<span class="params">-t</span>);</div><div class="line">       &#125;</div><div class="line"><span class="keyword">return</span> sameElements;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="3、将字符串转成list"><a href="#3、将字符串转成list" class="headerlink" title="3、将字符串转成list"></a>3、将字符串转成list</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 辅助方法，将字符串分割转换为list</span></div><div class="line"><span class="comment"> * @author yangwenkui</span></div><div class="line"><span class="comment"> * @time 2017年1月10日 下午4:22:20</span></div><div class="line"><span class="comment"> * @param provinceIds</span></div><div class="line"><span class="comment"> * @return</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="keyword">String</span>&gt; stringToList(<span class="keyword">String</span> <span class="built_in">str</span>,<span class="keyword">String</span> <span class="built_in">split</span>) &#123;</div><div class="line"><span class="keyword">if</span>(StringUtils.isBlank(<span class="built_in">str</span>))&#123;</div><div class="line"><span class="keyword">return</span> Lists.newArrayList();</div><div class="line">&#125;</div><div class="line"><span class="keyword">String</span>[] arr = <span class="built_in">str</span>.<span class="built_in">split</span>(<span class="built_in">split</span>);</div><div class="line">List&lt;<span class="keyword">String</span>&gt; list = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">String</span>&gt;(arr.length);</div><div class="line"><span class="keyword">for</span>(<span class="keyword">String</span> item : arr)&#123;</div><div class="line"><span class="keyword">if</span>(StringUtils.isNotBlank(item))&#123;</div><div class="line">list.<span class="built_in">add</span>(item);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> list;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>经常会有将id等用逗号连接存储或传输，然后转成集合进行操作的场景</li></ul><h3 id="4、获取集合内每个实体的id"><a href="#4、获取集合内每个实体的id" class="headerlink" title="4、获取集合内每个实体的id"></a>4、获取集合内每个实体的id</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"><span class="markdown">/**</span></span></div><div class="line"><span class="comment"><span class="markdown"> * 获取集合内每个实体的id</span></span></div><div class="line"><span class="comment"><span class="markdown"> */</span></span></div><div class="line">public <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> Serializable&gt; <span class="built_in">List</span>&lt;T&gt; getEntityIds(Collection&lt;? <span class="keyword">extends</span> BaseModel&lt;T&gt;&gt; items) &#123;</div><div class="line"><span class="built_in">List</span>&lt;T&gt; ids = Lists.newArrayList();</div><div class="line"><span class="keyword">if</span>(CollectionUtils.isEmpty(items))&#123;</div><div class="line"><span class="keyword">return</span> ids;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span>(BaseModel&lt;T&gt; entity : items)&#123;</div><div class="line">T id = entity.getId();</div><div class="line"><span class="keyword">if</span>(!ids.contains(id))&#123;</div><div class="line">ids.add(id);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> ids;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>BaseModel是一个接口，定义了一个getId()方法</li></ul><h3 id="5、根据id列表找到集合内对应的实体"><a href="#5、根据id列表找到集合内对应的实体" class="headerlink" title="5、根据id列表找到集合内对应的实体"></a>5、根据id列表找到集合内对应的实体</h3><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 根据id列表找到集合内对应的实体</span></div><div class="line"><span class="comment"> * @return</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends BaseModel&lt;<span class="keyword">String</span>&gt;&gt; List&lt;T&gt; select(Collection&lt;T&gt; list,Collection&lt;<span class="keyword">String</span>&gt; selects)&#123;</div><div class="line"><span class="keyword">if</span>(CollectionUtils.isEmpty(list) || CollectionUtils.isEmpty(selects))&#123;</div><div class="line"><span class="keyword">return</span> Lists.<span class="keyword">new</span><span class="type">ArrayList</span>();</div><div class="line">&#125;</div><div class="line">List&lt;T&gt; selectList = Lists.<span class="keyword">new</span><span class="type">ArrayList</span>();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">String</span> id : <span class="type">selects</span>) &#123;</div><div class="line"><span class="keyword">for</span>(T entity : <span class="type">list</span>)&#123;</div><div class="line"><span class="keyword">if</span>(id.equals(entity.getId()))&#123;</div><div class="line">selectList.add(entity);</div><div class="line"><span class="keyword">break</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> selectList;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul><li>求集合的交集、差集注意查找实现的时间复杂度，list查找时间复杂度是O(n)，HashSet查找时间复杂度是O(1)，建议使用HashSet。测试发现效率差了5倍以上（集合A（1500元素）、集合B（500元素））；   </li><li>将集合转为字符串可以使用com.google.common.base.Joiner.on(“,”).join(list)实现，将字符串转为list可以使用上文内的方法；</li><li>类似于获取集合内每个元素的id（getEntityIds）、根据id列表找到集合内对应的实体（select）这样和业务比较紧密的方法应该也会经常出现，大家可以根据自身项目情况，将这些模板类的代码提取出来作为公共工具包。</li></ul><p>完整内容请参考github内rest-base项目内代码。<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;集合操作在web应用开发中也是很常见的，目前也有一些比较方便的工具如java.util.Collections、org.apache.commons.collections.CollectionUtils等，但是根据自己公司项目开发中的具体情况提取一套更何用的集合操作工具类也是很有帮助的。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="集合" scheme="http://www.onecoderspace.com/tags/%E9%9B%86%E5%90%88/"/>
    
      <category term="工具类" scheme="http://www.onecoderspace.com/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"/>
    
  </entry>
  
  <entry>
    <title>spring boot实战之日期处理</title>
    <link href="http://www.onecoderspace.com/2017/10/06/spring-boot-utils/"/>
    <id>http://www.onecoderspace.com/2017/10/06/spring-boot-utils/</id>
    <published>2017-10-06T09:47:29.000Z</published>
    <updated>2017-10-06T11:56:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>web开发中经常需要对日期进行操作，如字符串日期转long，long型转字符串，日期计算等，提取一个日期处理工具类，提供常见的日期操作可以让开发更轻松一些。<br><a id="more"></a></p><h3 id="毫秒（long）转字符串日期"><a href="#毫秒（long）转字符串日期" class="headerlink" title="毫秒（long）转字符串日期"></a>毫秒（long）转字符串日期</h3><p>对long型时间进行格式化在web开发中是很经常出现的一个操作，这里主要使用joda-time包内的DateTime来实现，joda-time是时间操作很好的一个工具包。<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String DATE_FORMAT_DEFAULT = <span class="string">"yyyy-MM-dd"</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 将毫秒时间转换为yyyy-MM-dd格式的时间</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年10月6日 下午5:56:40</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> time 毫秒数</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> String longToString(<span class="keyword">long</span> time) &#123;</div><div class="line"><span class="keyword">return</span> longToString(time, DATE_FORMAT_DEFAULT);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 将毫秒时间转换为指定格式的时间</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年10月6日 下午5:56:40</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> time 毫秒数</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> format 日期格式</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> String longToString(<span class="keyword">long</span> time, String format) &#123;</div><div class="line"><span class="keyword">if</span> (StringUtils.isBlank(format)) &#123;</div><div class="line">format = DATE_FORMAT_DEFAULT;</div><div class="line">&#125;</div><div class="line">DateTime dTime = <span class="keyword">new</span> DateTime(time);</div><div class="line"><span class="keyword">return</span> dTime.toString(format);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//添加maven依赖</span></div><div class="line">&lt;dependency&gt;</div><div class="line">&lt;groupId&gt;joda-time&lt;/groupId&gt;</div><div class="line">&lt;artifactId&gt;joda-time&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p><h3 id="字符串日期转毫秒（long"><a href="#字符串日期转毫秒（long" class="headerlink" title="字符串日期转毫秒（long)"></a>字符串日期转毫秒（long)</h3><p>字符串日期转为毫秒值也是web开发内经常出现的一个场景，这里主要根据字符串的长度来判断其格式，进而截取字符串获取年、月、日等，再将这些值设置入calender内对应的属性上获取最终的时间。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 将字符串类型的日期转换为毫秒数</span></div><div class="line"><span class="comment"> * @author yangwenkui</span></div><div class="line"><span class="comment"> * @time 2017年10月6日 下午6:00:27</span></div><div class="line"><span class="comment"> * @param dateStr</span></div><div class="line"><span class="comment"> * @return</span></div><div class="line"><span class="comment"> */</span></div><div class="line">public static long parseStringToLong(String dateStr) &#123;</div><div class="line">dateStr = dateStr.trim();</div><div class="line">if (dateStr.length() == <span class="number">19</span> || dateStr.length() == <span class="number">23</span>) &#123;</div><div class="line">try &#123;</div><div class="line">java.util.Calendar cal = java.util.Calendar.getInstance();</div><div class="line">cal.set(Integer.parseInt(dateStr.substring(<span class="number">0</span>, <span class="number">4</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">5</span>, <span class="number">7</span>)) - <span class="number">1</span>,</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">8</span>, <span class="number">10</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">11</span>, <span class="number">13</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">14</span>, <span class="number">16</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">17</span>, <span class="number">19</span>)));</div><div class="line">cal.set(java.util.Calendar.MILLISECOND, <span class="number">0</span>);</div><div class="line">return (cal.getTime().getTime());</div><div class="line">&#125; catch (Exception e) &#123;</div><div class="line">return <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125; else if (dateStr.length() == <span class="number">16</span>) &#123;</div><div class="line">try &#123;</div><div class="line">java.util.Calendar cal = java.util.Calendar.getInstance();</div><div class="line">cal.set(Integer.parseInt(dateStr.substring(<span class="number">0</span>, <span class="number">4</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">5</span>, <span class="number">7</span>)) - <span class="number">1</span>,</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">8</span>, <span class="number">10</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">11</span>, <span class="number">13</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">14</span>, <span class="number">16</span>)));</div><div class="line">cal.set(java.util.Calendar.MILLISECOND, <span class="number">0</span>);</div><div class="line">return (cal.getTime().getTime());</div><div class="line">&#125; catch (Exception e) &#123;</div><div class="line">return <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125; else if (dateStr.length() == <span class="number">14</span>) &#123;</div><div class="line">try &#123;</div><div class="line">java.util.Calendar cal = java.util.Calendar.getInstance();</div><div class="line">cal.set(Integer.parseInt(dateStr.substring(<span class="number">0</span>, <span class="number">4</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">4</span>, <span class="number">6</span>)) - <span class="number">1</span>,</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">6</span>, <span class="number">8</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">8</span>, <span class="number">10</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">10</span>, <span class="number">12</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">12</span>, <span class="number">14</span>)));</div><div class="line">cal.set(java.util.Calendar.MILLISECOND, <span class="number">0</span>);</div><div class="line">return (cal.getTime().getTime());</div><div class="line">&#125; catch (Exception e) &#123;</div><div class="line">return <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line">&#125; else if (dateStr.length() == <span class="number">10</span> || dateStr.length() == <span class="number">11</span>) &#123;</div><div class="line">try &#123;</div><div class="line">java.util.Calendar cal = java.util.Calendar.getInstance();</div><div class="line">cal.set(Integer.parseInt(dateStr.substring(<span class="number">0</span>, <span class="number">4</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">5</span>, <span class="number">7</span>)) - <span class="number">1</span>,</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">8</span>, <span class="number">10</span>)), <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">cal.set(java.util.Calendar.MILLISECOND, <span class="number">0</span>);</div><div class="line">return (cal.getTime().getTime());</div><div class="line">&#125; catch (Exception e) &#123;</div><div class="line">return <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line">&#125; else if (dateStr.length() == <span class="number">8</span> ) &#123;</div><div class="line">try &#123;</div><div class="line">java.util.Calendar cal = java.util.Calendar.getInstance();</div><div class="line">cal.set(Integer.parseInt(dateStr.substring(<span class="number">0</span>, <span class="number">4</span>)),</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">4</span>, <span class="number">6</span>)) - <span class="number">1</span>,</div><div class="line">Integer.parseInt(dateStr.substring(<span class="number">6</span>, <span class="number">8</span>)), <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">cal.set(java.util.Calendar.MILLISECOND, <span class="number">0</span>);</div><div class="line">return (cal.getTime().getTime());</div><div class="line">&#125; catch (Exception e) &#123;</div><div class="line">return <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line">&#125; else &#123;</div><div class="line">try &#123;</div><div class="line">return Long.parseLong(dateStr);</div><div class="line">&#125; catch (Exception e) &#123;</div><div class="line">return <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="获取指定日期前后N天的日期"><a href="#获取指定日期前后N天的日期" class="headerlink" title="获取指定日期前后N天的日期"></a>获取指定日期前后N天的日期</h3><p>日期计算偶尔也会出现，这里主要通过java.util.Calendar类来实现，Calendar提供了良好的接口，可以方便的获取年、月、日、时、分、秒、周等，也可以对应的设置指定属性的值，是很方便的日期计算工具。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取指定日期前后num天的日期</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年9月14日 上午11:13:18</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> date</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> num 正数 多少天之后的日期  负数 多少天之后的日期</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">String <span class="title">getDay</span><span class="params">(String date,<span class="keyword">int</span> num)</span></span>&#123;</div><div class="line"><span class="function"><span class="keyword">return</span> <span class="title">getDay</span><span class="params">(date, num,DATE_FORMAT_DEFAULT)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取指定日期前后num天的日期</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年9月14日 上午11:13:18</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> date</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> num 正数 多少天之后的日期  负数 多少天之后的日期</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> format 日期格式</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">String <span class="title">getDay</span><span class="params">(String date,<span class="keyword">int</span> num,String format)</span></span>&#123;</div><div class="line"><span class="keyword">long</span> t = parseStringToLong(date);</div><div class="line"><span class="function"><span class="keyword">return</span> <span class="title">getDay</span><span class="params">(t, num, DATE_FORMAT_DEFAULT)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取指定日期前后num天的日期</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年9月14日 上午11:13:18</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> date</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> num 正数 多少天之后的日期  负数 多少天之后的日期</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">String <span class="title">getDay</span><span class="params">(<span class="keyword">long</span> date,<span class="keyword">int</span> num)</span></span>&#123;</div><div class="line"><span class="function"><span class="keyword">return</span> <span class="title">getDay</span><span class="params">(date, num, DATE_FORMAT_DEFAULT)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取指定日期前后num天的日期</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年9月14日 上午11:13:18</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> date</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> num 正数 多少天之后的日期  负数 多少天之后的日期</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> format 日期格式</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">String <span class="title">getDay</span><span class="params">(<span class="keyword">long</span> date,<span class="keyword">int</span> num,String format)</span></span>&#123;</div><div class="line">Calendar calendar = Calendar.getInstance();</div><div class="line">calendar.setTimeInMillis(date);</div><div class="line">calendar.set(Calendar.DAY_OF_MONTH, calendar.get(Calendar.DAY_OF_MONTH)+num);</div><div class="line"><span class="keyword">return</span> longToString(calendar.getTimeInMillis(),format);</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>web开发内，提取常用工具类，不断丰富开发工具包是很有意义的事，不用同样的事情自己或其他同事重复开发很多次。本文列出了比较常用的long型时间格式化、string类型时间转为long型毫秒数及日期计算的方法。可以基于joda-time包和calendar提前自己常用的攻击方法。</p><p>完整内容请参考github内rest-base项目内代码。<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;web开发中经常需要对日期进行操作，如字符串日期转long，long型转字符串，日期计算等，提取一个日期处理工具类，提供常见的日期操作可以让开发更轻松一些。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="日期处理" scheme="http://www.onecoderspace.com/tags/%E6%97%A5%E6%9C%9F%E5%A4%84%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>spring boot实战之CSRF（跨站请求伪造）</title>
    <link href="http://www.onecoderspace.com/2017/10/06/spring-boot-csrf/"/>
    <id>http://www.onecoderspace.com/2017/10/06/spring-boot-csrf/</id>
    <published>2017-10-06T06:55:47.000Z</published>
    <updated>2017-10-06T08:57:32.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>CSRF（Cross-site request forgery）跨站请求伪造，也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用。攻击通过在授权用户访问的页面中包含链接或者脚本的方式工作。例如：一个网站用户Bob可能正在浏览聊天论坛，而同时另一个用户Alice也在此论坛中，并且后者刚刚发布了一个具有Bob银行链接的图片消息。设想一下，Alice编写了一个在Bob的银行站点上进行取款的form提交的链接，并将此链接作为图片src。如果Bob的银行在cookie中保存他的授权信息，并且此cookie没有过期，那么当Bob的浏览器尝试装载图片时将提交这个取款form和他的cookie，这样在没经Bob同意的情况下便授权了这次事务。</p></blockquote><a id="more"></a><p>下面是CSRF的常见特性：  </p><ol><li>依靠用户标识危害网站  </li><li>利用网站对用户标识的信任</li><li>欺骗用户的浏览器发送HTTP请求给目标站点</li><li>可以通过IMG标签会触发一个GET请求，可以利用它来实现CSRF攻击</li></ol><p>一个简单的例子：  </p><ul><li>用户小z登录了网站A，同时打开网站B  </li><li>网站B隐蔽的发送一个请求至网站A  </li><li>网站A通过session、cookie等身份标记判断是用户小z，执行对应操作</li></ul><p>这样网站B内的非法代码就盗用了用户小z的身份，在小z不知情的情况下执行了攻击者需要的操作，这就是跨站请求伪造。</p><p>防御CSRF可以通过动态token验证的方式来实现，每次请求生成一个动态token给前端，前端在后续的请求中附加该token，如果token不存在或不正确说明不是正常请求，予以屏蔽，从而达到解决CSRF问题的目的，以下是具体实现。</p><h3 id="1、登录成功设置token"><a href="#1、登录成功设置token" class="headerlink" title="1、登录成功设置token"></a>1、登录成功设置token</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">String</span> uuidToken = UUID.randomUUID().toString();</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"token"</span>, uuidToken);</div><div class="line">currentUser.getSession().<span class="built_in">setTimeout</span>(NumberUtils.toLong(serverSessionTimeout, <span class="number">1800</span>)*<span class="number">1000</span>);</div><div class="line">request.getSession().setAttribute(<span class="string">"token"</span>,uuidToken );</div><div class="line"><span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line"></div></pre></td></tr></table></figure><p>前后端分离架构，登录成功后将token传递给前端，由前端进行保存。</p><h3 id="2、创建CSRFFilter"><a href="#2、创建CSRFFilter" class="headerlink" title="2、创建CSRFFilter"></a>2、创建CSRFFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment"> * CSRF跨域请求伪造拦截</span></div><div class="line"><span class="comment"> * 除登录以外的post方法，都需要携带token，如果token为空或token错误，则返回异常提示</span></div><div class="line"><span class="comment"> * 注意在filter初始化参数内配置排除的url</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk </span></div><div class="line"><span class="comment"> */</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsrfFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;  </div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(CsrfFilter.class);</div><div class="line"></div><div class="line"><span class="keyword">public</span> List&lt;String&gt; excludes = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> isOpen = <span class="keyword">false</span>;<span class="comment">//是否开启该filter</span></div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException,ServletException </span>&#123;  </div><div class="line">  <span class="keyword">if</span>(!isOpen)&#123;</div><div class="line">  filterChain.doFilter(request, response);</div><div class="line">  <span class="keyword">return</span> ;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span>(logger.isDebugEnabled())&#123;</div><div class="line">  logger.debug(<span class="string">"csrf filter is running"</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  HttpServletRequest req = (HttpServletRequest) request;</div><div class="line">HttpServletResponse resp = (HttpServletResponse) response;</div><div class="line">HttpSession session = req.getSession();</div><div class="line">  Object token = session.getAttribute(<span class="string">"token"</span>);</div><div class="line">  <span class="keyword">if</span>(!<span class="string">"post"</span>.equalsIgnoreCase(req.getMethod()) || handleExcludeURL(req, resp) || token == <span class="keyword">null</span>)&#123;</div><div class="line">  filterChain.doFilter(request, response);</div><div class="line"><span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line">  </div><div class="line">  String requestToken = req.getParameter(<span class="string">"token"</span>);</div><div class="line">  <span class="keyword">if</span>(StringUtils.isBlank(requestToken) || !requestToken.equals(token))&#123;</div><div class="line">  AjaxResponseWriter.write(req, resp, ServiceStatusEnum.ILLEGAL_TOKEN, <span class="string">"非法的token"</span>);</div><div class="line"><span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  filterChain.doFilter(request, response);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handleExcludeURL</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (excludes == <span class="keyword">null</span> || excludes.isEmpty()) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line">String url = request.getServletPath();</div><div class="line"><span class="keyword">for</span> (String pattern : excludes) &#123;</div><div class="line">Pattern p = Pattern.compile(<span class="string">"^"</span> + pattern);</div><div class="line">Matcher m = p.matcher(url);</div><div class="line"><span class="keyword">if</span> (m.find()) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line"><span class="keyword">if</span>(logger.isDebugEnabled())&#123;</div><div class="line">logger.debug(<span class="string">"csrf filter init~~~~~~~~~~~~"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">String temp = filterConfig.getInitParameter(<span class="string">"excludes"</span>);</div><div class="line"><span class="keyword">if</span> (temp != <span class="keyword">null</span>) &#123;</div><div class="line">String[] url = temp.split(<span class="string">","</span>);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; url != <span class="keyword">null</span> &amp;&amp; i &lt; url.length; i++) &#123;</div><div class="line">excludes.add(url[i]);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">temp = filterConfig.getInitParameter(<span class="string">"isOpen"</span>);</div><div class="line"><span class="keyword">if</span>(StringUtils.isNotBlank(temp) &amp;&amp; <span class="string">"true"</span>.equals(isOpen))&#123;</div><div class="line">isOpen = <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;  </div><div class="line">  </div><div class="line">&#125; </div></pre></td></tr></table></figure><p>除登录之外，post方式提交的请求都需要携带token，用于验证。</p><h3 id="3、注册CSRFFilter"><a href="#3、注册CSRFFilter" class="headerlink" title="3、注册CSRFFilter"></a>3、注册CSRFFilter</h3><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * csrf过滤拦截器</span></div><div class="line"><span class="comment"> */</span></div><div class="line">@Bean</div><div class="line"><span class="keyword">public</span> FilterRegistrationBean csrfFilterRegistrationBean() &#123;</div><div class="line">FilterRegistrationBean filterRegistrationBean = <span class="keyword">new</span> <span class="type">FilterRegistrationBean</span>();</div><div class="line">filterRegistrationBean.setFilter(<span class="keyword">new</span> <span class="type">CsrfFilter</span>());</div><div class="line">filterRegistrationBean.setOrder(<span class="number">2</span>);</div><div class="line">filterRegistrationBean.setEnabled(<span class="literal">true</span>);</div><div class="line">filterRegistrationBean.addUrlPatterns(<span class="string">"/*"</span>);</div><div class="line">Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; initParameters = Maps.<span class="keyword">new</span><span class="type">HashMap</span>();</div><div class="line">initParameters.put(<span class="string">"excludes"</span>, <span class="string">"/login/*"</span>);</div><div class="line">initParameters.put(<span class="string">"isOpen"</span>, isCsrfFilterOpen);</div><div class="line">filterRegistrationBean.setInitParameters(initParameters);</div><div class="line"><span class="keyword">return</span> filterRegistrationBean;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>防御CSRF攻击可以通过在表单内添加随机token来实现，本例内未提供token刷新机制，可根据具体情况调整，如使用一次后刷新或用旧的token获取新的token等，不能提供一个刷新接口，让前端直接调用而不验证旧有token，那样该接口本身就是不安全的，会被伪用户调用。<br>具体实现：  </p><ol><li>登录成功，返回token给前端（前后端分离架构）；</li><li>创建CsrfFilter，对非登录的post请求，验证其token是否正确；</li><li>注册CSRFFilter</li><li>如有需要，可在token使用后刷新或前端控制使用旧token换取新token。</li></ol><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;CSRF（Cross-site request forgery）跨站请求伪造，也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用。攻击通过在授权用户访问的页面中包含链接或者脚本的方式工作。例如：一个网站用户Bob可能正在浏览聊天论坛，而同时另一个用户Alice也在此论坛中，并且后者刚刚发布了一个具有Bob银行链接的图片消息。设想一下，Alice编写了一个在Bob的银行站点上进行取款的form提交的链接，并将此链接作为图片src。如果Bob的银行在cookie中保存他的授权信息，并且此cookie没有过期，那么当Bob的浏览器尝试装载图片时将提交这个取款form和他的cookie，这样在没经Bob同意的情况下便授权了这次事务。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="CSRF" scheme="http://www.onecoderspace.com/tags/CSRF/"/>
    
  </entry>
  
  <entry>
    <title>spring boot实战之XSS过滤</title>
    <link href="http://www.onecoderspace.com/2017/10/06/spring-boot-xss/"/>
    <id>http://www.onecoderspace.com/2017/10/06/spring-boot-xss/</id>
    <published>2017-10-06T03:24:25.000Z</published>
    <updated>2017-10-06T06:54:01.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>XSS攻击全称跨站脚本攻击，是为不和层叠样式表(Cascading Style Sheets, CSS)的缩写混淆，故将跨站脚本攻击缩写为XSS，XSS是一种在web应用中的计算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中。</p></blockquote><a id="more"></a><p>你可以自己做个简单尝试：  </p><ol><li>在任何一个表单内，你输入一段简单的js代码：<code>&lt;script&gt;for(var i=0;i&lt;1000;i++){alert(&quot;弹死你&quot;+i);}&lt;/script&gt;</code>，将其存入数据库；</li><li>在页面上一个div元素内直接展示第一步内存入的值，你会发现弹出框出现了；</li></ol><p>以上XSS攻击只算一个小恶作剧，但如果这玩意被发到了网站的首页上，我估计老板一定会因为频繁的投诉而和你来场愉快的谈话…  </p><p>以上两个示例仅仅算是恶作剧，恶意用户能做的更多，如获取用户信息，进行“网络钓鱼”攻击等。  </p><p>应对XSS攻击的其中一个方式就是后端对输入内容进行过滤，输入内容里面的敏感信息直接过滤，如<code>&lt;script&gt;</code>标签等，以下来说明如何在spring boot项目内方便快捷的实现XSS过滤。</p><h3 id="1、Jsoup组件"><a href="#1、Jsoup组件" class="headerlink" title="1、Jsoup组件"></a>1、Jsoup组件</h3><p>Jsoup使用标签白名单的机制用来进行防止XSS攻击, 假设白名单中只允许p标签存在, 此时在一段HTML代码中, 只能存在p标签 , 其他标签将会被清除只保留被标签所包裹的内容，因此使用Jsoup组件来进行内容过滤。  </p><p>添加maven依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">&lt;!-- xss过滤组件 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jsoup<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsoup<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p><p>JsoupUtil提供基于Jsoup过滤非法标签的工具类：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * xss非法标签过滤</span></div><div class="line"><span class="comment"> * &#123;@link http://www.jianshu.com/p/32abc12a175a?nomobile=yes&#125;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> class JsoupUtil &#123;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 使用自带的basicWithImages 白名单</span></div><div class="line"><span class="comment"> * 允许的便签有a,b,blockquote,br,cite,code,dd,dl,dt,em,i,li,ol,p,pre,q,small,span,</span></div><div class="line"><span class="comment"> * strike,strong,sub,sup,u,ul,img</span></div><div class="line"><span class="comment"> * 以及a标签的href,img标签的src,align,alt,height,width,title属性</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Whitelist whitelist = Whitelist.basicWithImages();</div><div class="line"><span class="comment">/** 配置过滤化参数,不对代码进行格式化 */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Document.OutputSettings outputSettings = <span class="keyword">new</span> Document.OutputSettings().prettyPrint(<span class="keyword">false</span>);</div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line"><span class="comment">// 富文本编辑时一些样式是使用style来进行实现的</span></div><div class="line"><span class="comment">// 比如红色字体 style="color:red;"</span></div><div class="line"><span class="comment">// 所以需要给所有标签添加style属性</span></div><div class="line">whitelist.addAttributes(<span class="string">":all"</span>, <span class="string">"style"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> clean(<span class="keyword">String</span> content) &#123;</div><div class="line"><span class="keyword">return</span> Jsoup.clean(content, <span class="string">""</span>, whitelist, outputSettings);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) <span class="keyword">throws</span> FileNotFoundException, IOException &#123;</div><div class="line"><span class="keyword">String</span> <span class="built_in">text</span> = <span class="string">"&lt;a href=\"http://www.baidu.com/a\" onclick=\"alert(1);\"&gt;sss&lt;/a&gt;&lt;script&gt;alert(0);&lt;/script&gt;sss"</span>;</div><div class="line">System.out.<span class="built_in">println</span>(clean(<span class="built_in">text</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="2、创建XssHttpServletRequestWrapper"><a href="#2、创建XssHttpServletRequestWrapper" class="headerlink" title="2、创建XssHttpServletRequestWrapper"></a>2、创建XssHttpServletRequestWrapper</h3><p>这是实现XSS过滤的关键，在其内重写了getParameter，getParameterValues，getHeader等方法，对http请求内的参数进行了过滤。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> XssHttpServletRequestWrapper <span class="keyword">extends</span> HttpServletRequestWrapper &#123;  </div><div class="line">    HttpServletRequest orgRequest = <span class="literal">null</span>;  </div><div class="line">    <span class="keyword">private</span> <span class="built_in">boolean</span> isIncludeRichText = <span class="literal">false</span>;</div><div class="line">  </div><div class="line">    <span class="keyword">public</span> XssHttpServletRequestWrapper(HttpServletRequest request, <span class="built_in">boolean</span> isIncludeRichText) &#123;  </div><div class="line">        <span class="keyword">super</span>(request);  </div><div class="line">        orgRequest = request;</div><div class="line">        <span class="keyword">this</span>.isIncludeRichText = isIncludeRichText;</div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line"><span class="comment">    * 覆盖getParameter方法，将参数名和参数值都做xss过滤。&lt;br/&gt; </span></div><div class="line"><span class="comment">    * 如果需要获得原始的值，则通过super.getParameterValues(name)来获取&lt;br/&gt; </span></div><div class="line"><span class="comment">    * getParameterNames,getParameterValues和getParameterMap也可能需要覆盖 </span></div><div class="line"><span class="comment">    */</span>  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="keyword">public</span> <span class="built_in">String</span> getParameter(<span class="built_in">String</span> name) &#123;  </div><div class="line">    <span class="keyword">if</span>((<span class="string">"content"</span>.equals(name) || name.endsWith(<span class="string">"WithHtml"</span>)) &amp;&amp; !isIncludeRichText)&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.getParameter(name);</div><div class="line">    &#125;</div><div class="line">    name = JsoupUtil.clean(name);</div><div class="line">        <span class="built_in">String</span> value = <span class="keyword">super</span>.getParameter(name);  </div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(value)) &#123;</div><div class="line">            value = JsoupUtil.clean(value);  </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> value;  </div><div class="line">    &#125;  </div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="built_in">String</span>[] getParameterValues(<span class="built_in">String</span> name) &#123;</div><div class="line">    <span class="built_in">String</span>[] arr = <span class="keyword">super</span>.getParameterValues(name);</div><div class="line">    <span class="keyword">if</span>(arr != <span class="literal">null</span>)&#123;</div><div class="line">    <span class="keyword">for</span> (int i=<span class="number">0</span>;i&lt;arr.length;i++) &#123;</div><div class="line">    arr[i] = JsoupUtil.clean(arr[i]);</div><div class="line">    &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> arr;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line"><span class="comment">    * 覆盖getHeader方法，将参数名和参数值都做xss过滤。&lt;br/&gt; </span></div><div class="line"><span class="comment">    * 如果需要获得原始的值，则通过super.getHeaders(name)来获取&lt;br/&gt; </span></div><div class="line"><span class="comment">    * getHeaderNames 也可能需要覆盖 </span></div><div class="line"><span class="comment">    */</span>  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="keyword">public</span> <span class="built_in">String</span> getHeader(<span class="built_in">String</span> name) &#123;  </div><div class="line">    name = JsoupUtil.clean(name);</div><div class="line">        <span class="built_in">String</span> value = <span class="keyword">super</span>.getHeader(name);  </div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(value)) &#123;  </div><div class="line">            value = JsoupUtil.clean(value); </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> value;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line"><span class="comment">    * 获取最原始的request </span></div><div class="line"><span class="comment">    * </span></div><div class="line"><span class="comment">    * @return </span></div><div class="line"><span class="comment">    */</span>  </div><div class="line">    <span class="keyword">public</span> HttpServletRequest getOrgRequest() &#123;  </div><div class="line">        <span class="keyword">return</span> orgRequest;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line"><span class="comment">    * 获取最原始的request的静态方法 </span></div><div class="line"><span class="comment">    * </span></div><div class="line"><span class="comment">    * @return </span></div><div class="line"><span class="comment">    */</span>  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HttpServletRequest getOrgRequest(HttpServletRequest req) &#123;  </div><div class="line">        <span class="keyword">if</span> (req <span class="keyword">instanceof</span> XssHttpServletRequestWrapper) &#123;  </div><div class="line">            <span class="keyword">return</span> ((XssHttpServletRequestWrapper) req).getOrgRequest();  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="keyword">return</span> req;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">&#125; </div><div class="line"></div></pre></td></tr></table></figure><h3 id="3、创建XssFilter"><a href="#3、创建XssFilter" class="headerlink" title="3、创建XssFilter"></a>3、创建XssFilter</h3><p>XssFilter是过滤XSS请求的入口，在这里通过XssHttpServletRequestWrapper将HttpServletRequest进行了封装，<code>filterChain.doFilter(xssRequest, response);</code>保证了后续代码执行request.getParameter，request.getParameterValues，request.getHeader时调用的都是XssHttpServletRequestWrapper内重写的方法，获取到的参数是已经进行过标签过滤的内容，从而消除了敏感信息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment"> * 拦截防止xss注入</span></div><div class="line"><span class="comment"> * 通过Jsoup过滤请求参数内的特定字符</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk </span></div><div class="line"><span class="comment"> */</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XssFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;  </div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(XssFilter.class);</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> IS_INCLUDE_RICH_TEXT = <span class="keyword">false</span>;<span class="comment">//是否过滤富文本内容</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> List&lt;String&gt; excludes = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException,ServletException </span>&#123;  </div><div class="line">    <span class="keyword">if</span>(logger.isDebugEnabled())&#123;</div><div class="line">  logger.debug(<span class="string">"xss filter is open"</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  HttpServletRequest req = (HttpServletRequest) request;</div><div class="line">HttpServletResponse resp = (HttpServletResponse) response;</div><div class="line">  <span class="keyword">if</span>(handleExcludeURL(req, resp))&#123;</div><div class="line">  filterChain.doFilter(request, response);</div><div class="line"><span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line">  </div><div class="line">  XssHttpServletRequestWrapper xssRequest = <span class="keyword">new</span> XssHttpServletRequestWrapper((HttpServletRequest) request,IS_INCLUDE_RICH_TEXT);</div><div class="line">  filterChain.doFilter(xssRequest, response);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handleExcludeURL</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (excludes == <span class="keyword">null</span> || excludes.isEmpty()) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">String url = request.getServletPath();</div><div class="line"><span class="keyword">for</span> (String pattern : excludes) &#123;</div><div class="line">Pattern p = Pattern.compile(<span class="string">"^"</span> + pattern);</div><div class="line">Matcher m = p.matcher(url);</div><div class="line"><span class="keyword">if</span> (m.find()) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line"><span class="keyword">if</span>(logger.isDebugEnabled())&#123;</div><div class="line">logger.debug(<span class="string">"xss filter init~~~~~~~~~~~~"</span>);</div><div class="line">&#125;</div><div class="line">String isIncludeRichText = filterConfig.getInitParameter(<span class="string">"isIncludeRichText"</span>);</div><div class="line"><span class="keyword">if</span>(StringUtils.isNotBlank(isIncludeRichText))&#123;</div><div class="line">IS_INCLUDE_RICH_TEXT = BooleanUtils.toBoolean(isIncludeRichText);</div><div class="line">&#125;</div><div class="line"></div><div class="line">String temp = filterConfig.getInitParameter(<span class="string">"excludes"</span>);</div><div class="line"><span class="keyword">if</span> (temp != <span class="keyword">null</span>) &#123;</div><div class="line">String[] url = temp.split(<span class="string">","</span>);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; url != <span class="keyword">null</span> &amp;&amp; i &lt; url.length; i++) &#123;</div><div class="line">excludes.add(url[i]);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="4、注册XssFilter"><a href="#4、注册XssFilter" class="headerlink" title="4、注册XssFilter"></a>4、注册XssFilter</h3><p>通过java config的方式注册XSSFilter，使其生效。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * xss过滤拦截器</span></div><div class="line"><span class="comment"> */</span></div><div class="line">@Bean</div><div class="line"><span class="keyword">public</span> FilterRegistrationBean xssFilterRegistrationBean() &#123;</div><div class="line">FilterRegistrationBean filterRegistrationBean = <span class="keyword">new</span> <span class="type">FilterRegistrationBean</span>();</div><div class="line">filterRegistrationBean.setFilter(<span class="keyword">new</span> <span class="type">XssFilter</span>());</div><div class="line">filterRegistrationBean.setOrder(<span class="number">1</span>);</div><div class="line">filterRegistrationBean.setEnabled(<span class="literal">true</span>);</div><div class="line">filterRegistrationBean.addUrlPatterns(<span class="string">"/*"</span>);</div><div class="line">Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; initParameters = Maps.<span class="keyword">new</span><span class="type">HashMap</span>();</div><div class="line">initParameters.put(<span class="string">"excludes"</span>, <span class="string">"/favicon.ico,/img/*,/js/*,/css/*"</span>);</div><div class="line">initParameters.put(<span class="string">"isIncludeRichText"</span>, <span class="string">"true"</span>);</div><div class="line">filterRegistrationBean.setInitParameters(initParameters);</div><div class="line"><span class="keyword">return</span> filterRegistrationBean;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>excludes用于配置不需要参数过滤的请求url</li><li>isIncludeRichText默认为true，主要用于设置富文本（项目内约束以content为名或以WithHtml结尾）内容是否需要过滤，该选项可根据公司具体情况调整，建议约束富文本编辑框支持的标签并开启改约束，减少安全隐患</li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>防御XSS攻击，可以通过后端统一进行标签过滤，去掉所有输入内容中包含的类似于<code>&lt;script&gt;</code>这样的非法标签来实现。  </p><ol><li>标签过滤实现可使用Jsoup，功能强大，使用方便，更多内容可参考<a href="http://www.jianshu.com/p/32abc12a175a?nomobile=yes" target="_blank" rel="external">Jsoup 防止富文本 XSS 攻击</a>；  </li><li>继承HttpServletRequestWrapper，重写从request内获取参数的方法，在其内调用JsoupUtil的方法，进行参数脱敏处理；  </li><li>通过XssFilter将XssHttpServletRequestWrapper设置入处理链中，从而达到后续处理类内通过Request获取参数时调用的是重写后的获取参数的方法，进而达成业务代码无感知的实现了XSS过滤的目的。</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;XSS攻击全称跨站脚本攻击，是为不和层叠样式表(Cascading Style Sheets, CSS)的缩写混淆，故将跨站脚本攻击缩写为XSS，XSS是一种在web应用中的计算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="XSS" scheme="http://www.onecoderspace.com/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>spring boot实战之shiro session过期时间</title>
    <link href="http://www.onecoderspace.com/2017/10/06/spring-boot-shiro-session/"/>
    <id>http://www.onecoderspace.com/2017/10/06/spring-boot-shiro-session/</id>
    <published>2017-10-06T00:12:01.000Z</published>
    <updated>2017-10-06T00:21:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>在spring boot内，设置session过期时间只需在application.properties内添加server.session.timeout配置即可。在整合shiro时发现，server.session.timeout设置为7200，但未到2小时就需要重新登录，后来发现是shiro的session已经过期了，shiro的session过期时间并不和server.session.timeout一致，目前是采用filter的方式来进行设置。<br><a id="more"></a></p><h3 id="ShiroSessionFilter"><a href="#ShiroSessionFilter" class="headerlink" title="ShiroSessionFilter"></a>ShiroSessionFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment"> * 通过拦截器设置shiroSession过期时间</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk </span></div><div class="line"><span class="comment"> */</span>  </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroSessionFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;  </div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(ShiroSessionFilter.class);</div><div class="line"></div><div class="line"><span class="keyword">public</span> List&lt;String&gt; excludes = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">long</span> serverSessionTimeout = <span class="number">180000L</span>;<span class="comment">//ms</span></div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException,ServletException </span>&#123;  </div><div class="line">    <span class="keyword">if</span>(logger.isDebugEnabled())&#123;</div><div class="line">  logger.debug(<span class="string">"shiro session filter is open"</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  HttpServletRequest req = (HttpServletRequest) request;</div><div class="line">HttpServletResponse resp = (HttpServletResponse) response;</div><div class="line">  <span class="keyword">if</span>(handleExcludeURL(req, resp))&#123;</div><div class="line">  filterChain.doFilter(request, response);</div><div class="line"><span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line">  </div><div class="line">  Subject currentUser = SecurityUtils.getSubject();</div><div class="line">  <span class="keyword">if</span>(currentUser.isAuthenticated())&#123;</div><div class="line">  currentUser.getSession().setTimeout(serverSessionTimeout);</div><div class="line">  &#125;</div><div class="line">  filterChain.doFilter(request, response);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handleExcludeURL</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (excludes == <span class="keyword">null</span> || excludes.isEmpty()) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">String url = request.getServletPath();</div><div class="line"><span class="keyword">for</span> (String pattern : excludes) &#123;</div><div class="line">Pattern p = Pattern.compile(<span class="string">"^"</span> + pattern);</div><div class="line">Matcher m = p.matcher(url);</div><div class="line"><span class="keyword">if</span> (m.find()) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line"><span class="keyword">if</span>(logger.isDebugEnabled())&#123;</div><div class="line">logger.debug(<span class="string">"shiro session filter init~~~~~~~~~~~~"</span>);</div><div class="line">&#125;</div><div class="line">String temp = filterConfig.getInitParameter(<span class="string">"excludes"</span>);</div><div class="line"><span class="keyword">if</span> (temp != <span class="keyword">null</span>) &#123;</div><div class="line">String[] url = temp.split(<span class="string">","</span>);</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; url != <span class="keyword">null</span> &amp;&amp; i &lt; url.length; i++) &#123;</div><div class="line">excludes.add(url[i]);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">String timeout = filterConfig.getInitParameter(<span class="string">"serverSessionTimeout"</span>);</div><div class="line"><span class="keyword">if</span>(StringUtils.isNotBlank(timeout))&#123;</div><div class="line"><span class="keyword">this</span>.serverSessionTimeout = NumberUtils.toLong(timeout,<span class="number">1800L</span>)*<span class="number">1000L</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="注册filter"><a href="#注册filter" class="headerlink" title="注册filter"></a>注册filter</h3><p>在被@Configuration注解标注的类内注册ShiroSessionFilter。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@Value(<span class="string">"$&#123;server.session.timeout&#125;"</span>)</div><div class="line"><span class="keyword">private</span> <span class="keyword">String</span> serverSessionTimeout;</div><div class="line"></div><div class="line">@Bean</div><div class="line"><span class="keyword">public</span> FilterRegistrationBean shiroSessionFilterRegistrationBean() &#123;</div><div class="line">FilterRegistrationBean filterRegistrationBean = <span class="keyword">new</span> <span class="type">FilterRegistrationBean</span>();</div><div class="line">filterRegistrationBean.setFilter(<span class="keyword">new</span> <span class="type">ShiroSessionFilter</span>());</div><div class="line">filterRegistrationBean.setOrder(FilterRegistrationBean.LOWEST_PRECEDENCE);</div><div class="line">filterRegistrationBean.setEnabled(<span class="literal">true</span>);</div><div class="line">filterRegistrationBean.addUrlPatterns(<span class="string">"/*"</span>);</div><div class="line">Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; initParameters = Maps.<span class="keyword">new</span><span class="type">HashMap</span>();</div><div class="line">initParameters.put(<span class="string">"serverSessionTimeout"</span>, serverSessionTimeout);</div><div class="line">initParameters.put(<span class="string">"excludes"</span>, <span class="string">"/favicon.ico,/img/*,/js/*,/css/*"</span>);</div><div class="line">filterRegistrationBean.setInitParameters(initParameters);</div><div class="line"><span class="keyword">return</span> filterRegistrationBean;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>这样当每次请求时，如果用户已登录，就重新设置shiro session有效期，从而和server session保持了一致。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在spring boot内，设置session过期时间只需在application.properties内添加server.session.timeout配置即可。在整合shiro时发现，server.session.timeout设置为7200，但未到2小时就需要重新登录，后来发现是shiro的session已经过期了，shiro的session过期时间并不和server.session.timeout一致，目前是采用filter的方式来进行设置。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="shiro session过期时间" scheme="http://www.onecoderspace.com/tags/shiro-session%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4/"/>
    
  </entry>
  
  <entry>
    <title>spring boot项目实战：分布式锁</title>
    <link href="http://www.onecoderspace.com/2017/10/04/spring-boot-distributed-lock/"/>
    <id>http://www.onecoderspace.com/2017/10/04/spring-boot-distributed-lock/</id>
    <published>2017-10-04T01:03:32.000Z</published>
    <updated>2017-10-04T11:31:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>在部分情况下，要保证操作在整个集群内是同步的，以操作库存为例，多个减操作需要同步，常见的有两种方式：  </p><ol><li>采用类CAS的方式，先查询库存，然后使用update xxx set num=num-1 where num=:num;这样可保证库在本次修改之前未被修改；  </li><li>使用分布式锁，保证同时只有一个地方在修改库存。  <a id="more"></a>这里向大家展示一个基于redis的分布式锁。主要涉及三个类：  </li><li>DistributedLockUtil对外提供获取分布式锁的方法；  </li><li>DistributedLock 分布式锁接口，定义分布式锁支持的方法，主要有acquire和release；  </li><li>JedisLock实现DistributedLock接口，是基于redis的分布锁实现    ；</li></ol><p>需要使用StringRedisTemplate，如对spring boot整合redis不熟悉，请参考<a href="http://www.jianshu.com/p/8c9753c62d54" target="_blank" rel="external">spring boot项目实战：redis</a>.</p><h3 id="DistributedLock接口"><a href="#DistributedLock接口" class="headerlink" title="DistributedLock接口"></a>DistributedLock接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DistributedLock</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取锁</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2016年5月6日 上午11:02:54</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acquire</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 释放锁</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2016年5月6日 上午11:02:59</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure><h3 id="JedisLock基于redis的分布式锁实现"><a href="#JedisLock基于redis的分布式锁实现" class="headerlink" title="JedisLock基于redis的分布式锁实现"></a>JedisLock基于redis的分布式锁实现</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisLock</span> <span class="keyword">implements</span> <span class="title">DistributedLock</span></span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(JedisLock.class);</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> StringRedisTemplate redisTemplate;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 分布式锁的键值</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    String lockKey; <span class="comment">//锁的键值</span></div><div class="line">    <span class="keyword">int</span> expireMsecs  = <span class="number">10</span> * <span class="number">1000</span>; <span class="comment">//锁超时，防止线程在入锁以后，无限的执行等待</span></div><div class="line">    <span class="keyword">int</span>     timeoutMsecs = <span class="number">10</span> * <span class="number">1000</span>; <span class="comment">//锁等待，防止线程饥饿</span></div><div class="line">    <span class="keyword">boolean</span> locked = <span class="keyword">false</span>; <span class="comment">//是否已经获取锁</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取指定键值的锁</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> lockKey 锁的键值</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JedisLock</span><span class="params">(String lockKey)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.lockKey = lockKey;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取指定键值的锁,同时设置获取锁超时时间</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> lockKey 锁的键值</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutMsecs 获取锁超时时间</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JedisLock</span><span class="params">(String lockKey, <span class="keyword">int</span> timeoutMsecs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.lockKey = lockKey;</div><div class="line">        <span class="keyword">this</span>.timeoutMsecs = timeoutMsecs;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取指定键值的锁,同时设置获取锁超时时间和锁过期时间</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> lockKey 锁的键值</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutMsecs 获取锁超时时间</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> expireMsecs 锁失效时间</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JedisLock</span><span class="params">(String lockKey, <span class="keyword">int</span> timeoutMsecs, <span class="keyword">int</span> expireMsecs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.lockKey = lockKey;</div><div class="line">        <span class="keyword">this</span>.timeoutMsecs = timeoutMsecs;</div><div class="line">        <span class="keyword">this</span>.expireMsecs = expireMsecs;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">getLockKey</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> lockKey;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> true if lock is acquired, false acquire timeouted</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></div><div class="line"><span class="comment">     *             in case of thread interruption</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="function"><span class="keyword">boolean</span> <span class="title">acquire</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> timeout = timeoutMsecs;</div><div class="line">        <span class="keyword">if</span>(redisTemplate == <span class="keyword">null</span>)&#123;</div><div class="line">        redisTemplate = SpringContextUtil.getBean(StringRedisTemplate.class);</div><div class="line">&#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">while</span> (timeout &gt;= <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">long</span> expires = System.currentTimeMillis() + expireMsecs + <span class="number">1</span>;</div><div class="line">    String expiresStr = String.valueOf(expires); <span class="comment">//锁到期时间</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (redisTemplate.opsForValue().setIfAbsent(lockKey, expiresStr)) &#123;</div><div class="line">        <span class="comment">// lock acquired</span></div><div class="line">        locked = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String currentValueStr = redisTemplate.opsForValue().get(lockKey); <span class="comment">//redis里的时间</span></div><div class="line">    <span class="keyword">if</span> (currentValueStr != <span class="keyword">null</span> &amp;&amp; Long.parseLong(currentValueStr) &lt; System.currentTimeMillis()) &#123;</div><div class="line">        <span class="comment">//判断是否为空，不为空的情况下，如果被其他线程设置了值，则第二个条件判断是过不去的</span></div><div class="line">        <span class="comment">// lock is expired</span></div><div class="line"></div><div class="line">        String oldValueStr = redisTemplate.opsForValue().getAndSet(lockKey, expiresStr);</div><div class="line">        <span class="comment">//获取上一个锁到期时间，并设置现在的锁到期时间，</span></div><div class="line">        <span class="comment">//只有一个线程才能获取上一个线上的设置时间，因为jedis.getSet是同步的</span></div><div class="line">        <span class="keyword">if</span> (oldValueStr != <span class="keyword">null</span> &amp;&amp; oldValueStr.equals(currentValueStr)) &#123;</div><div class="line">            <span class="comment">//如过这个时候，多个线程恰好都到了这里，但是只有一个线程的设置值和当前值相同，他才有权利获取锁</span></div><div class="line">            <span class="comment">// lock acquired</span></div><div class="line">            locked = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    timeout -= <span class="number">100</span>;</div><div class="line">    Thread.sleep(<span class="number">100</span>);</div><div class="line">&#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">logger.<span class="keyword">error</span>(<span class="string">"release lock due to error"</span>,e);</div><div class="line">&#125; </div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 释放锁</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(redisTemplate == <span class="keyword">null</span>)&#123;</div><div class="line">         redisTemplate = SpringContextUtil.getBean(StringRedisTemplate.class);</div><div class="line"> &#125;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">if</span> (locked) &#123;</div><div class="line">    String currentValueStr = redisTemplate.opsForValue().get(lockKey); <span class="comment">//redis里的时间</span></div><div class="line">    <span class="comment">//校验是否超过有效期，如果不在有效期内，那说明当前锁已经失效，不能进行删除锁操作</span></div><div class="line">    <span class="keyword">if</span> (currentValueStr != <span class="keyword">null</span> &amp;&amp; Long.parseLong(currentValueStr) &gt; System.currentTimeMillis()) &#123;</div><div class="line">    redisTemplate.delete(lockKey);</div><div class="line">locked = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">logger.<span class="keyword">error</span>(<span class="string">"release lock due to error"</span>,e);</div><div class="line">&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="DistributedLockUtil"><a href="#DistributedLockUtil" class="headerlink" title="DistributedLockUtil"></a>DistributedLockUtil</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedLockUtil</span></span>&#123;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取分布式锁</span></div><div class="line"><span class="comment"> * 默认获取锁10s超时，锁过期时间60s</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2016年5月6日 下午1:30:46</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">DistributedLock <span class="title">getDistributedLock</span><span class="params">(String lockKey)</span></span>&#123;</div><div class="line">lockKey = assembleKey(lockKey);</div><div class="line">JedisLock lock = <span class="keyword">new</span> JedisLock(lockKey);</div><div class="line"><span class="keyword">return</span> lock;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 正式环境、测试环境共用一个redis时，避免key相同造成影响</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> lockKey</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function">String <span class="title">assembleKey</span><span class="params">(String lockKey)</span> </span>&#123;</div><div class="line"><span class="function"><span class="keyword">return</span> String.<span class="title">format</span><span class="params">(<span class="string">"lock_%s"</span>,lockKey)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取分布式锁</span></div><div class="line"><span class="comment"> * 默认获取锁10s超时，锁过期时间60s</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2016年5月6日 下午1:38:32</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> lockKey</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> timeoutMsecs 指定获取锁超时时间</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">DistributedLock <span class="title">getDistributedLock</span><span class="params">(String lockKey,<span class="keyword">int</span> timeoutMsecs)</span></span>&#123;</div><div class="line">lockKey = assembleKey(lockKey);</div><div class="line">JedisLock lock = <span class="keyword">new</span> JedisLock(lockKey,timeoutMsecs);</div><div class="line"><span class="keyword">return</span> lock;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取分布式锁</span></div><div class="line"><span class="comment"> * 默认获取锁10s超时，锁过期时间60s</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwenkui</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2016年5月6日 下午1:40:04</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> lockKey 锁的key</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> timeoutMsecs 指定获取锁超时时间</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> expireMsecs 指定锁过期时间</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">DistributedLock <span class="title">getDistributedLock</span><span class="params">(String lockKey,<span class="keyword">int</span> timeoutMsecs,<span class="keyword">int</span> expireMsecs)</span></span>&#123;</div><div class="line">lockKey = assembleKey(lockKey);</div><div class="line">JedisLock lock = <span class="keyword">new</span> JedisLock(lockKey,expireMsecs,timeoutMsecs);</div><div class="line"><span class="keyword">return</span> lock;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure><h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">DistributedLock <span class="keyword">lock</span> = DistributedLockUtil.getDistributedLock(key);</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">lock</span>.acquire()) &#123;</div><div class="line"><span class="comment">//获取锁成功业务代码</span></div><div class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 获取锁失败</span></div><div class="line"><span class="comment">//获取锁失败业务代码</span></div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">lock</span> != <span class="literal">null</span>) &#123;</div><div class="line"><span class="keyword">lock</span>.release();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="实现原理简析"><a href="#实现原理简析" class="headerlink" title="实现原理简析"></a>实现原理简析</h3><p>主要是依赖redis的setnx和getset命令对时间进行操作，从而实现锁的功能。以下两个文章对分布式锁进行了极其明细的分析，会让你对分布式锁的认识更加清晰。<br>《<a href="http://url.cn/5U3429y" target="_blank" rel="external">基于Redis的分布式锁到底安全吗（上）？</a>》<br>《<a href="http://url.cn/5eDZp1M" target="_blank" rel="external">基于Redis的分布式锁到底安全吗（下）？</a>》</p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>基于redis的分布式锁依赖于系统时钟，需要保证各个竞争者的时钟的一致性，否则会出现一个参与者获得锁，而另一个参与者的时钟判断其已过期，导致分布式锁失效；  </li><li>需要保证redis节点的高可用，建议使用哨兵机制；  </li><li>在使用分布式锁之前，考虑是否可以通过乐观锁或无锁解决并发同步问题，毕竟使用锁的代价很是比较高昂的；  </li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在部分情况下，要保证操作在整个集群内是同步的，以操作库存为例，多个减操作需要同步，常见的有两种方式：  &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;采用类CAS的方式，先查询库存，然后使用update xxx set num=num-1 where num=:num;这样可保证库在本次修改之前未被修改；  &lt;/li&gt;
&lt;li&gt;使用分布式锁，保证同时只有一个地方在修改库存。
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="分布式锁，redis" scheme="http://www.onecoderspace.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%EF%BC%8Credis/"/>
    
  </entry>
  
  <entry>
    <title>spring boot项目实战：JPA</title>
    <link href="http://www.onecoderspace.com/2017/10/03/spring-boot-jpa/"/>
    <id>http://www.onecoderspace.com/2017/10/03/spring-boot-jpa/</id>
    <published>2017-10-03T05:45:38.000Z</published>
    <updated>2017-10-03T13:46:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>公司的项目中很大一部分属于内部平台，所以对性能的要求没有那么高，开发速度反而更重要，因此在搭建基础框架时选择使用JPA，没有使用mybitis，当然其中也有一部分原因是之前一直使用hibernate，对mybitis不太熟悉^_^。<br><a id="more"></a></p><h3 id="一、配置JPA"><a href="#一、配置JPA" class="headerlink" title="一、配置JPA"></a>一、配置JPA</h3><p>1、添加maven依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">&lt;!-- jpa --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure></p><p>2、 添加数据库配置<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">spring.jpa.database = MYSQL</div><div class="line"><span class="comment"># Hibernate ddl auto (create, create-drop, update)</span></div><div class="line">spring.jpa.hibernate.ddl-auto = update</div><div class="line"><span class="comment"># Naming strategy</span></div><div class="line">spring.jpa.hibernate.naming-strategy = org.hibernate.cfg.ImprovedNamingStrategy</div><div class="line"><span class="comment"># stripped before adding them to the entity manager)</span></div><div class="line">spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5Dialect</div><div class="line"><span class="comment"># Show or not log for each sql query</span></div><div class="line">spring.jpa.show-sql = <span class="literal">true</span></div><div class="line">spring.datasource.<span class="attribute">url</span>=jdbc:mysql://localhost:3306/base?characterEncoding=utf8</div><div class="line">spring.datasource.<span class="attribute">username</span>=root</div><div class="line">spring.datasource.<span class="attribute">password</span>=root</div><div class="line">spring.datasource.<span class="attribute">driverClassName</span>=com.mysql.jdbc.Driver</div><div class="line">spring.datasource.<span class="attribute">max-active</span>=3</div><div class="line">spring.datasource.<span class="attribute">max-idle</span>=1</div><div class="line">spring.datasource.<span class="attribute">min-idle</span>=1</div><div class="line">spring.datasource.<span class="attribute">initial-size</span>=1</div><div class="line"></div></pre></td></tr></table></figure></p><p>3、dao继承上层类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span>  <span class="keyword">extends</span> <span class="title">BaseDao</span>&lt;<span class="title">User</span>, <span class="title">Integer</span>&gt;</span>&#123;</div><div class="line"><span class="function">User <span class="title">findByUsernameAndDel</span><span class="params">(String username, <span class="keyword">int</span> del)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@NoRepositoryBean</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BaseDao</span>&lt;<span class="title">T</span>,<span class="title">ID</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; <span class="keyword">extends</span> <span class="title">JpaSpecificationExecutor</span>&lt;<span class="title">T</span>&gt;,<span class="title">JpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt;</span>&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure><br>为了便于使用，提取了一个BaseDao，需要注意的是要在上层类上添加@ NoRepositoryBean注解。BaseDao继承JpaRepository和JpaSpecificationExecutor，JpaRepository提供了基本的crud等查询方法，JpaSpecificationExecutor提供了对复杂查询的支持。</p><p>完成了以上三步，已经可以在service内注入dao，通过dao进行数据库curd等操作。</p><h3 id="二、JPA查询"><a href="#二、JPA查询" class="headerlink" title="二、JPA查询"></a>二、JPA查询</h3><h4 id="1、-根据方法名实现查询"><a href="#1、-根据方法名实现查询" class="headerlink" title="1、 根据方法名实现查询"></a>1、 根据方法名实现查询</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//根据用户名和标记删除字段查询对应的用户信息</span></div><div class="line">User findByUsernameAndDel(<span class="built_in">String</span> username, <span class="built_in">int</span> del);</div><div class="line"></div><div class="line"><span class="comment">//根据code查询对应的角色</span></div><div class="line">Role findByCode(<span class="built_in">String</span> code);</div><div class="line"></div><div class="line"><span class="comment">//根据id集合查询对应的角色集合</span></div><div class="line"><span class="built_in">Set</span>&lt;Role&gt; findByIdIn(<span class="built_in">Set</span>&lt;Integer&gt; roleIds);</div><div class="line"></div><div class="line"><span class="comment">//根据用户id，查询用户角色关系记录</span></div><div class="line"><span class="built_in">List</span>&lt;UserRole&gt; findByUserId(<span class="built_in">int</span> uid);</div></pre></td></tr></table></figure><p>简单查询可以通过以上方式方便的实现，简化了很多dao层的代码，使用着还是很爽的，具体规则比较简单，基本上就是findBy开始，后续跟上实体属性，中间配以And、Or、In、like等组成方法名，也就是用方法名来描述查询规则。如果是嵌套对象，可以通过“_”来区分子对象的属性，比如findByCompany_name(String name)就是以子对象company内的name属性为查询条件。常用查询关键字如下：  </p><ul><li>And — 等价于 SQL 中的 and 关键字，比如findByUsernameAndPassword(String user, Striang pwd)；  </li><li>Or — 等价于 SQL 中的 or 关键字，比如findByUsernameOrAddress(String user, String addr)；  </li><li>Between — 等价于 SQL 中的 between 关键字，比如 findBySalaryBetween(int max, int min)；  </li><li>LessThan — 等价于 SQL 中的 “&lt;”，比如 findBySalaryLessThan(int max)；  </li><li>GreaterThan — 等价于 SQL 中的”&gt;”，比如 findBySalaryGreaterThan(int min)；  </li><li>IsNull — 等价于 SQL 中的 “is null”，比如 findByUsernameIsNull()；  </li><li>IsNotNull — 等价于 SQL 中的 “is not null”，比如 findByUsernameIsNotNull()；  </li><li>NotNull — 与 IsNotNull 等价；  </li><li>Like — 等价于 SQL 中的 “like”，比如 findByUsernameLike(String user)；  </li><li>NotLike — 等价于 SQL 中的 “not like”，比如 findByUsernameNotLike(String user)；  </li><li>OrderBy — 等价于 SQL 中的 “order by”，比如 findByUsernameOrderBySalaryAsc(String user)；  </li><li>Not — 等价于 SQL 中的 “！ =”，比如 findByUsernameNot(String user)；  </li><li>In — 等价于 SQL 中的 “in”，比如findByUsernameIn(Collection<string> userList) ，方法的参数可以是 Collection 类型，也可以是数组或者不定长参数；  </string></li><li>NotIn — 等价于 SQL 中的 “not in”，比如 findByUsernameNotIn(Collection<string> userList) ，方法的参数可以是 Collection 类型，也可以是数组或者不定长参数；</string></li></ul><h4 id="2、使用-Query查询"><a href="#2、使用-Query查询" class="headerlink" title="2、使用@Query查询"></a>2、使用@Query查询</h4><p><strong>类HQL语句</strong><br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Query</span>(<span class="string">"select u from User u where u.username = ?1"</span>) </div><div class="line"><span class="keyword">public</span> <span class="function">AccountInfo <span class="title">findByAccountId</span><span class="params">(String username)</span></span>; </div><div class="line"></div></pre></td></tr></table></figure><br>在@Query内直接书写HQL语句即可，参数可通过”?1,?2”这样的方式设置，下标从1开始。</p><p><strong>原生sql查询</strong><br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="variable">@Query</span>(value=<span class="string">"select perm.* from role_permission rp left join permission perm on rp.permission_id=perm.id where rp.role_id in(?1);"</span>,nativeQuery=true)</div><div class="line">List&lt;Permission&gt; listByRoleIds(Set&lt;Integer&gt; roles);</div><div class="line"></div><div class="line"><span class="comment">//根据userId删除用户角色关系</span></div><div class="line"><span class="variable">@Query</span>(value = <span class="string">"delete from user_role where user_id=?1 "</span>, nativeQuery = true)  </div><div class="line"><span class="variable">@Modifying</span></div><div class="line">void deleleByUserId(int uid);</div><div class="line"></div></pre></td></tr></table></figure><br>使用也比较简单，将@Query内的nativeQuery设置为true即可。写SQL语句时，可以现在本地mysql客户端上测试号SQL语句的正确性，当需要索引时，创建合适的索引。在此基础上看下SQL的性能，如不理想，需调整SQL，可使用explain对SQL语句进行分析，查询执行逻辑，针对性优化。</p><p><strong>新增、修改</strong><br>直接调用dao的save方法，支持单个保存和批量保存。</p><p><strong>删除</strong><br>直接调用dao的delete方法，支持根据id、对象、对象集合等删除方式，使用时查看下提示方法就可以了。</p><h4 id="3、分页查询"><a href="#3、分页查询" class="headerlink" title="3、分页查询"></a>3、分页查询</h4><p><strong>不带条件分页查询</strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Pageable pageable = new PageRequest(0, 10, new Sort(Direction.DESC, <span class="string">"updateTime"</span>));</div><div class="line">Page&lt;User&gt;<span class="built_in"> page </span>= userDao.findAll(pageable);</div></pre></td></tr></table></figure></p><ul><li>使用PageRequest构建分页请求对象，页码下标从0开始</li></ul><p><strong>多条件复杂分页查询</strong><br>带条件分页查询有两种方式：  </p><ol><li>使用原生SQL进行分页查询，但是前提是多个查询条件必须同时存在，不能有不生效的条件，比如用户列表，用户姓名可以不作为过滤条件，这种情况原生SQL就不适用了，需要使用下面第二种方式  </li><li>使用Specification进行复杂查询，示例代码如下：</li></ol><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public Page&lt;User&gt; listByPage(<span class="keyword">final</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; params,Pageable pageable)&#123;</div><div class="line">Specification&lt;User&gt; spec = <span class="keyword">new</span> Specification&lt;User&gt;() &#123;  </div><div class="line"><span class="meta">@Override</span></div><div class="line">public Predicate toPredicate(Root&lt;User&gt; root,CriteriaQuery&lt;?&gt; query,CriteriaBuilder cb) &#123;</div><div class="line"><span class="built_in">List</span>&lt;Predicate&gt; list = <span class="keyword">new</span> ArrayList&lt;Predicate&gt;();  </div><div class="line"><span class="built_in">String</span> type = params.<span class="keyword">get</span>(<span class="string">"type"</span>);</div><div class="line"><span class="built_in">String</span> status= params.<span class="keyword">get</span>(<span class="string">"status"</span>);</div><div class="line"><span class="built_in">String</span> username = params.<span class="keyword">get</span>(<span class="string">"username"</span>);</div><div class="line"><span class="built_in">String</span> name = params.<span class="keyword">get</span>(<span class="string">"name"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(type))&#123;  </div><div class="line">        list.add(cb.equal(root.<span class="keyword">get</span>(<span class="string">"type"</span>).<span class="keyword">as</span>(Integer.<span class="keyword">class</span>), NumberUtils.toInt(type)));  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(status))&#123;  </div><div class="line">        list.add(cb.equal(root.<span class="keyword">get</span>(<span class="string">"status"</span>).<span class="keyword">as</span>(Integer.<span class="keyword">class</span>), NumberUtils.toInt(status)));  </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(username))&#123;  </div><div class="line">        list.add(cb.like(root.<span class="keyword">get</span>(<span class="string">"username"</span>).<span class="keyword">as</span>(<span class="built_in">String</span>.<span class="keyword">class</span>), <span class="built_in">String</span>.format(<span class="string">"%%%s%%"</span>, username)));  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">if</span>(StringUtils.isNotBlank(name))&#123;  </div><div class="line">    list.add(cb.like(root.<span class="keyword">get</span>(<span class="string">"name"</span>).<span class="keyword">as</span>(<span class="built_in">String</span>.<span class="keyword">class</span>), <span class="built_in">String</span>.format(<span class="string">"%%%s%%"</span>, name)));   </div><div class="line">    &#125;</div><div class="line">    list.add(cb.equal(root.<span class="keyword">get</span>(<span class="string">"del"</span>), Constants.DEL_NO));</div><div class="line">    Predicate[] p = <span class="keyword">new</span> Predicate[list.size()];  </div><div class="line">    <span class="keyword">return</span> cb.and(list.toArray(p));  </div><div class="line"></div><div class="line"><span class="comment">//in条件查询</span></div><div class="line"><span class="comment">/*List&lt;Integer&gt; ids = Lists.newArrayList();</span></div><div class="line"><span class="comment">ids.add(1);</span></div><div class="line"><span class="comment">ids.add(2);</span></div><div class="line"><span class="comment">In&lt;Integer&gt; in = cb.in(root.get("id").as(Integer.class));</span></div><div class="line"><span class="comment">in.value(1);</span></div><div class="line"><span class="comment">in.value(2);</span></div><div class="line"><span class="comment">    return cb.or(in);*/</span></div><div class="line">&#125;  </div><div class="line">&#125;;  </div><div class="line">Page&lt;User&gt; page = userDao.findAll(spec, pageable);</div></pre></td></tr></table></figure><p>根据以上示例，基本满足了常用的查询需求，更多情况可根据规则尝试一下即可，也可百度搜索下JPA Specification，有很多教程。</p><p><strong>简化多条件分页查询</strong><br>使用Specification需要每次都写一大段模板代码，使用起来还是比较繁琐，使用入门也有些难度，基于此，在service层的公共代码出对查询进行了部分封装，简化常见多条件分页查询。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 分页多条件查询</span></div><div class="line"><span class="comment"> * 注：多个条件间是and关系 &amp; 参数是属性对应的类型</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk</span></div><div class="line"><span class="comment"> * <span class="doctag">@time</span> 2017年8月1日 下午3:50:46</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> params &#123;"username:like":"test"&#125; 键的格式为字段名:过滤方式,过滤方式见&#123;<span class="doctag">@code</span> QueryTypeEnum&#125;</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> pageable 分页信息 new PageRequest(page, size,new Sort(Direction.DESC, "updateTime"))</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line">Page&lt;T&gt; list(Map&lt;String, Object&gt; params,Pageable pageable);</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> Page&lt;T&gt; list(<span class="keyword">final</span> Map&lt;String, Object&gt; params,Pageable pageable)&#123;</div><div class="line">Specification&lt;T&gt; spec = new Specification&lt;T&gt;() &#123;  </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> Predicate toPredicate(Root&lt;T&gt; root,CriteriaQuery&lt;?&gt; query,CriteriaBuilder cb) &#123;</div><div class="line">List&lt;Predicate&gt; list = new ArrayList&lt;Predicate&gt;();</div><div class="line"><span class="keyword">for</span>(Entry&lt;String, Object&gt; entry : params.entrySet())&#123;</div><div class="line">Object value = entry.getValue();</div><div class="line"><span class="keyword">if</span>(value == <span class="literal">null</span> || StringUtils.isBlank(value.toString()))&#123;</div><div class="line"><span class="keyword">continue</span>;</div><div class="line">&#125;</div><div class="line">String key = entry.getKey();</div><div class="line">String[] arr = key.split(<span class="string">":"</span>);</div><div class="line">Predicate predicate = getPredicate(arr,value,root,cb);</div><div class="line">list.add(predicate);</div><div class="line">&#125;</div><div class="line">    Predicate[] p = new Predicate[list.size()];  </div><div class="line">    <span class="keyword">return</span> cb.and(list.toArray(p));  </div><div class="line">&#125;</div><div class="line">&#125;;  </div><div class="line">Page&lt;T&gt; page = getDAO().findAll(spec, pageable);</div><div class="line"><span class="keyword">return</span> page;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">private</span> Predicate getPredicate(String[] arr, Object value,</div><div class="line">Root&lt;T&gt; root, CriteriaBuilder cb) &#123;</div><div class="line"><span class="keyword">if</span>(arr.length == <span class="number">1</span>)&#123;</div><div class="line"><span class="keyword">return</span> cb.equal(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(value.getClass()), value);  </div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(QueryTypeEnum.like.name().equals(arr[<span class="number">1</span>]))&#123;</div><div class="line"><span class="keyword">return</span> cb.like(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(String.<span class="keyword">class</span>), String.format(<span class="string">"%%%s%%"</span>, value));</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(QueryTypeEnum.ne.name().equals(arr[<span class="number">1</span>]))&#123;</div><div class="line"><span class="keyword">return</span> cb.notEqual(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(value.getClass()), value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(QueryTypeEnum.lt.name().equals(arr[<span class="number">1</span>]))&#123;</div><div class="line"><span class="keyword">return</span> getLessThanPredicate(arr,value,root,cb);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(QueryTypeEnum.lte.name().equals(arr[<span class="number">1</span>]))&#123;</div><div class="line"><span class="keyword">return</span> getLessThanOrEqualToPredicate(arr,value,root,cb);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(QueryTypeEnum.gt.name().equals(arr[<span class="number">1</span>]))&#123;</div><div class="line"><span class="keyword">return</span> getGreaterThanPredicate(arr,value,root,cb);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(QueryTypeEnum.gte.name().equals(arr[<span class="number">1</span>]))&#123;</div><div class="line"><span class="keyword">return</span> getGreaterThanOrEqualToPredicate(arr,value,root,cb);</div><div class="line">&#125;</div><div class="line"><span class="keyword">throw</span> new UnsupportedOperationException(String.format(<span class="string">"不支持的查询类型[%s]"</span>,arr[<span class="number">1</span>]));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> Predicate getLessThanPredicate(String[] arr, Object value,</div><div class="line">Root&lt;T&gt; root, CriteriaBuilder cb) &#123;</div><div class="line"><span class="keyword">if</span>(Integer.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Integer.<span class="keyword">class</span>), (int)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Long</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Long</span>.<span class="keyword">class</span>), (long)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Double</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Double</span>.<span class="keyword">class</span>), (double)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Float</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Float</span>.<span class="keyword">class</span>), (float)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(Timestamp.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Timestamp.<span class="keyword">class</span>), (Timestamp)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(Date.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Date.<span class="keyword">class</span>), (Date)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> cb.lessThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(String.<span class="keyword">class</span>), String.valueOf(value));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> Predicate getLessThanOrEqualToPredicate(String[] arr,</div><div class="line">Object value, Root&lt;T&gt; root, CriteriaBuilder cb) &#123;</div><div class="line"><span class="keyword">if</span>(Integer.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Integer.<span class="keyword">class</span>), (int)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Long</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Long</span>.<span class="keyword">class</span>), (long)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Double</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Double</span>.<span class="keyword">class</span>), (double)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Float</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Float</span>.<span class="keyword">class</span>), (float)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(Timestamp.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Timestamp.<span class="keyword">class</span>), (Timestamp)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(Date.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.lessThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Date.<span class="keyword">class</span>), (Date)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> cb.lessThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(String.<span class="keyword">class</span>), String.valueOf(value));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> Predicate getGreaterThanPredicate(String[] arr,</div><div class="line">Object value, Root&lt;T&gt; root, CriteriaBuilder cb) &#123;</div><div class="line"><span class="keyword">if</span>(Integer.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Integer.<span class="keyword">class</span>), (int)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Long</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Long</span>.<span class="keyword">class</span>), (long)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Double</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Double</span>.<span class="keyword">class</span>), (double)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Float</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Float</span>.<span class="keyword">class</span>), (float)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(Timestamp.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Timestamp.<span class="keyword">class</span>), (Timestamp)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(Date.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Date.<span class="keyword">class</span>), (Date)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> cb.greaterThan(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(String.<span class="keyword">class</span>), String.valueOf(value));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> Predicate getGreaterThanOrEqualToPredicate(String[] arr,Object value,</div><div class="line">Root&lt;T&gt; root, CriteriaBuilder cb) &#123;</div><div class="line"><span class="keyword">if</span>(Integer.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Integer.<span class="keyword">class</span>), (int)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Long</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Long</span>.<span class="keyword">class</span>), (long)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Double</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Double</span>.<span class="keyword">class</span>), (double)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(<span class="built_in">Float</span>.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(<span class="built_in">Float</span>.<span class="keyword">class</span>), (float)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(Timestamp.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Timestamp.<span class="keyword">class</span>), (Timestamp)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(Date.<span class="keyword">class</span> == value.getClass())&#123;</div><div class="line"><span class="keyword">return</span> cb.greaterThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(Date.<span class="keyword">class</span>), (Date)value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> cb.lessThanOrEqualTo(root.<span class="keyword">get</span>(arr[<span class="number">0</span>]).<span class="keyword">as</span>(String.<span class="keyword">class</span>), String.valueOf(value));</div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="meta">@ApiModel(value=<span class="meta-string">"查询条件支持的过滤方式"</span>)</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> QueryTypeEnum &#123;</div><div class="line">like,</div><div class="line">equal,</div><div class="line">ne,</div><div class="line">lt,</div><div class="line">lte,</div><div class="line">gt,</div><div class="line">gte</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//使用示例</span></div><div class="line">Map&lt;String, Object&gt; params = Maps.newHashMap();</div><div class="line">params.put(<span class="string">"type"</span>, type);</div><div class="line">params.put(<span class="string">"status"</span>, status);</div><div class="line">params.put(<span class="string">"username:like"</span>, username);</div><div class="line">params.put(<span class="string">"name:like"</span>, name);</div><div class="line">Page&lt;User&gt; rs = <span class="keyword">this</span>.userService.list(params, new PageRequest(page, size, new Sort(Direction.DESC, <span class="string">"updateTime"</span>)));</div><div class="line"></div></pre></td></tr></table></figure><br>提前公共list方法，查询条件在map内设置，查询条件在key内设置，这样大部分的查询请求就可以不再关注Specification的语法，不用写那一大段的复杂代码了</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ol><li>配置JPA很简单，添加maven依赖，配置数据库连接信息，dao继承上层类即可在service内注入dao，进行crud等操作</li><li>JPA提供了简便的根据方法名称进行查询的方式，使用难度很低</li><li>JPA通过@Query注解，支持类HQL语句查询；也可以使用原生SQL查询，只需要将nativeQuery属性设置为true即可</li><li>无条件分页查询可通过自带的findAll方法即可</li><li>多条件分页查询，有两种实现方式，当每个条件都是必选时，可使用@query带分页条件来实现；当有可选条件时，需要使用Specification来实现</li><li>为了简化常见的多个可选条件分页查询的代码，在service层提供了一个上层方法，以map的方式设置查询条件，大部分情况下不需要程序员再关注Specification的语法，降低使用难度</li></ol><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;公司的项目中很大一部分属于内部平台，所以对性能的要求没有那么高，开发速度反而更重要，因此在搭建基础框架时选择使用JPA，没有使用mybitis，当然其中也有一部分原因是之前一直使用hibernate，对mybitis不太熟悉^_^。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="JPA" scheme="http://www.onecoderspace.com/tags/JPA/"/>
    
  </entry>
  
  <entry>
    <title>git最简教程</title>
    <link href="http://www.onecoderspace.com/2017/10/03/git-simple/"/>
    <id>http://www.onecoderspace.com/2017/10/03/git-simple/</id>
    <published>2017-10-03T03:11:35.000Z</published>
    <updated>2017-10-03T13:50:24.000Z</updated>
    
    <content type="html"><![CDATA[<p>git新手，最近上传个项目，下载个项目老是忘记命令，在这写一下最常用的几个命令。<br><a id="more"></a></p><ol><li>本地新建文件夹，如rest-base</li><li>cd rest-base</li><li>git init  //初始化仓库</li><li>git remote add origin git@github.com:q7322068/rest-base.git  //连接远程仓库，需要在github内创建ssh公钥，配置方式参考<a href="http://blog.csdn.net/fenghuibian/article/details/73350890" target="_blank" rel="external">GitHub添加公钥</a></li><li>如果配置远程仓库的地址错误，可以使用git remote rm origin</li><li>git pull origin master  //从远程库同步项目，如果远程项目和本地有冲突，可以在后面添加 –allow-unrelated-histories实现</li><li>git add .  //本地有修改，用该命令添加至暂存区</li><li>git commit -m ‘msg’  //将修改提交至本地git仓库</li><li>git push origin master  //将本地修改提交至远程仓库</li></ol><p>深入学习建议看<a href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000" target="_blank" rel="external">廖雪峰Git教程</a>.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;git新手，最近上传个项目，下载个项目老是忘记命令，在这写一下最常用的几个命令。&lt;br&gt;
    
    </summary>
    
    
      <category term="git" scheme="http://www.onecoderspace.com/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>spring-boot项目实战：shiro</title>
    <link href="http://www.onecoderspace.com/2017/10/02/spring-boot-shiro/"/>
    <id>http://www.onecoderspace.com/2017/10/02/spring-boot-shiro/</id>
    <published>2017-10-02T05:31:52.000Z</published>
    <updated>2017-10-04T11:42:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>有很长一段时间都觉得自己添加个filter，基于RBAC模型，就能很轻松的实现权限控制，没必要引入shiro，spring-security这样的框架增加系统的复杂度。事实上也的确这样，如果你的需求仅仅是控制用户能否访问某个url，使用框架和自己实现filter效果基本一致，区别在于使用shiro和spring-security能够提供更多的扩展，集成了很多实用的功能，整体结构更加规范。<br><a id="more"></a><br>shiro和spring-security有哪些更多功能，这里不再展开，感兴趣的同学可以自行百度，我们这里以shiro为例，讲述spring-boot项目如何整合shiro实现权限控制。  </p><h3 id="1、添加maven依赖"><a href="#1、添加maven依赖" class="headerlink" title="1、添加maven依赖"></a>1、添加maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">&lt;!--shiro-core --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="comment">&lt;!-- 整合ehcache，减少数据库查询次数 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure><h3 id="2、添加shiro配置"><a href="#2、添加shiro配置" class="headerlink" title="2、添加shiro配置"></a>2、添加shiro配置</h3><p>创建ShiroConfigration.java<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@Configuration</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfigration</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final Logger logger = LoggerFactory.getLogger(ShiroConfigration.class);</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="type">LinkedHashMap</span>&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt;();</div><div class="line"></div><div class="line"></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> SimpleCookie rememberMeCookie() &#123;</div><div class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> <span class="type">SimpleCookie</span>(<span class="string">"rememberMe"</span>);</div><div class="line">        simpleCookie.setMaxAge(<span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>);<span class="comment">//保存10天</span></div><div class="line">        <span class="keyword">return</span> simpleCookie;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cookie管理对象;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> CookieRememberMeManager rememberMeManager() &#123;</div><div class="line">        logger.debug(<span class="string">"ShiroConfiguration.rememberMeManager()"</span>);</div><div class="line">        CookieRememberMeManager cookieRememberMeManager = <span class="keyword">new</span> <span class="type">CookieRememberMeManager</span>();</div><div class="line">        cookieRememberMeManager.setCookie(rememberMeCookie());</div><div class="line">        cookieRememberMeManager.setCipherKey(Base64.decode(<span class="string">"kPv59vyqzj00x11LXJZTjJ2UHW48jzHN"</span>));</div><div class="line">        <span class="keyword">return</span> cookieRememberMeManager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    @Bean(name = <span class="string">"lifecycleBeanPostProcessor"</span>)</div><div class="line">    <span class="keyword">public</span> LifecycleBeanPostProcessor getLifecycleBeanPostProcessor() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">LifecycleBeanPostProcessor</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> FilterRegistrationBean filterRegistrationBean() &#123;</div><div class="line">        FilterRegistrationBean filterRegistration = <span class="keyword">new</span> <span class="type">FilterRegistrationBean</span>();</div><div class="line">        DelegatingFilterProxy proxy = <span class="keyword">new</span> <span class="type">DelegatingFilterProxy</span>(<span class="string">"shiroFilter"</span>);</div><div class="line">        <span class="comment">//  该值缺省为false,表示生命周期由SpringApplicationContext管理,设置为true则表示由ServletContainer管理</span></div><div class="line">        proxy.setTargetFilterLifecycle(<span class="literal">true</span>);</div><div class="line">        filterRegistration.setFilter(proxy);</div><div class="line"></div><div class="line">        filterRegistration.setEnabled(<span class="literal">true</span>);</div><div class="line">        <span class="comment">//filterRegistration.addUrlPatterns("/*");// 可以自己灵活的定义很多，避免一些根本不需要被Shiro处理的请求被包含进来</span></div><div class="line">        <span class="keyword">return</span> filterRegistration;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> MyShiroRealm myShiroRealm() &#123;</div><div class="line">        MyShiroRealm myShiroRealm = <span class="keyword">new</span> <span class="type">MyShiroRealm</span>();</div><div class="line">        <span class="keyword">return</span> myShiroRealm;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    @Bean(name=<span class="string">"securityManager"</span>)  </div><div class="line">    <span class="keyword">public</span> DefaultWebSecurityManager securityManager() &#123;  </div><div class="line">        DefaultWebSecurityManager manager = <span class="keyword">new</span> <span class="type">DefaultWebSecurityManager</span>();  </div><div class="line">        manager.setRealm(myShiroRealm()); </div><div class="line">        manager.setRememberMeManager(rememberMeManager());</div><div class="line">        manager.setCacheManager(ehCacheManager());  </div><div class="line">        <span class="keyword">return</span> manager;  </div><div class="line">    &#125;  </div><div class="line">    </div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ShiroFilterFactoryBean 处理拦截资源文件问题。</span></div><div class="line"><span class="comment">     * 注意：单独一个ShiroFilterFactoryBean配置是或报错的，以为在</span></div><div class="line"><span class="comment">     * 初始化ShiroFilterFactoryBean的时候需要注入：SecurityManager</span></div><div class="line"><span class="comment">     * &lt;p&gt;</span></div><div class="line"><span class="comment">     * Filter Chain定义说明</span></div><div class="line"><span class="comment">     * 1、一个URL可以配置多个Filter，使用逗号分隔</span></div><div class="line"><span class="comment">     * 2、当设置多个过滤器时，全部验证通过，才视为通过</span></div><div class="line"><span class="comment">     * 3、部分过滤器可指定参数，如perms，roles</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    @Bean(name = <span class="string">"shiroFilter"</span>)</div><div class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean getShiroFilterFactoryBean() &#123;</div><div class="line">        logger.debug(<span class="string">"ShiroConfigration.getShiroFilterFactoryBean()"</span>);</div><div class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> <span class="type">ShiroFilterFactoryBean</span>();</div><div class="line">        <span class="comment">// 必须设置 SecurityManager</span></div><div class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager());</div><div class="line">        </div><div class="line">        HashMap&lt;<span class="keyword">String</span>, javax.servlet.Filter&gt; loginFilter = <span class="keyword">new</span> <span class="type">HashMap</span>&lt;&gt;();</div><div class="line">        loginFilter.put(<span class="string">"loginFilter"</span>, <span class="keyword">new</span> <span class="type">LoginFilter</span>());</div><div class="line">        shiroFilterFactoryBean.setFilters(loginFilter);</div><div class="line"></div><div class="line"></div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/login/submit"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/logout"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/img/**"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/js/**"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/css/**"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/test/**"</span>, <span class="string">"anon"</span>);</div><div class="line">        </div><div class="line">        <span class="comment">// 如果不设置默认会自动寻找Web工程根目录下的"/login.jsp"页面</span></div><div class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">"/login"</span>);</div><div class="line"></div><div class="line">        <span class="comment">//配置记住我或认证通过可以访问的地址</span></div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/"</span>, <span class="string">"user"</span>);</div><div class="line">        <span class="comment">//未授权界面;</span></div><div class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">"/unauth"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/**"</span>, <span class="string">"loginFilter"</span>);</div><div class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</div><div class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * shiro缓存管理器;</span></div><div class="line"><span class="comment">     * 需要注入对应的其它的实体类中：</span></div><div class="line"><span class="comment">     * 1、安全管理器：securityManager</span></div><div class="line"><span class="comment">     * 可见securityManager是整个shiro的核心；</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * @return</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> EhCacheManager ehCacheManager() &#123;</div><div class="line">        EhCacheManager cacheManager = <span class="keyword">new</span> <span class="type">EhCacheManager</span>();</div><div class="line">        cacheManager.setCacheManagerConfigFile(<span class="string">"classpath:ehcache-shiro.xml"</span>);</div><div class="line">        <span class="keyword">return</span> cacheManager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(DefaultWebSecurityManager securityManager) &#123;</div><div class="line">        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = <span class="keyword">new</span> <span class="type">AuthorizationAttributeSourceAdvisor</span>();</div><div class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</div><div class="line">        <span class="keyword">return</span> authorizationAttributeSourceAdvisor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p><p>shiroFilter是配置的重点，</p><ul><li>anon表示允许匿名访问</li><li>shiroFilterFactoryBean.setFilters(loginFilter)来设置自定义的过滤器，如本处设置了LoginFilter用于添加登录拦截</li><li>filterChainDefinitionMap.put(“/**”, “loginFilter”);用于指定loginFilter的作用范围</li></ul><h3 id="3、添加自定义realm"><a href="#3、添加自定义realm" class="headerlink" title="3、添加自定义realm"></a>3、添加自定义realm</h3><p>创建类MyShiroRealm.java<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyShiroRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">Logger</span> logger = <span class="type">LoggerFactory</span>.getLogger(<span class="type">MyShiroRealm</span>.<span class="keyword">class</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> <span class="type">UserService</span> userService;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> <span class="type">UserRoleService</span> userRoleService;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> <span class="type">RoleService</span> roleService;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> <span class="type">RolePermissionService</span> rolePermissionService;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="type">AuthenticationInfo</span> doGetAuthenticationInfo(<span class="type">AuthenticationToken</span> token) <span class="keyword">throws</span> <span class="type">AuthenticationException</span> &#123;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//获取用户的输入的账号.</span></div><div class="line">        <span class="type">String</span> idObj = (<span class="type">String</span>) token.getPrincipal();</div><div class="line">        <span class="type">Integer</span> id = <span class="type">NumberUtils</span>.toInt(idObj);</div><div class="line">        <span class="type">User</span> user = userService.findById(id);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="comment">// 返回null的话，就会导致任何用户访问被拦截的请求时，都会自动跳转到unauthorizedUrl指定的地址</span></div><div class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="type">SimpleAuthenticationInfo</span> authenticationInfo = <span class="keyword">new</span> <span class="type">SimpleAuthenticationInfo</span>(user.getId(),</div><div class="line">                user.getPwd(), getName());</div><div class="line"></div><div class="line">        <span class="keyword">return</span> authenticationInfo;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="type">AuthorizationInfo</span> doGetAuthorizationInfo(<span class="type">PrincipalCollection</span> principals) &#123;</div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment"> * 当没有使用缓存的时候，不断刷新页面的话，这个代码会不断执行，</span></div><div class="line"><span class="comment"> * 当其实没有必要每次都重新设置权限信息，所以我们需要放到缓存中进行管理；</span></div><div class="line"><span class="comment"> * 当放到缓存中时，这样的话，doGetAuthorizationInfo就只会执行一次了，</span></div><div class="line"><span class="comment"> * 缓存过期之后会再次执行。</span></div><div class="line"><span class="comment"> */</span></div><div class="line">        logger.debug(<span class="string">"权限配置--&gt;MyShiroRealm.doGetAuthorizationInfo()"</span>);</div><div class="line"></div><div class="line">        <span class="type">SimpleAuthorizationInfo</span> authorizationInfo = <span class="keyword">new</span> <span class="type">SimpleAuthorizationInfo</span>();</div><div class="line">        authorizationInfo.addRole(<span class="string">"ACTUATOR"</span>);</div><div class="line"></div><div class="line">        <span class="type">Integer</span> userId = <span class="type">Integer</span>.parseInt(principals.getPrimaryPrincipal().toString());</div><div class="line">        <span class="comment">//实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span></div><div class="line"></div><div class="line">        <span class="type">Set</span>&lt;<span class="type">Integer</span>&gt; roleIds = userRoleService.findRoleIds(userId);</div><div class="line">        <span class="type">Set</span>&lt;<span class="type">Role</span>&gt; roles = roleService.findByIds(roleIds);</div><div class="line">        <span class="keyword">for</span>(<span class="type">Role</span> role : roles)&#123;</div><div class="line">        authorizationInfo.addRole(role.getCode());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//设置权限信息.</span></div><div class="line">        <span class="type">List</span>&lt;<span class="type">Permission</span>&gt; permissions = rolePermissionService.getPermissions(roleIds);</div><div class="line">        <span class="type">Set</span>&lt;<span class="type">String</span>&gt; set = <span class="keyword">new</span> <span class="type">HashSet</span>&lt;<span class="type">String</span>&gt;(permissions.size()*<span class="number">2</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="type">Permission</span> permission : permissions)&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="type">StringUtils</span>.isNotBlank(permission.getCode()))&#123;</div><div class="line">        set.add(permission.getCode());</div><div class="line">        &#125;</div><div class="line">        &#125;</div><div class="line">        authorizationInfo.setStringPermissions(set);</div><div class="line">        <span class="keyword">return</span> authorizationInfo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p><ul><li>doGetAuthenticationInfo用于验证用户账号信息，可根据具体业务来调整认证策略</li><li>doGetAuthorizationInfo用于获取用户拥有的角色和权限</li></ul><p>4、创建登录拦截器<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">Subject currentUser = SecurityUtils.getSubject();</div><div class="line"><span class="keyword">if</span> (!currentUser.isAuthenticated()) &#123;</div><div class="line">HttpServletRequest req = (HttpServletRequest) request;</div><div class="line">HttpServletResponse res = (HttpServletResponse) response;</div><div class="line">AjaxResponseWriter.write(req, res, ServiceStatusEnum.UNLOGIN, <span class="string">"请登录"</span>);</div><div class="line"><span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line">chain.doFilter(request, response);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AjaxResponseWriter</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 写回数据到前端</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> request</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> response</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> status &#123;<span class="doctag">@link</span> ServiceStatusEnum&#125; </span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> message 返回的描述信息</span></div><div class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(HttpServletRequest request,HttpServletResponse response,ServiceStatusEnum status,String message)</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">String contentType = <span class="string">"application/json"</span>;</div><div class="line">response.setContentType(contentType);</div><div class="line">response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">response.setHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</div><div class="line">response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>,request.getHeader(<span class="string">"Origin"</span>));</div><div class="line"></div><div class="line">Map&lt;String, String&gt; map = Maps.newLinkedHashMap();</div><div class="line">map.put(<span class="string">"code"</span>, status.code);</div><div class="line">map.put(<span class="string">"msg"</span>, message);</div><div class="line">String result = JacksonHelper.toJson(map);</div><div class="line">PrintWriter out = response.getWriter();</div><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">out.print(result);</div><div class="line">out.flush();</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">out.close();</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 全局性状态码</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ServiceStatusEnum &#123;</div><div class="line">UNLOGIN(<span class="string">"0001"</span>), <span class="comment">//未登录</span></div><div class="line">ILLEGAL_TOKEN(<span class="string">"0002"</span>),<span class="comment">//非法的token</span></div><div class="line">;</div><div class="line"><span class="keyword">public</span> String code;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">ServiceStatusEnum</span><span class="params">(String code)</span></span>&#123;</div><div class="line"><span class="keyword">this</span>.code = code;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p><ul><li>用户登录状态拦截器，不允许匿名访问的url会经过该filter，如果未登录，则返回未登录提示（未登录处理可根据具体业务进行调整）</li></ul><h3 id="5、添加登录、退出功能"><a href="#5、添加登录、退出功能" class="headerlink" title="5、添加登录、退出功能"></a>5、添加登录、退出功能</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@Api(value=<span class="string">"用户登录"</span>,tags=&#123;<span class="string">"用户登录"</span>&#125;)</div><div class="line">@RestController</div><div class="line"><span class="keyword">public</span> class LoginController &#123;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(LoginController.class);</div><div class="line"></div><div class="line">@Value(<span class="string">"$&#123;server.session.timeout&#125;"</span>)</div><div class="line"><span class="keyword">private</span> <span class="keyword">String</span> serverSessionTimeout;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 用户登录接口 通过用户名和密码进行登录</span></div><div class="line"><span class="comment"> */</span></div><div class="line">@ApiOperation(value = <span class="string">"用户登录接口 通过用户名和密码进行登录"</span>, notes = <span class="string">"用户登录接口 通过用户名和密码进行登录"</span>)</div><div class="line">@ApiImplicitParams(&#123;</div><div class="line">@ApiImplicitParam(paramType = <span class="string">"query"</span>, name = <span class="string">"username"</span>, value = <span class="string">"用户名"</span>, required = true, dataType = <span class="string">"String"</span>),</div><div class="line">@ApiImplicitParam(paramType = <span class="string">"query"</span>, name = <span class="string">"pwd"</span>, value = <span class="string">"密码"</span>, required = true, dataType = <span class="string">"String"</span>),</div><div class="line">@ApiImplicitParam(paramType = <span class="string">"query"</span>, name = <span class="string">"autoLogin"</span>, value = <span class="string">"自动登录"</span>, required = true, dataType = <span class="string">"boolean"</span>)&#125;)</div><div class="line">@RequestMapping(value = <span class="string">"/login/submit"</span>,method=&#123;RequestMethod.GET,RequestMethod.POST&#125;)</div><div class="line"><span class="keyword">public</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; subm(HttpServletRequest request,HttpServletResponse response,</div><div class="line"><span class="keyword">String</span> username,<span class="keyword">String</span> pwd,@RequestParam(value = <span class="string">"autoLogin"</span>, defaultValue = <span class="string">"false"</span>) <span class="keyword">boolean</span> autoLogin) &#123;</div><div class="line">Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span> = Maps.newLinkedHashMap();</div><div class="line">Subject currentUser = SecurityUtils.getSubject();</div><div class="line">User user = userService.findByUsername(username);</div><div class="line"><span class="built_in">if</span> (user == null) &#123;</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"-1"</span>);</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"账号不存在"</span>);</div><div class="line"><span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">&#125;</div><div class="line"><span class="built_in">if</span> (user.getEnable() == <span class="number">0</span>) &#123; <span class="comment">//账号被禁用</span></div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"-1"</span>);</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"账号已被禁用"</span>);</div><div class="line"><span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">String</span> salt = user.getSalt();</div><div class="line">UsernamePasswordToken token = null;</div><div class="line">Integer userId = user.getId();</div><div class="line">token = <span class="keyword">new</span> UsernamePasswordToken(userId.toString(),SaltMD5Util.encode(pwd, salt));</div><div class="line">token.setRememberMe(autoLogin);</div><div class="line"></div><div class="line">loginValid(<span class="built_in">map</span>, currentUser, token);</div><div class="line"></div><div class="line"><span class="comment">// 验证是否登录成功</span></div><div class="line"><span class="built_in">if</span> (currentUser.isAuthenticated()) &#123;</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>,<span class="string">"1"</span>);</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"ok"</span>);</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"id"</span>, <span class="keyword">String</span>.valueOf(userId));</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"username"</span>, user.getUsername());</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"name"</span>, user.getName());</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"compnay_id"</span>, <span class="keyword">String</span>.valueOf(user.getCompanyId()));</div><div class="line"><span class="keyword">String</span> uuidToken = UUID.randomUUID().toString();</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"token"</span>, uuidToken);</div><div class="line"></div><div class="line">currentUser.getSession().<span class="built_in">setTimeout</span>(NumberUtils.toLong(serverSessionTimeout, <span class="number">1800</span>)*<span class="number">1000</span>);</div><div class="line">request.getSession().setAttribute(<span class="string">"token"</span>,uuidToken );</div><div class="line">&#125; <span class="built_in">else</span> &#123;</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"-1"</span>);</div><div class="line">token.<span class="built_in">clear</span>();</div><div class="line">&#125;</div><div class="line"><span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@RequestMapping(value=<span class="string">"logout"</span>,method=RequestMethod.GET)</div><div class="line">    <span class="keyword">public</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; logout() &#123;</div><div class="line">        Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span> = Maps.newLinkedHashMap();</div><div class="line">        Subject currentUser = SecurityUtils.getSubject();</div><div class="line">        currentUser.logout();</div><div class="line">        <span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"logout"</span>);</div><div class="line">        <span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">@RequestMapping(value=<span class="string">"unauth"</span>,method=RequestMethod.GET)</div><div class="line">    <span class="keyword">public</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; unauth() &#123;</div><div class="line">        Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span> = Maps.newLinkedHashMap();</div><div class="line">        <span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"403"</span>);</div><div class="line">        <span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"msg"</span>, <span class="string">"你没有访问权限"</span>);</div><div class="line">        <span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> loginValid(Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span>,Subject currentUser, UsernamePasswordToken token) &#123;</div><div class="line"><span class="keyword">String</span> username = null;</div><div class="line"><span class="built_in">if</span> (token != null) &#123;</div><div class="line">username = (<span class="keyword">String</span>) token.getPrincipal();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">try</span> &#123;</div><div class="line"><span class="comment">// 在调用了login方法后,SecurityManager会收到AuthenticationToken,并将其发送给已配置的Realm执行必须的认证检查</span></div><div class="line"><span class="comment">// 每个Realm都能在必要时对提交的AuthenticationTokens作出反应</span></div><div class="line"><span class="comment">// 所以这一步在调用login(token)方法时,它会走到MyRealm.doGetAuthenticationInfo()方法中,具体验证方式详见此方法</span></div><div class="line">currentUser.login(token);</div><div class="line"><span class="built_in">return</span> true;</div><div class="line">&#125; <span class="built_in">catch</span> (UnknownAccountException | IncorrectCredentialsException ex) &#123;</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"账号或密码错误"</span>);</div><div class="line">&#125; <span class="built_in">catch</span> (LockedAccountException lae) &#123;</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>,<span class="string">"账户已锁定"</span>);</div><div class="line">&#125; <span class="built_in">catch</span> (ExcessiveAttemptsException eae) &#123;</div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"错误次数过多"</span>);</div><div class="line">&#125; <span class="built_in">catch</span> (AuthenticationException ae) &#123;</div><div class="line"><span class="comment">// 通过处理Shiro的运行时AuthenticationException就可以控制用户登录失败或密码错误时的情景</span></div><div class="line"><span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"登录失败"</span>);</div><div class="line">logger.warn(<span class="keyword">String</span>.format(<span class="string">"对用户[%s]进行登录验证..验证未通过"</span>, username),ae);</div><div class="line">&#125;</div><div class="line"><span class="built_in">return</span> false;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Autowired</div><div class="line"><span class="keyword">private</span> UserService userService;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure><ul><li>以上代码是比较通用的登录、退出功能，如果没有特殊需求，可直接使用上述功能</li></ul><h3 id="6、在接口上添加权限限制"><a href="#6、在接口上添加权限限制" class="headerlink" title="6、在接口上添加权限限制"></a>6、在接口上添加权限限制</h3><p>以UserController为例：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@ApiOperation(value=<span class="meta-string">"获取用户详细信息"</span>, notes=<span class="meta-string">"根据ID查找用户"</span>)</span></div><div class="line">   <span class="meta">@ApiImplicitParam(paramType=<span class="meta-string">"query"</span>,name = <span class="meta-string">"id"</span>, value = <span class="meta-string">"用户ID"</span>, required = true,dataType=<span class="meta-string">"int"</span>)</span></div><div class="line"><span class="meta">@RequiresPermissions(value=&#123;<span class="meta-string">"user:get"</span>&#125;)</span> </div><div class="line"><span class="meta">@RequestMapping(value=<span class="meta-string">"/get"</span>,method=RequestMethod.GET)</span></div><div class="line"><span class="keyword">public</span> User <span class="keyword">get</span>(int id)&#123;</div><div class="line">User entity = userService.findById(id);</div><div class="line">entity.setPwd(<span class="literal">null</span>);</div><div class="line">entity.setSalt(<span class="literal">null</span>);</div><div class="line"><span class="keyword">return</span> entity;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@ApiOperation(value=<span class="meta-string">"修改密码"</span>, notes=<span class="meta-string">"修改密码"</span>)</span></div><div class="line"><span class="meta">@ApiImplicitParams(&#123;</span></div><div class="line"><span class="meta">@ApiImplicitParam(paramType = <span class="meta-string">"query"</span>, name = <span class="meta-string">"oldPwd"</span>, value = <span class="meta-string">"旧密码"</span>, required = true, dataType = <span class="meta-string">"String"</span>)</span>,</div><div class="line"><span class="meta">@ApiImplicitParam(paramType = <span class="meta-string">"query"</span>, name = <span class="meta-string">"pwd"</span>, value = <span class="meta-string">"新密码"</span>, required = true, dataType = <span class="meta-string">"String"</span>)</span>,</div><div class="line"><span class="meta">@ApiImplicitParam(paramType = <span class="meta-string">"query"</span>, name = <span class="meta-string">"confirmPwd"</span>, value = <span class="meta-string">"新密码(确认)"</span>, required = true, dataType = <span class="meta-string">"String"</span>)</span>&#125;)</div><div class="line"><span class="meta">@RequiresPermissions(value=&#123;<span class="meta-string">"user:reset-pwd"</span>&#125;)</span></div><div class="line"><span class="meta">@RequestMapping(value=<span class="meta-string">"/reset-pwd"</span>,method=RequestMethod.POST)</span></div><div class="line"><span class="keyword">public</span> Return resetPwd(String oldPwd,String pwd,String confirmPwd)&#123;</div><div class="line"><span class="keyword">if</span>(StringUtils.isBlank(oldPwd) || StringUtils.isBlank(pwd)</div><div class="line">|| StringUtils.isBlank(confirmPwd) || !pwd.equals(confirmPwd)) &#123;</div><div class="line"><span class="keyword">return</span> Return.fail(<span class="string">"非法参数"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">Subject currentUser = SecurityUtils.getSubject();</div><div class="line">Integer userId=(Integer) currentUser.getPrincipal();</div><div class="line">User entity = userService.findById(userId);</div><div class="line"><span class="keyword">if</span>(!entity.getPwd().equals(SaltMD5Util.encode(oldPwd, entity.getSalt())))&#123;</div><div class="line"><span class="keyword">return</span> Return.fail(<span class="string">"原始密码错误"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> userService.changePwd(entity,pwd);</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p><ul><li>@RequiresPermissions 和 @RequiresRoles分别用于限制该方法可访问的权限和角色，两者如果同时使用，默认是“&amp;”关系；两者的value参数都可以设置为数组，数组元素间的关系可以通过logical属性来设置，有Logical.AND，Logical.OR两个值可选择</li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>spring-boot整合shiro的步骤如下：</p><ol><li>添加maven依赖</li><li>添加ShiroConfigration配置，指定shiro的核心配置</li><li>添加MyShiroRealm，指定账户认证策略和角色权限获取方式</li><li>添加LoginFilter，即登录拦截器</li><li>添加登录、退出功能</li><li>通过注解添加接口调用权限限制</li></ol><p>权限控制基于RBAC模型，涉及的表有：用户（user)、角色（role）、用户角色关系（user_role）、权限（permission）、角色权限关系（role_permission），具体代码可参考github内的示例项目。  </p><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;有很长一段时间都觉得自己添加个filter，基于RBAC模型，就能很轻松的实现权限控制，没必要引入shiro，spring-security这样的框架增加系统的复杂度。事实上也的确这样，如果你的需求仅仅是控制用户能否访问某个url，使用框架和自己实现filter效果基本一致，区别在于使用shiro和spring-security能够提供更多的扩展，集成了很多实用的功能，整体结构更加规范。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="权限控制" scheme="http://www.onecoderspace.com/tags/%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/"/>
    
      <category term="shiro" scheme="http://www.onecoderspace.com/tags/shiro/"/>
    
  </entry>
  
  <entry>
    <title>spring boot项目实战：redis</title>
    <link href="http://www.onecoderspace.com/2017/10/01/spring-boot-redis/"/>
    <id>http://www.onecoderspace.com/2017/10/01/spring-boot-redis/</id>
    <published>2017-10-01T10:47:10.000Z</published>
    <updated>2017-10-01T12:38:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>缓存是提升服务性能的一个重要手段，而redis是分布式缓存中的佼佼者，性能优异，官方提供哨兵机制保证高可用，也支持集群方式，保证对大数据量的支持，项目内引入redis还是很有帮助的。<br><a id="more"></a></p><h4 id="1、-添加maven依赖"><a href="#1、-添加maven依赖" class="headerlink" title="1、 添加maven依赖"></a>1、 添加maven依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- redis --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>    <h4 id="2、-添加redis配置"><a href="#2、-添加redis配置" class="headerlink" title="2、 添加redis配置"></a>2、 添加redis配置</h4><h5 id="本地（单点redis）"><a href="#本地（单点redis）" class="headerlink" title="本地（单点redis）"></a>本地（单点redis）</h5><p>在application-local.properties（本地配置）内添加redis配置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###redis配置###</span></div><div class="line">spring.redis.<span class="attribute">host</span>=127.0.0.1    </div><div class="line">spring.redis.<span class="attribute">port</span>=7001  </div><div class="line">spring.redis.<span class="attribute">database</span>=0</div><div class="line">spring.redis.<span class="attribute">password</span>=pwd</div><div class="line"></div><div class="line"><span class="comment"># pool settings ...池配置    </span></div><div class="line">spring.redis.pool.<span class="attribute">max-idle</span>=4</div><div class="line">spring.redis.pool.<span class="attribute">min-idle</span>=1</div><div class="line">spring.redis.pool.<span class="attribute">max-active</span>=4</div><div class="line">spring.redis.pool.<span class="attribute">max-wait</span>=2000</div></pre></td></tr></table></figure><br>如果本地redis没有密码，删除spring.redis.password这行就可以了。</p><h5 id="测试-amp-正式环境（哨兵）"><a href="#测试-amp-正式环境（哨兵）" class="headerlink" title="测试&amp;正式环境（哨兵）"></a>测试&amp;正式环境（哨兵）</h5><p>在application-dev.properties（测试环境）和application-prod.properties（正式环境）内添加redis配置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">###redis配置###</span></div><div class="line">spring.redis.<span class="attribute">database</span>=0</div><div class="line">spring.redis.<span class="attribute">password</span>=pwd</div><div class="line">  </div><div class="line"><span class="comment"># pool settings ...池配置    </span></div><div class="line">spring.redis.pool.<span class="attribute">max-idle</span>=4</div><div class="line">spring.redis.pool.<span class="attribute">min-idle</span>=1</div><div class="line">spring.redis.pool.<span class="attribute">max-active</span>=4</div><div class="line">spring.redis.pool.<span class="attribute">max-wait</span>=2000</div><div class="line">  </div><div class="line"><span class="comment">#哨兵监听redis server名称  </span></div><div class="line">spring.redis.sentinel.<span class="attribute">master</span>=mymaster</div><div class="line"><span class="comment">#哨兵的配置列表  </span></div><div class="line">spring.redis.sentinel.<span class="attribute">nodes</span>=host:port,host2:port2</div></pre></td></tr></table></figure>    </p><h4 id="3、使用StringRedisTemplate进行操作"><a href="#3、使用StringRedisTemplate进行操作" class="headerlink" title="3、使用StringRedisTemplate进行操作"></a>3、使用StringRedisTemplate进行操作</h4><p>注入StringRedisTemplate：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="keyword">private</span> StringRedisTemplate redisTemplate;</div></pre></td></tr></table></figure><br>使用RedisTemplate进行操作：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//设置缓存，建议每个键都设置过期时间</span></div><div class="line">redisTemplate.opsForValue().<span class="keyword">set</span>(<span class="string">"test"</span>, <span class="string">"test"</span>, <span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line"><span class="comment">//获取缓存值</span></div><div class="line"><span class="built_in">String</span> value = redisTemplate.opsForValue().<span class="keyword">get</span>(<span class="string">"test"</span>);</div><div class="line"></div><div class="line"><span class="comment">//删除某个键</span></div><div class="line">redisTemplate.delete(<span class="string">"test"</span>);</div><div class="line"></div><div class="line"><span class="comment">//操作set</span></div><div class="line">redisTemplate.opsForSet().add(<span class="string">"testSet"</span>, <span class="string">"1"</span>);</div><div class="line"><span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; members = redisTemplate.opsForSet().members(<span class="string">"testSet"</span>);<span class="comment">//获取set内的所有值</span></div><div class="line">redisTemplate.opsForSet().remove(<span class="string">"testSet"</span>, <span class="string">"1"</span>,<span class="string">"2"</span>);<span class="comment">//移除set内的多个对象</span></div><div class="line"></div><div class="line"><span class="comment">//操作list</span></div><div class="line">redisTemplate.opsForList().rightPush(<span class="string">"testList"</span>, <span class="string">"1"</span>);</div><div class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; list = redisTemplate.opsForList().range(<span class="string">"testList"</span>, <span class="number">0</span>, <span class="number">-1</span>);<span class="comment">//获取list内的所有元素</span></div></pre></td></tr></table></figure><br>StringRedisTemplate对redis操作进行了很好的封装，为键、字符串、哈希、列表、集合、有序集合、HyperLogLog的操作提供了良好的支持。基本使用形式就是redisTemplate.opsForXXX,XXX是类型，opsForValue是操作字符串；opsForSet是操作集合，opsForList是操作列表，opsForZSet是操作有序集合，opsForHyperLogLog是操作HyperLogLog，基本上其方法和redis命令是对应的，可以根据名字和方法注释快速确定方法对应的redis命令。</p><h4 id="4、使用RedisTemplate进行操作"><a href="#4、使用RedisTemplate进行操作" class="headerlink" title="4、使用RedisTemplate进行操作"></a>4、使用RedisTemplate进行操作</h4><p>1、 创建RedisObjectSerializer.java<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.springframework.core.convert.converter.Converter;</div><div class="line"><span class="keyword">import</span> org.springframework.core.serializer.support.DeserializingConverter;</div><div class="line"><span class="keyword">import</span> org.springframework.core.serializer.support.SerializingConverter;</div><div class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;</div><div class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.SerializationException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisObjectSerializer</span> <span class="keyword">implements</span> <span class="title">RedisSerializer</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</div><div class="line"><span class="keyword">private</span> Converter&lt;Object, <span class="keyword">byte</span>[]&gt; serializer = <span class="keyword">new</span> SerializingConverter();</div><div class="line"><span class="keyword">private</span> Converter&lt;<span class="keyword">byte</span>[], Object&gt; deserializer = <span class="keyword">new</span> DeserializingConverter();</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] EMPTY_ARRAY = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function">Object <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (isEmpty(bytes)) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="function"><span class="keyword">return</span> deserializer.<span class="title">convert</span><span class="params">(bytes)</span></span>;</div><div class="line">&#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">"Cannot deserialize"</span>, ex);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(Object object) &#123;</div><div class="line"><span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</div><div class="line"><span class="keyword">return</span> EMPTY_ARRAY;</div><div class="line">&#125;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="function"><span class="keyword">return</span> serializer.<span class="title">convert</span><span class="params">(object)</span></span>;</div><div class="line">&#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line"><span class="keyword">return</span> EMPTY_ARRAY;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> (data == <span class="keyword">null</span> || data.length == <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>2、 配置redisTemplate<br>创建RedisConfig.java<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="meta">@Bean</span></div><div class="line">    public RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; redisTemplate(RedisConnectionFactory <span class="keyword">factory</span>) &#123;</div><div class="line">        RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; template = <span class="keyword">new</span> RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt;();</div><div class="line">        template.setConnectionFactory(<span class="keyword">factory</span>);</div><div class="line">        template.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</div><div class="line">        template.setValueSerializer(<span class="keyword">new</span> RedisObjectSerializer());</div><div class="line">        <span class="keyword">return</span> template;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>3、 使用RedisTemplate<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//注入RedisTemplate对象</div><div class="line">@Autowired</div><div class="line">private RedisTemplate<span class="variable">&lt;String, Object&gt;</span> objRedisTemplate;</div><div class="line"></div><div class="line">//使用RedisTemplate</div><div class="line">User <span class="keyword">user</span> = new User();</div><div class="line"><span class="keyword">user</span>.<span class="built_in">set</span>Id(<span class="number">1</span>);</div><div class="line"><span class="keyword">user</span>.<span class="built_in">set</span>Name(<span class="string">"test"</span>);</div><div class="line">objRedisTemplate.opsForValue().<span class="built_in">set</span>(<span class="string">"user"</span>, <span class="keyword">user</span>,<span class="number">10</span>,TimeUnit.SECONDS);</div><div class="line"><span class="keyword">user</span> = (User) objRedisTemplate.opsForValue().get(<span class="string">"user"</span>);</div></pre></td></tr></table></figure>        </p><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;缓存是提升服务性能的一个重要手段，而redis是分布式缓存中的佼佼者，性能优异，官方提供哨兵机制保证高可用，也支持集群方式，保证对大数据量的支持，项目内引入redis还是很有帮助的。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="redis" scheme="http://www.onecoderspace.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>spring-boot项目实战：共享session</title>
    <link href="http://www.onecoderspace.com/2017/10/01/spring-boot-spring-session/"/>
    <id>http://www.onecoderspace.com/2017/10/01/spring-boot-spring-session/</id>
    <published>2017-10-01T01:42:04.000Z</published>
    <updated>2017-10-04T11:41:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>在工作中会遇到以下几个场景：  </p><ol><li>发布新功能或修复bug，服务重启，用户需要重新登录  </li><li>当集群内某个节点失效时，用户明明刚登录，仍被提示需要重新登录<br>那如何做到服务发布、集群节点失效对用户无感知呢？有以下几种方式：  </li><li>使用cookie保存用户状态信息  </li><li>session同步法（多个web-server之间相互同步session）</li><li>后端统一存储（如：redis）<a id="more"></a> 关于这几种方法的优缺点这里不再展开，可参看阅读《<a href="http://mp.weixin.qq.com/s/NnnqVrC9-Jekwy3Opmvy_w" target="_blank" rel="external">session一致性架构设计实践</a>》,讲的很透彻，调理清晰。我们重点来看下如何通过后端统一存储来实现session共享，通过查找，发现了一个比较好的方案，spring-session，整合特别简单。<h3 id="1、在项目内引入redis"><a href="#1、在项目内引入redis" class="headerlink" title="1、在项目内引入redis"></a>1、在项目内引入redis</h3>参考我之前的一篇文档《<a href="http://www.jianshu.com/u/1182bf416662" target="_blank">spring boot项目实战：redis</a>》，这里不再展开。</li></ol><h3 id="2、添加maven依赖"><a href="#2、添加maven依赖" class="headerlink" title="2、添加maven依赖"></a>2、添加maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="3、添加java配置"><a href="#3、添加java配置" class="headerlink" title="3、添加java配置"></a>3、添加java配置</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="variable">@Configuration</span></div><div class="line">   <span class="variable">@EnableRedisHttpSession</span>(maxInactiveIntervalInSeconds=<span class="number">7200</span>,redisNamespace=<span class="string">"base"</span>)</div><div class="line">public class RedisSessionConfig &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>maxInactiveIntervalInSeconds用于设置session有效时间</li><li>redisNamespace用于区分不同的项目，如果多个项目共用用户数据，可以采用相同的值，这样就简单的实现了统一登录效果</li></ul><p>要提醒的一点是如果用户数据特别大，需要注意redis容量规范及数据库规范，尽量保证缓存键分类存储在不同的库内，如用户session数据存储在数据库1内，业务缓存存储在0内，以此类推。</p><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在工作中会遇到以下几个场景：  &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;发布新功能或修复bug，服务重启，用户需要重新登录  &lt;/li&gt;
&lt;li&gt;当集群内某个节点失效时，用户明明刚登录，仍被提示需要重新登录&lt;br&gt;那如何做到服务发布、集群节点失效对用户无感知呢？有以下几种方式：  &lt;/li&gt;
&lt;li&gt;使用cookie保存用户状态信息  &lt;/li&gt;
&lt;li&gt;session同步法（多个web-server之间相互同步session）&lt;/li&gt;
&lt;li&gt;后端统一存储（如：redis）
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="spring-session" scheme="http://www.onecoderspace.com/tags/spring-session/"/>
    
      <category term="共享session" scheme="http://www.onecoderspace.com/tags/%E5%85%B1%E4%BA%ABsession/"/>
    
  </entry>
  
  <entry>
    <title>spring boot项目实战：swagger2在线文档</title>
    <link href="http://www.onecoderspace.com/2017/10/01/spring-boot-swagger2/"/>
    <id>http://www.onecoderspace.com/2017/10/01/spring-boot-swagger2/</id>
    <published>2017-10-01T00:06:04.000Z</published>
    <updated>2017-10-01T12:38:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>对于接口服务来说接口文档极其重要，在团队配合和后续维护中占据重要角色。在工作中，使用过excel，wiki来进行接口文档的维护：<br><a id="more"></a></p><ul><li>wiki：缺点是维护起来工作量较大，费时较长，优点是体验较好、检索方便、支持多人协作、支持历史版本查看；  </li><li>excel：初始整理时还好，但在后续多人协作新增功能或调整接口时，维护接口文档就变得极不方便  </li></ul><p>然后了解到swagger2，可以以编程的方式方便的生成在线文档，这样在接口调整时，能够及时的变更接口文档，使接口文档的准确性更高，下面来看下如何在spring boot项目内整合swagger2.</p><h3 id="配置swagger2"><a href="#配置swagger2" class="headerlink" title="配置swagger2"></a>配置swagger2</h3><p><strong>1、 添加依赖</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- swagger2 --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><br><strong>2、 添加基本配置</strong><br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@Configuration</span></div><div class="line"><span class="variable">@EnableSwagger2</span></div><div class="line">public class Swagger2 &#123;</div><div class="line"></div><div class="line"><span class="variable">@Bean</span></div><div class="line">public Docket createRestApi() &#123;</div><div class="line"><span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">Docket</span>(DocumentationType.SWAGGER_2)</div><div class="line"><span class="selector-class">.apiInfo</span>(apiInfo())</div><div class="line"><span class="selector-class">.select</span>()</div><div class="line"><span class="selector-class">.apis</span>(RequestHandlerSelectors</div><div class="line">.basePackage(<span class="string">"com.onecoderspace.controller"</span>))</div><div class="line"><span class="selector-class">.paths</span>(PathSelectors.any())<span class="selector-class">.build</span>();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">private</span> <span class="selector-tag">ApiInfo</span> <span class="selector-tag">apiInfo</span>() &#123;</div><div class="line"><span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">ApiInfoBuilder</span>()</div><div class="line"><span class="selector-class">.title</span>(<span class="string">"spring boot示例接口API"</span>)</div><div class="line"><span class="selector-class">.description</span>(<span class="string">"spring boot示例接口API"</span>)</div><div class="line"><span class="selector-class">.version</span>(<span class="string">"1.0"</span>)<span class="selector-class">.build</span>();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>通过@Configuration注解和@EnableSwagger2注解来启用Swagger2</li><li>basePackage：配置Swagger2需要扫描的包</li></ul><p><strong>3、 使用示例</strong><br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@Api</span>(tags=<span class="string">"用户管理"</span>,description=<span class="string">"UserController"</span>)</div><div class="line"><span class="variable">@RestController</span></div><div class="line"><span class="variable">@RequestMapping</span>(<span class="string">"/user"</span>)</div><div class="line">public class UserController &#123;</div><div class="line"></div><div class="line"><span class="variable">@ApiOperation</span>(value = <span class="string">"用户申请审核"</span>, notes = <span class="string">"用户申请审核"</span>)</div><div class="line"><span class="variable">@RequestMapping</span>(value=<span class="string">"/apply/audit"</span>,method=RequestMethod.GET)</div><div class="line">public Return applyAudit() &#123;</div><div class="line"></div><div class="line"><span class="selector-tag">return</span> <span class="selector-tag">Return</span><span class="selector-class">.success</span>();</div><div class="line">&#125;</div><div class="line"></div><div class="line">@<span class="selector-tag">ApiOperation</span>(value = <span class="string">"获取用户详细信息"</span>, notes = <span class="string">"根据ID查找用户"</span>)</div><div class="line">@<span class="selector-tag">ApiImplicitParam</span>(paramType = <span class="string">"query"</span>, name = <span class="string">"username"</span>, value = <span class="string">"用户名"</span>, required = true, dataType = <span class="string">"String"</span>)</div><div class="line">@<span class="selector-tag">RequestMapping</span>(value = <span class="string">"/get"</span>, method = RequestMethod.GET)</div><div class="line"><span class="selector-tag">public</span> <span class="selector-tag">User</span> <span class="selector-tag">get</span>(String username) &#123;</div><div class="line"><span class="selector-tag">return</span> <span class="selector-tag">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@<span class="selector-tag">ApiOperation</span>(value = <span class="string">"修改用户信息"</span>, notes = <span class="string">"修改用户信息"</span>)</div><div class="line">@<span class="selector-tag">ApiImplicitParams</span>(&#123;</div><div class="line"><span class="variable">@ApiImplicitParam</span>(paramType = <span class="string">"query"</span>, name = <span class="string">"user"</span>, value = <span class="string">"用户实体"</span>, required = true, dataType = <span class="string">"user"</span>),</div><div class="line"><span class="variable">@ApiImplicitParam</span>(paramType = <span class="string">"query"</span>, name = <span class="string">"cname"</span>, value = <span class="string">"公司名称"</span>, required = true, dataType = <span class="string">"String"</span>) &#125;)</div><div class="line">@<span class="selector-tag">RequestMapping</span>(value = <span class="string">"/save"</span>, method = RequestMethod.POST)</div><div class="line"><span class="selector-tag">public</span> <span class="selector-tag">Return</span> <span class="selector-tag">save</span>(User user, String cname, String curl) &#123;</div><div class="line"></div><div class="line"><span class="selector-tag">return</span> <span class="selector-tag">Return</span><span class="selector-class">.success</span>();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>在线文档显示效果如下：<br><img src="http://owxkafu91.bkt.clouddn.com/swagger2.png" alt="swagger2在线文档效果"></p><ul><li>@Api:在类上添加注释，tags属性决定1处的内容，description决定2处的内容  </li><li>@ApiOperation：在方法上添加注释，用于说明某个请求url的作用，value属性决定3处的内容，notes决定5处的内容  </li><li>@ApiImplicitParam： 在方法上添加注释，用于说明某个请求参数的作用  </li><li>@ApiImplicitParams多个参数时使用该注解</li><li>在实体字段添加@ApiModelProperty(value=”名称”)，生成该字段的说明</li></ul><p><strong>4、 注意事项</strong>  </p><ol><li><strong>如果系统加入shiro等权限框架，那么访问swagger-ui.html需要有ACTUATOR角色，这个不要忘了配置</strong>  </li><li>对于实体参数的支持不太好，保存更新时如果字段不是很多，建议使用属性的方式替代使用实体  </li><li>swagger2是支持自定义页面的，如果觉得默认的样式不太适合，可以自定义前端页面，通过网络监控可以发现，所有数据是通过一个/v2/api-docs的请求获得的。</li></ol><p>当接口较多时，swagger2也支持分组等配置，参考以下文档：<br><a href="http://blog.didispace.com/spring-boot-starter-swagger-1.3.0/" target="_blank" rel="external">spring-boot-starter-swagger 1.3.0.RELEASE：新增对JSR-303的支持和host的配置</a>  </p><p>相关阅读：<br><a href="https://swagger.io/" target="_blank" rel="external">swagger官网</a><br><a href="http://blog.didispace.com/springbootswagger2/" target="_blank" rel="external">Spring Boot中使用Swagger2构建强大的RESTful API文档</a><br><a href="http://blog.didispace.com/spring-boot-starter-swagger-1.1.0/" target="_blank" rel="external">简化Swagger使用的自制Starter：spring-boot-starter-swagger，欢迎使用和吐槽</a></p><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对于接口服务来说接口文档极其重要，在团队配合和后续维护中占据重要角色。在工作中，使用过excel，wiki来进行接口文档的维护：&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="swagger2" scheme="http://www.onecoderspace.com/tags/swagger2/"/>
    
      <category term="在线接口文档" scheme="http://www.onecoderspace.com/tags/%E5%9C%A8%E7%BA%BF%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3/"/>
    
  </entry>
  
  <entry>
    <title>spring boot项目实战：异常处理</title>
    <link href="http://www.onecoderspace.com/2017/10/01/spring-boot-exception/"/>
    <id>http://www.onecoderspace.com/2017/10/01/spring-boot-exception/</id>
    <published>2017-10-01T00:04:58.000Z</published>
    <updated>2017-10-01T12:38:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>异常处理是一个比较基础而又重要的技能点，在团队内最好形成一个统一的规则，避免团队成员不断掉进前辈已经爬出来的坑中。<br><a id="more"></a></p><h3 id="1、全局异常处理"><a href="#1、全局异常处理" class="headerlink" title="1、全局异常处理"></a>1、全局异常处理</h3><p>spring boot支持配置全局异常处理，记录未捕获的全局异常，这样方便在问题发生时快速定位问题，配置方式如下：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ControllerAdvice</span></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">GlobalDefaultExceptionHandler</span> </span>&#123;</div><div class="line">private <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(GlobalDefaultExceptionHandler.<span class="keyword">class</span>);</div><div class="line"></div><div class="line"><span class="meta">@ExceptionHandler</span>(value = Exception.<span class="keyword">class</span>)</div><div class="line"><span class="meta">@ResponseBody</span></div><div class="line">public <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; defaultErrorHandler(HttpServletRequest req,HttpServletResponse response, Exception e) &#123;</div><div class="line">logger.error(<span class="string">"defaultErrorHandler:"</span>, e);</div><div class="line">response.setStatus(<span class="number">500</span>);</div><div class="line"></div><div class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; map = <span class="keyword">new</span> HashMap&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt;();</div><div class="line">map.put(<span class="string">"code"</span>, <span class="string">"-1000"</span>);</div><div class="line">map.put(<span class="string">"msg"</span>, <span class="string">"系统繁忙"</span>);</div><div class="line"><span class="keyword">return</span> map;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ol><li>在类上添加@ControllerAdvice注释</li><li>根据异常类型创建不同的方法，在方法上添加@ExceptionHandler注解，value的值是具体的异常类型</li><li>defaultErrorHandler方法的返回值可以是String（view路径),Map(json结构，需添加@ResponseBody注解)</li><li><strong>response状态需要设置，否则前端看到的会是正常的200</strong>，根据具体的异常来设置，如无权限返回403等，两种设置方式，response.setStatus(500) 或者 @ResponseStatus(value=HttpStatus.INTERNAL_SERVER_ERROR)注解</li></ol><h3 id="2、for、while循环异常处理"><a href="#2、for、while循环异常处理" class="headerlink" title="2、for、while循环异常处理"></a>2、for、while循环异常处理</h3><p>在for、while循环内是否需要进行异常捕获应该根据循环体的业务来确定，<strong>当一次循环过程中发生异常时，是否要终止循环，这是你使用循环时不能忽略的一点。</strong>  </p><p>如以下场景：  </p><ol><li>APP批量上传用户启动、使用事件，循环将每条数据处理后放入kafka队列：<strong>每次循环都是一个独立的处理过程，一次循环发生异常时不希望终止整个循环，</strong>类似的场景循环内部就需要进行异常捕获，从而避免一条数据的异常导致整批数据一起失败；  </li><li>批量删除用户，全部成功，否则回滚：业务需求是整个批次的数据全部成功，一个失败整体失败，那么就不需要在循环体内部进行异常捕获了，可以在循环体外或依赖全局异常处理来记录异常信息；</li></ol><p>在循环内部捕获异常，<strong>特别是while循环时，要注意循环终止条件，不要出现无限循环记录日志，导致磁盘写满的情况</strong>。</p><h3 id="3、代码段异常处理"><a href="#3、代码段异常处理" class="headerlink" title="3、代码段异常处理"></a>3、代码段异常处理</h3><p>完成一件事情，需要执行很多步处理，编程时我们通常使用一个空行来分割不同的“步”以使程序看起来更有调理，每一步的操作可以定义为一个粗粒度的“代码段”。一个代码段是否需要进行异常捕获，同样是有代码的业务来确定，<strong>当异常发生时，是否需要终止整个处理流程是判断的标准。</strong>  </p><p>如以下场景：  </p><ol><li>用户调用A接口，接口A包含三个代码段，参数校验-&gt;请求信息放入kafka-&gt;返回请求结果：第二步“请求信息放入kafka”对整个接口来说属于附加操作，当它发生异常时不应该影响用户正常获取数据，故此该代码段需要添加异常捕获，避免非核心业务的异常影响核心业务的执行。</li><li>用户调用B接口，接口B包含是哪个代码段，参数校验-&gt;创建用户信息—&gt;创建用户账号信息,第二步和第三步任何一个发生异常，都会导致整个操作失败，这种场景就不能单纯的捕获异常，那样会导致数据的不一致。</li></ol><h3 id="4、异常日志记录"><a href="#4、异常日志记录" class="headerlink" title="4、异常日志记录"></a>4、异常日志记录</h3><p>异常日志要记录在日志文件内，一定不要简单的将日志打印到控制台（测试环境一个tomcat放了十几个项目，如果都打印到控制台…）,在项目后期可以全局搜索System.out和System.err，并向对应人员指出。spring boot内建议使用logback作为日志组件，日志的使用可参考<a href="http://www.jianshu.com/p/284ba755052d" target="_blank" rel="external">sprign boot项目实战:日志</a>;</p><h3 id="5、总结"><a href="#5、总结" class="headerlink" title="5、总结"></a>5、总结</h3><ol><li>项目内建议配置全局异常捕获，有利于问题排查；</li><li>单次循环发生异常是否应该终止循环？不要忽略这个的问题；</li><li>注意循环终止条件，避免出现无限循环记录日志的情况</li><li>一个代码段发生异常是否要终止整个处理流程？同样不要忽略这个问题；</li><li>异常日志最好记录在日志文件内，不要简单的打印到控制台</li></ol><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;异常处理是一个比较基础而又重要的技能点，在团队内最好形成一个统一的规则，避免团队成员不断掉进前辈已经爬出来的坑中。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="异常处理" scheme="http://www.onecoderspace.com/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>boot项目实战：事务</title>
    <link href="http://www.onecoderspace.com/2017/10/01/spring-boot-transaction/"/>
    <id>http://www.onecoderspace.com/2017/10/01/spring-boot-transaction/</id>
    <published>2017-10-01T00:04:38.000Z</published>
    <updated>2017-10-01T12:39:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>事务在项目里也是不可或缺的一部分，建议形成一个统一的事务管理规范，不要出现让程序员根据业务自行添加，团队成员能力有高有低，很容易就出现需要事务时没添加事务，这种问题又很难测试出来，运行时却会不定时出现数据的不一致。<br><a id="more"></a><br>想实现类似原spring项目里通过aop方式配置事务的效果，各种尝试，目前还未找到十分可行的方式。测试可用的事务配置方式有两种：在service上添加@Transactional注解 和 引入xml配置文件（不推荐），<strong>建议使用@Transactional注解来进行事务配置。</strong></p><h3 id="1、-Transactional实现事务"><a href="#1、-Transactional实现事务" class="headerlink" title="1、@Transactional实现事务"></a>1、@Transactional实现事务</h3><p>spring boot项目内使用事务最简单直接的方式就是在每个service类上添加@Transactional注解，即可自动开启对事务的支持，不需要进行额外操作。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">Transactional</span>(<span class="keyword">isolation</span>=<span class="keyword">Isolation</span>.<span class="keyword">REPEATABLE_READ</span>,<span class="keyword">propagation</span>=<span class="keyword">Propagation</span>.<span class="keyword">REQUIRED</span>)</div></pre></td></tr></table></figure><p>该注解也可添加在方法上，对事物进行更精细化的管理，<strong>注意引用spring包下的，不要引用javax包下的</strong>。</p><h3 id="2、引入xml配置实现事务"><a href="#2、引入xml配置实现事务" class="headerlink" title="2、引入xml配置实现事务"></a>2、引入xml配置实现事务</h3><p>1、 创建com.onecoderspace.transaction.xml文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag"><span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></span></div><div class="line"><span class="tag"><span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span> <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></div><div class="line"><span class="tag"><span class="attr">xmlns:c</span>=<span class="string">"http://www.springframework.org/schema/c"</span></span></div><div class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></div><div class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd</span></span></div><div class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd</span></span></div><div class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.1.xsd</span></span></div><div class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.1.xsd</span></span></div><div class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.1.xsd"</span></span></div><div class="line"><span class="tag"><span class="attr">default-lazy-init</span>=<span class="string">"false"</span> <span class="attr">default-autowire</span>=<span class="string">"no"</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.JpaTransactionManager"</span> /&gt;</span></div><div class="line"><span class="comment">&lt;!-- 对于service使用annotation声明事物 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">mode</span>=<span class="string">"proxy"</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span> <span class="attr">order</span>=<span class="string">"100"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"insert*"</span> <span class="attr">isolation</span>=<span class="string">"REPEATABLE_READ"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"save*"</span> <span class="attr">isolation</span>=<span class="string">"REPEATABLE_READ"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"update*"</span> <span class="attr">isolation</span>=<span class="string">"REPEATABLE_READ"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"del*"</span> <span class="attr">isolation</span>=<span class="string">"REPEATABLE_READ"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"do*"</span> <span class="attr">isolation</span>=<span class="string">"REPEATABLE_READ"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span> <span class="attr">isolation</span>=<span class="string">"REPEATABLE_READ"</span> <span class="attr">read-only</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">aop:config</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">pointcut</span>=<span class="string">"execution(* com.onecoderspace..*.service..*.*(..))"</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> <span class="attr">order</span>=<span class="string">"200"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure><br>2、引入xml配置文件<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@Configuration</span></div><div class="line"><span class="variable">@ImportResource</span>(<span class="string">"classpath:com.onecoderspace.transaction.xml"</span>)</div><div class="line">public class AopTransactionConfig &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="3、小结"><a href="#3、小结" class="headerlink" title="3、小结"></a>3、小结</h3><ol><li>service层需要统一添加事务，避免部分人员忘记事务处理，在运行过程中导致数据不一致；</li><li>在每个service上添加注解实现事务：定好项目整体事务隔离级别和传播属性即可在项目级别形成规范，胜在简单，可执行性更高，目前本公司使用该方式；</li><li>在service方法上添加注解实现事务：事务管理更灵活，更有针对性，缺点是难以形成统一规范，依赖编程人员的经验和能力，如果团队内存在经验不很充足的成员不推荐使用该方式；</li><li>通过引入xml配置实现事务：配置简单，在xml内一处配置即可实现事务管理，耦合性更低；缺点就是使用了xml配置，因此不太推荐使用该方式；</li><li>隔离级别（isolation）通常选择REPEATABLE_READ；传播属性通常使用默认值（REQUIRED）即可。</li></ol><h3 id="4、扩展阅读"><a href="#4、扩展阅读" class="headerlink" title="4、扩展阅读"></a>4、扩展阅读</h3><h4 id="隔离级别（isolation）"><a href="#隔离级别（isolation）" class="headerlink" title="隔离级别（isolation）"></a>隔离级别（isolation）</h4><p>隔离级别是指若干个并发的事务之间的隔离程度，与我们开发时候主要相关的场景包括：脏读取、重复读、幻读。</p><p>我们可以看 org.springframework.transaction.annotation.Isolation 枚举类中定义了五个表示隔离级别的值：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">enum</span> <span class="title">Isolation</span> &#123;  </span></div><div class="line">    DEFAULT(-<span class="number">1</span>),</div><div class="line">    READ_UNCOMMITTED(<span class="number">1</span>),</div><div class="line">    READ_COMMITTED(<span class="number">2</span>),</div><div class="line">    REPEATABLE_READ(<span class="number">4</span>),</div><div class="line">    SERIALIZABLE(<span class="number">8</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>DEFAULT ：这是默认值，表示使用底层数据库的默认隔离级别。对大部分数据库而言，通常这值就是： READ_COMMITTED，mysql5.6默认是REPEATABLE-READ，可以通过select @@tx_isolation查看。  </li><li>READ_UNCOMMITTED ：该隔离级别表示一个事务可以读取另一个事务修改但还没有提交的数据。该级别不能防止脏读和不可重复读，因此很少使用该隔离级别。 </li><li>READ_COMMITTED ：该隔离级别表示一个事务只能读取另一个事务已经提交的数据。该级别可以防止脏读，这也是大多数情况下的推荐值。 </li><li>REPEATABLE_READ ：该隔离级别表示一个事务在整个过程中可以多次重复执行某个查询，并且每次返回的记录都相同。即使在多次查询之间有新增的数据满足该查询，这些新增的记录也会被忽略。该级别可以防止脏读和不可重复读。  </li><li>SERIALIZABLE ：所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，该级别可以防止脏读、不可重复读以及幻读。但是这将严重影响程序的性能。通常情况下也不会用到该级别。</li></ul><h4 id="传播属性（propagation）"><a href="#传播属性（propagation）" class="headerlink" title="传播属性（propagation）"></a>传播属性（propagation）</h4><p>所谓事务的传播行为是指，如果在开始当前事务之前，一个事务上下文已经存在，此时有若干选项可以指定一个事务性方法的执行行为。</p><p>我们可以看 org.springframework.transaction.annotation.Propagation 枚举类中定义了6个表示传播行为的枚举值：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">enum</span> <span class="title">Propagation</span> &#123;  </span></div><div class="line">    REQUIRED(<span class="number">0</span>),</div><div class="line">    SUPPORTS(<span class="number">1</span>),</div><div class="line">    MANDATORY(<span class="number">2</span>),</div><div class="line">    REQUIRES_NEW(<span class="number">3</span>),</div><div class="line">    NOT_SUPPORTED(<span class="number">4</span>),</div><div class="line">    NEVER(<span class="number">5</span>),</div><div class="line">    NESTED(<span class="number">6</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><ul><li>REQUIRED ：如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。</li><li>SUPPORTS ：如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行。</li><li>MANDATORY ：如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。</li><li>REQUIRES_NEW ：创建一个新的事务，如果当前存在事务，则把当前事务挂起。</li><li>NOT_SUPPORTED ：以非事务方式运行，如果当前存在事务，则把当前事务挂起。</li><li>NEVER ：以非事务方式运行，如果当前存在事务，则抛出异常。</li><li>NESTED ：如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于 REQUIRED 。</li></ul><p>如有更好实现方式，敬请指出。</p><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;事务在项目里也是不可或缺的一部分，建议形成一个统一的事务管理规范，不要出现让程序员根据业务自行添加，团队成员能力有高有低，很容易就出现需要事务时没添加事务，这种问题又很难测试出来，运行时却会不定时出现数据的不一致。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="事务" scheme="http://www.onecoderspace.com/tags/%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>前端实战：详情页返回列表内容缓存及定位实现</title>
    <link href="http://www.onecoderspace.com/2017/09/26/%E5%89%8D%E7%AB%AF%E5%AE%9E%E6%88%98%EF%BC%9A%E8%AF%A6%E6%83%85%E9%A1%B5%E8%BF%94%E5%9B%9E%E5%88%97%E8%A1%A8%E5%86%85%E5%AE%B9%E7%BC%93%E5%AD%98%E5%8F%8A%E5%AE%9A%E4%BD%8D%E5%AE%9E%E7%8E%B0/"/>
    <id>http://www.onecoderspace.com/2017/09/26/前端实战：详情页返回列表内容缓存及定位实现/</id>
    <published>2017-09-26T12:45:21.000Z</published>
    <updated>2017-09-26T13:07:50.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="实现目标"><a href="#实现目标" class="headerlink" title="实现目标"></a>实现目标</h2><p>当前浏览到第N页，点击某一个新闻，进入新闻详情页，点击返回时，列表数据不重新加载，焦点仍定位在进入详情页之前的位置。<br><a id="more"></a></p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li>缓存列表内已展示的数据；</li><li>进入详情页时在缓存内添加该新闻的ID（键为articleId）；</li><li>返回时在js内判断缓存内是否包含articleId，如果存在，则通过缓存的列表数据进行页面渲染；</li><li>通过articleId定位元素，滚动窗口值该元素处；</li><li>缓存不能始终存在。</li></ol><p>根据当前项目情况，考虑缓存放入sessionStorage，滚动窗口使用IScroll。</p><h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><p>1、缓存列表数据  </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//cacheKey 缓存key  cacheValue 缓存内容json结构  position 值为before和after分别用于加载最新和加载下一页 </span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addToCache</span>(<span class="params">cacheKey,cacheValue,position</span>)</span>&#123;</div><div class="line">   cacheValue = <span class="built_in">JSON</span>.stringify(cacheValue);</div><div class="line">   <span class="keyword">var</span> allCacheData = sessionStorage.getItem(cacheKey);</div><div class="line">   <span class="keyword">if</span>(allCacheData != <span class="literal">null</span>)&#123;</div><div class="line">   <span class="keyword">if</span>(position == <span class="string">"before"</span>)&#123;</div><div class="line">   allCacheData = cacheValue + <span class="string">"::::"</span> +allCacheData;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">   allCacheData = allCacheData + <span class="string">"::::"</span> + cacheValue;</div><div class="line">   &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">   allCacheData = cacheValue;</div><div class="line">   &#125;</div><div class="line">   sessionStorage.setItem(cacheKey,allCacheData);    </div><div class="line">   &#125;  </div></pre></td></tr></table></figure><ul><li>sessionStorage只能存储字符串，需要将json结构的对象转为字符串进行存储</li><li>如果列表数据特别多，应该和业务确认缓存数据条数，截取仅是字符串操作，这里不再展开</li></ul><p>2、进入详情页<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">".article"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;     </div><div class="line">     sessionStorage.setItem(<span class="string">"articleId"</span>,$(<span class="keyword">this</span>).attr(<span class="string">"id"</span>));</div><div class="line">   &#125;)  </div></pre></td></tr></table></figure></p><ul><li>在每条新闻上绑定事件，点击时设置文章ID至缓存，正常来说在详情页设置，但是因为这个项目内的详情页不是我们部门的，所以只能在列表页设置；</li></ul><p>3、返回时列表内js判断是从详情页返回的还是一次新的访问<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span> articleId = sessionStorage.getItem(<span class="string">"articleId"</span>);</div><div class="line">   <span class="built_in">var</span> cacheData = sessionStorage.getItem($scope.initType);</div><div class="line">   <span class="keyword">if</span>(articleId != <span class="built_in">null</span> &amp;&amp; cacheData != <span class="built_in">null</span>)&#123; <span class="comment">//从详情页返回且列表缓存数据不为空</span></div><div class="line">   showTableDataWithCache(cacheData,articleId);</div><div class="line">   removeCache(<span class="string">"articleId"</span>);<span class="comment">//注意使用一次就清理掉</span></div><div class="line">   &#125;<span class="keyword">else</span> &#123; <span class="comment">//一次新的访问，要清理掉所有相关缓存</span></div><div class="line">   removeAllFuturesCache();</div><div class="line">   loadPage(<span class="number">1</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure><br>4、定位至对应元素<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="string">//注意IScroll需要重新初始化</span></div><div class="line"><span class="string">myScroll</span> <span class="string">=</span> <span class="string">new</span> <span class="string">IScroll('#wrapper',</span> <span class="string">&#123;</span></div><div class="line"><span class="attr">    probeType:</span> <span class="number">3</span><span class="string">,</span></div><div class="line"><span class="attr">    disableMouse:</span> <span class="literal">true</span><span class="string">,</span></div><div class="line"><span class="attr">    momentum:</span> <span class="literal">true</span><span class="string">,</span></div><div class="line"><span class="attr">    mouseWheel:</span> <span class="literal">true</span><span class="string">,</span></div><div class="line"><span class="attr">    disablePointer:</span> <span class="literal">true</span><span class="string">,</span></div><div class="line"><span class="attr">    click:</span> <span class="literal">true</span><span class="string">,</span></div><div class="line"><span class="attr">    tap:</span> <span class="literal">true</span><span class="string">,</span></div><div class="line"><span class="attr">    resizePolling:</span> <span class="number">1</span><span class="string">,</span></div><div class="line">    <span class="string">//</span> <span class="string">x</span></div><div class="line">  <span class="string">&#125;);</span></div><div class="line"></div><div class="line"><span class="string">//滚动至对应元素</span></div><div class="line"><span class="string">myScroll.scrollToElement(document.querySelector("[id='"+detailArticleId+"']"),10,true,true);</span></div><div class="line"><span class="string">initScroll();</span></div><div class="line"><span class="string">myScroll.refresh();</span>  </div></pre></td></tr></table></figure></p><ul><li>注意IScroll需要重新初始化;</li><li>scrollToElement的选择器格式是[id=’articleId’]而不是正常的”#articleId”;10 是动画时间   true  true这样设置会将元素显示在窗口中间；</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>sessionStorage是单个窗口级的缓存，同一个窗口内的数据可缓存在其内；</li><li>IScroll可以作为页面滚动的组件；</li><li>详情页返回列表不刷新问题可以分解为三个小问题：  <ol><li>缓存列表数据</li><li>添加从详情页返回的标记（文章详情ID）</li><li>用缓存数据渲染页面后滚动窗口至对应元素<br>通过sessionStorage存储数据，这样很多功能都可以实现，比如返回时标签选中等都是一样的思路，进入详情页时设置对应值，在页面加载时判断对应的缓存数据是否存在进而展开业务，这里不再展开。 </li></ol></li></ol><p>参考：<br><a href="http://www.cnblogs.com/yuzhongwusan/archive/2011/12/19/2293347.html" target="_blank" rel="external">sessionStorage介绍</a><br><a href="http://blog.csdn.net/liangklfang/article/details/52804915" target="_blank" rel="external">IScroll使用</a>  </p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;实现目标&quot;&gt;&lt;a href=&quot;#实现目标&quot; class=&quot;headerlink&quot; title=&quot;实现目标&quot;&gt;&lt;/a&gt;实现目标&lt;/h2&gt;&lt;p&gt;当前浏览到第N页，点击某一个新闻，进入新闻详情页，点击返回时，列表数据不重新加载，焦点仍定位在进入详情页之前的位置。&lt;br&gt;
    
    </summary>
    
      <category term="前端" scheme="http://www.onecoderspace.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="前端" scheme="http://www.onecoderspace.com/tags/%E5%89%8D%E7%AB%AF/"/>
    
      <category term="列表数据缓存" scheme="http://www.onecoderspace.com/tags/%E5%88%97%E8%A1%A8%E6%95%B0%E6%8D%AE%E7%BC%93%E5%AD%98/"/>
    
      <category term="详情页返回列表无刷新" scheme="http://www.onecoderspace.com/tags/%E8%AF%A6%E6%83%85%E9%A1%B5%E8%BF%94%E5%9B%9E%E5%88%97%E8%A1%A8%E6%97%A0%E5%88%B7%E6%96%B0/"/>
    
      <category term="html生成页面无法滚动" scheme="http://www.onecoderspace.com/tags/html%E7%94%9F%E6%88%90%E9%A1%B5%E9%9D%A2%E6%97%A0%E6%B3%95%E6%BB%9A%E5%8A%A8/"/>
    
  </entry>
  
  <entry>
    <title>spring boot项目实战：跨域问题解决</title>
    <link href="http://www.onecoderspace.com/2017/09/26/spring-boot-cors/"/>
    <id>http://www.onecoderspace.com/2017/09/26/spring-boot-cors/</id>
    <published>2017-09-26T12:44:40.000Z</published>
    <updated>2017-10-01T12:37:56.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>前后端分离架构，前端anglerjs，后端spring boot,使用shiro作为权限控制，已配置通用跨域请求支持。<br>前端调用接口时部分情况正常，部分情况出现跨域请求不支持情况，错误信息如下：<br><a id="more"></a><br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Response <span class="keyword">to</span> preflight request doesn<span class="symbol">'t</span> pass <span class="keyword">access</span> control check: No <span class="symbol">'Access</span>-Control-Allow-Origin' header <span class="keyword">is</span> present <span class="keyword">on</span> the requested resource. Origin <span class="symbol">'xxxx</span>' <span class="keyword">is</span> therefore <span class="keyword">not</span> allowed <span class="keyword">access</span>.</div></pre></td></tr></table></figure>    </p><h3 id="配置错了？"><a href="#配置错了？" class="headerlink" title="配置错了？"></a>配置错了？</h3><p>首先，想到的就是对跨域请求支持的配置是错误的，尝试着替换不同的跨域支持配置，有以下几种：<br>1、继承WebMvcConfigurerAdapter<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">public class AppConfig extends WebMvcConfigurerAdapter &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void addCorsMappings(CorsRegistry registry) &#123;</div><div class="line">        registry.addMapping(<span class="string">"/**"</span>)</div><div class="line">                .allowedOrigins(<span class="string">"*"</span>)</div><div class="line">                .allowCredentials(true).allowedHeaders(<span class="string">"Origin, X-Requested-With, Content-Type, Accept"</span>)</div><div class="line">                .allowedMethods(<span class="string">"<span class="keyword">GET</span>"</span>, <span class="string">"<span class="keyword">POST</span>"</span>, <span class="string">"<span class="keyword">DELETE</span>"</span>, <span class="string">"<span class="keyword">PUT</span>"</span>, <span class="string">"<span class="keyword">OPTIONS</span>"</span>)</div><div class="line">                .maxAge(<span class="number">3600</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>2、配置WebMvcConfigurer<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="keyword">public</span> <span class="function">WebMvcConfigurer <span class="title">corsConfigurer</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurerAdapter() &#123;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</div><div class="line">registry.addMapping(<span class="string">"/**"</span>).allowedOrigins(<span class="string">"*"</span>)</div><div class="line">.allowedMethods(<span class="string">"*"</span>).allowedHeaders(<span class="string">"*"</span>)</div><div class="line">.allowCredentials(<span class="keyword">true</span>)</div><div class="line">.exposedHeaders(HttpHeaders.SET_COOKIE).maxAge(<span class="number">3600</span>L);</div><div class="line">&#125;</div><div class="line">&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>…</p><p><a href="https://spring.io/blog/2015/06/08/cors-support-in-spring-framework" target="_blank" rel="external">CORS support in Spring Framework</a>内的方式都尝试了一遍，发现问题仍然未解决，看到文档内的一个点</p><blockquote><p>If you are using Spring Security, make sure to enable CORS at Spring Security level as well to allow it to leverage the configuration defined at Spring MVC level.</p></blockquote><p>大概意思就是使用Spring Security要进行特殊的配置来支持CORS。而当前项目内使用的是shiro，是不是权限控制导致的问题?检查shiro相关代码，果然找到了问题，在loginFilter内会判断如果未登录，就通过response写回未登录提示，代码如下：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Subject </span><span class="keyword">subject </span>= SecurityUtils.getSubject()<span class="comment">;</span></div><div class="line">if (!<span class="keyword">subject.isAuthenticated()) </span>&#123;</div><div class="line">HttpServletResponse resp = (HttpServletResponse) response<span class="comment">;</span></div><div class="line">String contentType = <span class="string">"application/json"</span><span class="comment">;</span></div><div class="line">resp.setContentType(contentType)<span class="comment">;</span></div><div class="line">resp.setCharacterEncoding(<span class="string">"UTF-8"</span>)<span class="comment">;</span></div><div class="line"></div><div class="line">Map&lt;String, String&gt; map = Maps.newLinkedHashMap()<span class="comment">;</span></div><div class="line">map.put(<span class="string">"code"</span>, <span class="string">"xxx"</span>)<span class="comment">;</span></div><div class="line">map.put(<span class="string">"msg"</span>, <span class="string">"xxx"</span>)<span class="comment">;</span></div><div class="line">String result = <span class="keyword">JacksonHelper.toJson(map);</span></div><div class="line"><span class="keyword"></span>PrintWriter out = resp.getWriter()<span class="comment">;</span></div><div class="line">try&#123;</div><div class="line">out.print(result)<span class="comment">;</span></div><div class="line">out.flush()<span class="comment">;</span></div><div class="line">&#125; finally &#123;</div><div class="line">out.<span class="keyword">close();</span></div><div class="line"><span class="keyword"></span>&#125;</div><div class="line">return<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><br>那就添加上跨域支持<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">resp</span><span class="selector-class">.setHeader</span>(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</div><div class="line"><span class="selector-tag">resp</span><span class="selector-class">.setHeader</span>(<span class="string">"Access-Control-Allow-Origin"</span>,request.getHeader(<span class="string">"Origin"</span>));</div></pre></td></tr></table></figure><br>本来以为ok了，但是前端是不报错了，但并不能获得对应接口期望的结果，而是一直收到<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"code"</span>:<span class="string">"xxx"</span>,<span class="attr">"msg"</span>:<span class="string">"xxx"</span>&#125;</div></pre></td></tr></table></figure><br>显然是被登录拦截了，但是明明已经登录，而且有的接口可以正常通过登录拦截，为什么部分接口会出现不能登录的情况呢？  </p><h3 id="明明登录了，为什么被loginFilter拦截？"><a href="#明明登录了，为什么被loginFilter拦截？" class="headerlink" title="明明登录了，为什么被loginFilter拦截？"></a>明明登录了，为什么被loginFilter拦截？</h3><p>遇到了问题就要想办法解决，首先就是怀疑客户端sessionId未被正常保存，在loginFilter内添加日志打印sessionID，发现每次的sessionID都不一样，问题清晰了一些，前端并未正确的保持登录状态，对比前端两个调用接口的代码，发现正常的是get请求，post请求不正常，通过在网上搜索，<strong>发现ajax post跨域请求时，默认是不携带浏览器的cookie的</strong>，也就是每次请求都会生成一个新的session，因此post请求都被登录拦截。解决办法如下：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$.ajax(&#123;</div><div class="line">type:<span class="string">"<span class="keyword">POST</span>"</span>,</div><div class="line">url:<span class="string">""</span>,</div><div class="line">data:&#123;&#125;,</div><div class="line">crossDomain:true,</div><div class="line">       xhrFields: &#123;  withCredentials: true  &#125;,</div><div class="line">success:function(data)&#123;</div><div class="line"></div><div class="line">&#125;,</div><div class="line">error:function(data)&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure><br><strong>配置crossDomain:true 和 xhrFields: {  withCredentials: true  }就可以让请求正常携带cookie。</strong></p><h3 id="一个完整可用方案"><a href="#一个完整可用方案" class="headerlink" title="一个完整可用方案"></a>一个完整可用方案</h3><p>1、配置支持跨域请求（多种方式自由选择，推荐使用下面的方式）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 跨域请求支持</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> WebMvcConfigurer <span class="title">corsConfigurer</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurerAdapter() &#123;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</div><div class="line">registry.addMapping(<span class="string">"/**"</span>).allowedOrigins(<span class="string">"*"</span>)</div><div class="line">.allowedMethods(<span class="string">"*"</span>).allowedHeaders(<span class="string">"*"</span>)</div><div class="line">.allowCredentials(<span class="keyword">true</span>)</div><div class="line">.exposedHeaders(HttpHeaders.SET_COOKIE).maxAge(<span class="number">3600L</span>);</div><div class="line">&#125;</div><div class="line">&#125;;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>2、前端ajax post请求时添加xhrFields: {  withCredentials: true  }<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$.ajax(&#123;</div><div class="line">type:<span class="string">"<span class="keyword">POST</span>"</span>,</div><div class="line">url:<span class="string">""</span>,</div><div class="line">data:&#123;&#125;,</div><div class="line">crossDomain:true,</div><div class="line">       xhrFields: &#123;  withCredentials: true  &#125;,</div><div class="line">success:function(data)&#123;</div><div class="line"></div><div class="line">&#125;,</div><div class="line">error:function(data)&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure><br>3、检查权限控制代码，看是否有特殊处理的地方，未添加跨域支持。如上文所提，登录拦截直接通过response写回未登录提示；<br>使用spring-security框架时也要添加特殊配置，如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@EnableWebSecurity</span></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">protected</span> void configure(<span class="type">HttpSecurity</span> http) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</div><div class="line">http.cors().and()...</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>    </p><blockquote><p>解决跨域的本质就是在返回头内添加Access-Control-Allow-Origin，实现方式有多种，spring体系内解决跨域可参考<a href="https://spring.io/blog/2015/06/08/cors-support-in-spring-framework" target="_blank" rel="external">CORS support in Spring Framework</a>,很全面的介绍了各种场景。使用权限框架时，要注意权限框架本身的CORS支持。</p></blockquote><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;前后端分离架构，前端anglerjs，后端spring boot,使用shiro作为权限控制，已配置通用跨域请求支持。&lt;br&gt;前端调用接口时部分情况正常，部分情况出现跨域请求不支持情况，错误信息如下：&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="CORS" scheme="http://www.onecoderspace.com/tags/CORS/"/>
    
      <category term="跨域" scheme="http://www.onecoderspace.com/tags/%E8%B7%A8%E5%9F%9F/"/>
    
      <category term="ajax post跨域" scheme="http://www.onecoderspace.com/tags/ajax-post%E8%B7%A8%E5%9F%9F/"/>
    
  </entry>
  
  <entry>
    <title>sprign boot项目实战：日志</title>
    <link href="http://www.onecoderspace.com/2017/09/26/spring-boot-log/"/>
    <id>http://www.onecoderspace.com/2017/09/26/spring-boot-log/</id>
    <published>2017-09-26T12:43:59.000Z</published>
    <updated>2017-10-01T12:38:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>日志是运维、排错的一个重要助手，很多人应该都维护过没有日志的项目，知道排查问题是什么感觉。所以搭建基础项目框架时，自然不能少了日志。<br><a id="more"></a></p><h1 id="日志组件选择"><a href="#日志组件选择" class="headerlink" title="日志组件选择"></a>日志组件选择</h1><p>从网上各种搜索对比，在log4j2和logback之间选择了log4j2,综合各处评价，log4j2在性能方法有一定优势。但是在一个项目内使用后就发现，<strong>spring boot内log4j2不支持spring profile机制，也就是在本地环境、测试环境、预发布环境、正式环境需要手动切换配置</strong>，当前公司的多个环境在相同的服务器上，所以这种方式会导致多个环境的日志生成在了同一个文件内，很不利于问题排查。因此又将日志组件换回了logback，<strong>因为对当前公司的项目来说，日志支持profile机制更重要，性能瓶颈绝不在日志这块。</strong>  </p><h1 id="logback配置"><a href="#logback配置" class="headerlink" title="logback配置"></a>logback配置</h1><p>spring boot内配置logback还是很简单的，只需要在src/main/resources目录下创建logback-spring.xml，在xml内添加自己的日志配置即可。支持三个环境local、dev、prod的日志配置如下：<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">scan</span>=<span class="string">"true"</span> <span class="attr">scanPeriod</span>=<span class="string">"30 seconds"</span>&gt;</span></span></div><div class="line"><span class="xml">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"LOG_PATH"</span> <span class="attr">value</span>=<span class="string">"/mnt/diskb/logs"</span>/&gt;</span></span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"local"</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.onecoderspace"</span> <span class="attr">level</span>=<span class="string">"debug"</span> <span class="attr">additivity</span>=<span class="string">"true"</span>/&gt;</span></span></div><div class="line"><span class="xml">        <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"logfile"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d</span><span class="template-variable">&#123;yyyy-MM-dd HH:mm:ssS&#125;</span><span class="xml"> %5p [%c]:%L-%m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span></div><div class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml">    <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"dev"</span>&gt;</span></span></div><div class="line"><span class="xml">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.onecoderspace"</span> <span class="attr">level</span>=<span class="string">"info"</span> <span class="attr">additivity</span>=<span class="string">"true"</span>/&gt;</span></span></div><div class="line"><span class="xml">        <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"logfile"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">file</span>&gt;</span>$</span><span class="template-variable">&#123;LOG_PATH&#125;</span><span class="xml">/projectName/projectName_dev.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">append</span>&gt;</span>true<span class="tag">&lt;/<span class="name">append</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d</span><span class="template-variable">&#123;yyyy-MM-dd HH:mm:ssS&#125;</span><span class="xml"> %5p [%c</span><span class="template-variable">&#123;5&#125;</span><span class="xml">#%M]:%L-%m%n%caller</span><span class="template-variable">&#123;0&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">prudent</span>&gt;</span>false<span class="tag">&lt;/<span class="name">prudent</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="comment">&lt;!-- daily rollover --&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$</span><span class="template-variable">&#123;LOG_PATH&#125;</span><span class="xml">/projectName/projectName_dev.%d</span><span class="template-variable">&#123;yyyy-MM-dd&#125;</span><span class="xml">.log.gz</span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span></div><div class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span></div><div class="line"><span class="xml">    </span></div><div class="line"><span class="xml">    <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"prod"</span>&gt;</span></span></div><div class="line"><span class="xml">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.onecoderspace"</span> <span class="attr">level</span>=<span class="string">"info"</span> <span class="attr">additivity</span>=<span class="string">"true"</span>/&gt;</span></span></div><div class="line"><span class="xml">        <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"logfile"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">file</span>&gt;</span>$</span><span class="template-variable">&#123;LOG_PATH&#125;</span><span class="xml">/projectName/projectName.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">append</span>&gt;</span>true<span class="tag">&lt;/<span class="name">append</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d</span><span class="template-variable">&#123;yyyy-MM-dd HH:mm:ssS&#125;</span><span class="xml"> %5p [%c</span><span class="template-variable">&#123;5&#125;</span><span class="xml">#%M]:%L-%m%n%caller</span><span class="template-variable">&#123;0&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">prudent</span>&gt;</span>false<span class="tag">&lt;/<span class="name">prudent</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="comment">&lt;!-- daily rollover --&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$</span><span class="template-variable">&#123;LOG_PATH&#125;</span><span class="xml">/projectName/projectName.%d</span><span class="template-variable">&#123;yyyy-MM-dd&#125;</span><span class="xml">.log.gz</span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span></div><div class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"logfile"</span> /&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></div></pre></td></tr></table></figure><br>spring-boot-starter-web内已经包含了logback和slf4j的依赖，所以只要项目依赖了spring-boot-starter-web，就不需要做其他额外的配置了。</p><h1 id="日志使用"><a href="#日志使用" class="headerlink" title="日志使用"></a>日志使用</h1><p>调用日志时建议使用slf4j，虽然基本不会在后续变更日志组件，但使用slf4j是一个好的习惯。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> logger = <span class="type">LoggerFactory</span>.getLogger(<span class="type">LoginController</span>.<span class="keyword">class</span>);</div></pre></td></tr></table></figure><br><strong>debug日志</strong><br>debug日志建议添加logger.isDebugEnabled()判断，在重要的流程上都留下日志，这样当系统出现问题时，可以通过debug日志，快速定位问题，能代替很多断点调试的时间。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">if</span>(logger.isDebugEnabled())&#123;</div><div class="line">logger.<span class="builtin-name">debug</span>(<span class="string">"user=&#123;&#125; login success"</span>,username);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><strong>info日志</strong><br>比较重要的信息，对于系统运行有比较重要的参考意义，同时不会对性能造成影响，可以在正式环境展示的信息，使用info基本打印，如定时任务运行时间等。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">logger.<span class="builtin-name">info</span>(<span class="string">"end fetcher proxy use time=&#123;&#125;"</span>, System.currentTimeMillis()- t);</div></pre></td></tr></table></figure><br><strong>error日志</strong><br>error日志相对来说是最重要的，但使用时需要注意使用方式，不正确的方式会导致很多信息被隐藏。可以参考如下方式：<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">logger.<span class="built_in">error</span>(<span class="keyword">String</span>.<span class="keyword">format</span>(<span class="string">"error msg ,arg1=%s,arg2=%s"</span>,arg1,arg2), e);</div></pre></td></tr></table></figure></p><ul><li>尽可能的带上异常发生时的参数，这个对排查问题很有意义</li><li>打印异常的完整堆栈信息，仅打印e.getMessage()会导致很多信息被隐藏</li><li>只在异常发生时或明确的业务错误时使用error，不要用error来打印调试、普通信息</li></ul><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol><li>spring boot项目内日志组件选择logback比较好，内嵌的日志组件，支持profile机制；</li><li>logback配置方式为在src/main/resources目录下创建logback-spring.xml，配置内容参考上文；</li><li>调用日志时使用slf4j，注意合理使用日志级别</li><li>注意以下几点tips</li></ol><h5 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h5><p>1、 应用日志尽量放在数据盘上，不要放在系统盘上，遇到了不止一次日志写满系统盘导致服务暂停的情况<br>2、 技术负责人定好日志规范，在代码review时指出几次日志使用的问题，能够很快让良好使用日志成为团队的习惯<br>3、 正式环境的日志基本最低为info，通常可以调整为warn或error<br>4、 在while循环内有异常捕获时，注意当异常发生时，不能无限打印日志，如下代码：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">while</span> (flag) &#123;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">byte[] bb = _queue.poll(<span class="number">1</span>, TimeUnit.SECONDS);</div><div class="line"><span class="keyword">if</span> (bb != <span class="keyword">null</span>) &#123;</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; m = JacksonSupport.decode1(<span class="keyword">new</span> ByteArrayInputStream(bb), <span class="built_in">Map</span>.<span class="keyword">class</span>);</div><div class="line">E event = _consumer.getEventType().newInstance();</div><div class="line">event.fromMap(m);</div><div class="line">_consumer.onEvent(event);</div><div class="line">&#125;</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">logger.error(<span class="string">"redis queue poll due to error"</span>, e);</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>从基于redis开发的一个blockingQueue内获取元素进行消费，代码运行了一年多十分正常，但是有一次几乎把磁盘写满了，因为当时运维调整，redis停掉了， _queue.poll这里就开始抛异常，然后下面就狂写日志，一直把磁盘写满。类似这样的地方，可以进行一个计数，连续错误达到多少次，就终止循环并以某些方式提醒运维人员。<br>5、不要使用System.out.println()，建议隔段时间全局搜索一次，发现了就在小组会议上提一下，很快这种现象就会杜绝  </p><p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;日志是运维、排错的一个重要助手，很多人应该都维护过没有日志的项目，知道排查问题是什么感觉。所以搭建基础项目框架时，自然不能少了日志。&lt;br&gt;
    
    </summary>
    
      <category term="spring boot实战" scheme="http://www.onecoderspace.com/categories/spring-boot%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="spring boot" scheme="http://www.onecoderspace.com/tags/spring-boot/"/>
    
      <category term="日志" scheme="http://www.onecoderspace.com/tags/%E6%97%A5%E5%BF%97/"/>
    
      <category term="spring profile" scheme="http://www.onecoderspace.com/tags/spring-profile/"/>
    
  </entry>
  
</feed>
