<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>spring-boot项目实战：shiro | 足迹|成长之路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="有很长一段时间都觉得自己添加个filter，基于RBAC模型，就能很轻松的实现权限控制，没必要引入shiro，spring-security这样的框架增加系统的复杂度。事实上也的确这样，如果你的需求仅仅是控制用户能否访问某个url，使用框架和自己实现filter效果基本一致，区别在于使用shiro和spring-security能够提供更多的扩展，集成了很多实用的功能，整体结构更加规范。">
<meta name="keywords" content="spring boot,shiro,权限控制">
<meta property="og:type" content="article">
<meta property="og:title" content="spring-boot项目实战：shiro">
<meta property="og:url" content="http://www.onecoderspace.com/2017/10/02/spring-boot-shiro/index.html">
<meta property="og:site_name" content="足迹|成长之路">
<meta property="og:description" content="有很长一段时间都觉得自己添加个filter，基于RBAC模型，就能很轻松的实现权限控制，没必要引入shiro，spring-security这样的框架增加系统的复杂度。事实上也的确这样，如果你的需求仅仅是控制用户能否访问某个url，使用框架和自己实现filter效果基本一致，区别在于使用shiro和spring-security能够提供更多的扩展，集成了很多实用的功能，整体结构更加规范。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-10-04T11:42:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="spring-boot项目实战：shiro">
<meta name="twitter:description" content="有很长一段时间都觉得自己添加个filter，基于RBAC模型，就能很轻松的实现权限控制，没必要引入shiro，spring-security这样的框架增加系统的复杂度。事实上也的确这样，如果你的需求仅仅是控制用户能否访问某个url，使用框架和自己实现filter效果基本一致，区别在于使用shiro和spring-security能够提供更多的扩展，集成了很多实用的功能，整体结构更加规范。">
    

    
        <link rel="alternate" href="/atom.xml" title="足迹|成长之路" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css">
    
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">足迹|成长之路</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">主页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/2017/09/25/spring-boot项目实战：目录/">spring boot实战</a>
                
                    <a class="main-nav-link" href="/about">关于我</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">主页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/2017/09/25/spring-boot项目实战：目录/">spring boot实战</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于我</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.jpg" />
            <h2 id="name">杨文魁</h2>
            <h3 id="title">本分的java web程序员，写写代码，做做架构，愿意沉下心学习新的技术，在这里分享记录学习工作中的心得</h3>
            <span id="location"><i class="fa fa-map-marker"></i>中国 - 上海</span>
            <a id="follow" target="_blank" href="http://www.onecoderspace.com/about">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                16
                <span>文章</span>
            </div>
            <div class="article-info-block">
                35
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/q7322068" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="mailto:q7322068@126.com" target="_blank" title="envelope" class=tooltip>
                            <i class="fa fa-envelope"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/css/images/myweixin.png" target="_blank" title="weixin" class=tooltip>
                            <i class="fa fa-weixin"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/atom.xml" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-spring-boot-shiro" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            spring-boot项目实战：shiro
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/02/spring-boot-shiro/">
            <time datetime="2017-10-02T05:31:52.000Z" itemprop="datePublished">2017-10-02</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/spring-boot实战/">spring boot实战</a>
    </div>

                        
    <!--<div class="article-tag">-->
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/shiro/">shiro</a>, <a class="tag-link" href="/tags/spring-boot/">spring boot</a>, <a class="tag-link" href="/tags/权限控制/">权限控制</a>
    <!--</div>-->


                        
                          <span id="busuanzi_container_site_pv" style='display:none;float: right'>
                          <i class="fa fa-eye" aria-hidden="true" style="margin-right:5px;"></i><span id="busuanzi_value_page_pv"></span>人阅读
                        </span>
                        
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>有很长一段时间都觉得自己添加个filter，基于RBAC模型，就能很轻松的实现权限控制，没必要引入shiro，spring-security这样的框架增加系统的复杂度。事实上也的确这样，如果你的需求仅仅是控制用户能否访问某个url，使用框架和自己实现filter效果基本一致，区别在于使用shiro和spring-security能够提供更多的扩展，集成了很多实用的功能，整体结构更加规范。<br><a id="more"></a><br>shiro和spring-security有哪些更多功能，这里不再展开，感兴趣的同学可以自行百度，我们这里以shiro为例，讲述spring-boot项目如何整合shiro实现权限控制。  </p>
<h3 id="1、添加maven依赖"><a href="#1、添加maven依赖" class="headerlink" title="1、添加maven依赖"></a>1、添加maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">&lt;!--shiro-core --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="comment">&lt;!-- 整合ehcache，减少数据库查询次数 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure>
<h3 id="2、添加shiro配置"><a href="#2、添加shiro配置" class="headerlink" title="2、添加shiro配置"></a>2、添加shiro配置</h3><p>创建ShiroConfigration.java<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@Configuration</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfigration</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final Logger logger = LoggerFactory.getLogger(ShiroConfigration.class);</div><div class="line"></div><div class="line">   	<span class="keyword">private</span> <span class="keyword">static</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="type">LinkedHashMap</span>&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt;();</div><div class="line"></div><div class="line"></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> SimpleCookie rememberMeCookie() &#123;</div><div class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> <span class="type">SimpleCookie</span>(<span class="string">"rememberMe"</span>);</div><div class="line">        simpleCookie.setMaxAge(<span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>);<span class="comment">//保存10天</span></div><div class="line">        <span class="keyword">return</span> simpleCookie;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * cookie管理对象;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> CookieRememberMeManager rememberMeManager() &#123;</div><div class="line">        logger.debug(<span class="string">"ShiroConfiguration.rememberMeManager()"</span>);</div><div class="line">        CookieRememberMeManager cookieRememberMeManager = <span class="keyword">new</span> <span class="type">CookieRememberMeManager</span>();</div><div class="line">        cookieRememberMeManager.setCookie(rememberMeCookie());</div><div class="line">        cookieRememberMeManager.setCipherKey(Base64.decode(<span class="string">"kPv59vyqzj00x11LXJZTjJ2UHW48jzHN"</span>));</div><div class="line">        <span class="keyword">return</span> cookieRememberMeManager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    @Bean(name = <span class="string">"lifecycleBeanPostProcessor"</span>)</div><div class="line">    <span class="keyword">public</span> LifecycleBeanPostProcessor getLifecycleBeanPostProcessor() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">LifecycleBeanPostProcessor</span>();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> FilterRegistrationBean filterRegistrationBean() &#123;</div><div class="line">        FilterRegistrationBean filterRegistration = <span class="keyword">new</span> <span class="type">FilterRegistrationBean</span>();</div><div class="line">        DelegatingFilterProxy proxy = <span class="keyword">new</span> <span class="type">DelegatingFilterProxy</span>(<span class="string">"shiroFilter"</span>);</div><div class="line">        <span class="comment">//  该值缺省为false,表示生命周期由SpringApplicationContext管理,设置为true则表示由ServletContainer管理</span></div><div class="line">        proxy.setTargetFilterLifecycle(<span class="literal">true</span>);</div><div class="line">        filterRegistration.setFilter(proxy);</div><div class="line"></div><div class="line">        filterRegistration.setEnabled(<span class="literal">true</span>);</div><div class="line">        <span class="comment">//filterRegistration.addUrlPatterns("/*");// 可以自己灵活的定义很多，避免一些根本不需要被Shiro处理的请求被包含进来</span></div><div class="line">        <span class="keyword">return</span> filterRegistration;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> MyShiroRealm myShiroRealm() &#123;</div><div class="line">        MyShiroRealm myShiroRealm = <span class="keyword">new</span> <span class="type">MyShiroRealm</span>();</div><div class="line">        <span class="keyword">return</span> myShiroRealm;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    @Bean(name=<span class="string">"securityManager"</span>)  </div><div class="line">    <span class="keyword">public</span> DefaultWebSecurityManager securityManager() &#123;  </div><div class="line">        DefaultWebSecurityManager manager = <span class="keyword">new</span> <span class="type">DefaultWebSecurityManager</span>();  </div><div class="line">        manager.setRealm(myShiroRealm()); </div><div class="line">        manager.setRememberMeManager(rememberMeManager());</div><div class="line">        manager.setCacheManager(ehCacheManager());  </div><div class="line">        <span class="keyword">return</span> manager;  </div><div class="line">    &#125;  </div><div class="line">    </div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * ShiroFilterFactoryBean 处理拦截资源文件问题。</span></div><div class="line"><span class="comment">     * 注意：单独一个ShiroFilterFactoryBean配置是或报错的，以为在</span></div><div class="line"><span class="comment">     * 初始化ShiroFilterFactoryBean的时候需要注入：SecurityManager</span></div><div class="line"><span class="comment">     * &lt;p&gt;</span></div><div class="line"><span class="comment">     * Filter Chain定义说明</span></div><div class="line"><span class="comment">     * 1、一个URL可以配置多个Filter，使用逗号分隔</span></div><div class="line"><span class="comment">     * 2、当设置多个过滤器时，全部验证通过，才视为通过</span></div><div class="line"><span class="comment">     * 3、部分过滤器可指定参数，如perms，roles</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    @Bean(name = <span class="string">"shiroFilter"</span>)</div><div class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean getShiroFilterFactoryBean() &#123;</div><div class="line">        logger.debug(<span class="string">"ShiroConfigration.getShiroFilterFactoryBean()"</span>);</div><div class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> <span class="type">ShiroFilterFactoryBean</span>();</div><div class="line">        <span class="comment">// 必须设置 SecurityManager</span></div><div class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager());</div><div class="line">        </div><div class="line">        HashMap&lt;<span class="keyword">String</span>, javax.servlet.Filter&gt; loginFilter = <span class="keyword">new</span> <span class="type">HashMap</span>&lt;&gt;();</div><div class="line">        loginFilter.put(<span class="string">"loginFilter"</span>, <span class="keyword">new</span> <span class="type">LoginFilter</span>());</div><div class="line">        shiroFilterFactoryBean.setFilters(loginFilter);</div><div class="line"></div><div class="line"></div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/login/submit"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/logout"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/img/**"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/js/**"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/css/**"</span>, <span class="string">"anon"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/test/**"</span>, <span class="string">"anon"</span>);</div><div class="line">        </div><div class="line">        <span class="comment">// 如果不设置默认会自动寻找Web工程根目录下的"/login.jsp"页面</span></div><div class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">"/login"</span>);</div><div class="line"></div><div class="line">        <span class="comment">//配置记住我或认证通过可以访问的地址</span></div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/"</span>, <span class="string">"user"</span>);</div><div class="line">        <span class="comment">//未授权界面;</span></div><div class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">"/unauth"</span>);</div><div class="line">        filterChainDefinitionMap.put(<span class="string">"/**"</span>, <span class="string">"loginFilter"</span>);</div><div class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</div><div class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</div><div class="line">    &#125;	</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * shiro缓存管理器;</span></div><div class="line"><span class="comment">     * 需要注入对应的其它的实体类中：</span></div><div class="line"><span class="comment">     * 1、安全管理器：securityManager</span></div><div class="line"><span class="comment">     * 可见securityManager是整个shiro的核心；</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * @return</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> EhCacheManager ehCacheManager() &#123;</div><div class="line">        EhCacheManager cacheManager = <span class="keyword">new</span> <span class="type">EhCacheManager</span>();</div><div class="line">        cacheManager.setCacheManagerConfigFile(<span class="string">"classpath:ehcache-shiro.xml"</span>);</div><div class="line">        <span class="keyword">return</span> cacheManager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Bean</div><div class="line">    <span class="keyword">public</span> AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(DefaultWebSecurityManager securityManager) &#123;</div><div class="line">        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = <span class="keyword">new</span> <span class="type">AuthorizationAttributeSourceAdvisor</span>();</div><div class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</div><div class="line">        <span class="keyword">return</span> authorizationAttributeSourceAdvisor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<p>shiroFilter是配置的重点，</p>
<ul>
<li>anon表示允许匿名访问</li>
<li>shiroFilterFactoryBean.setFilters(loginFilter)来设置自定义的过滤器，如本处设置了LoginFilter用于添加登录拦截</li>
<li>filterChainDefinitionMap.put(“/**”, “loginFilter”);用于指定loginFilter的作用范围</li>
</ul>
<h3 id="3、添加自定义realm"><a href="#3、添加自定义realm" class="headerlink" title="3、添加自定义realm"></a>3、添加自定义realm</h3><p>创建类MyShiroRealm.java<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyShiroRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">Logger</span> logger = <span class="type">LoggerFactory</span>.getLogger(<span class="type">MyShiroRealm</span>.<span class="keyword">class</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> <span class="type">UserService</span> userService;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> <span class="type">UserRoleService</span> userRoleService;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> <span class="type">RoleService</span> roleService;</div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> <span class="type">RolePermissionService</span> rolePermissionService;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="type">AuthenticationInfo</span> doGetAuthenticationInfo(<span class="type">AuthenticationToken</span> token) <span class="keyword">throws</span> <span class="type">AuthenticationException</span> &#123;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//获取用户的输入的账号.</span></div><div class="line">        <span class="type">String</span> idObj = (<span class="type">String</span>) token.getPrincipal();</div><div class="line">        <span class="type">Integer</span> id = <span class="type">NumberUtils</span>.toInt(idObj);</div><div class="line">        <span class="type">User</span> user = userService.findById(id);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="comment">// 返回null的话，就会导致任何用户访问被拦截的请求时，都会自动跳转到unauthorizedUrl指定的地址</span></div><div class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="type">SimpleAuthenticationInfo</span> authenticationInfo = <span class="keyword">new</span> <span class="type">SimpleAuthenticationInfo</span>(user.getId(),</div><div class="line">                user.getPwd(), getName());</div><div class="line"></div><div class="line">        <span class="keyword">return</span> authenticationInfo;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="type">AuthorizationInfo</span> doGetAuthorizationInfo(<span class="type">PrincipalCollection</span> principals) &#123;</div><div class="line">        	<span class="comment">/*</span></div><div class="line"><span class="comment">		 * 当没有使用缓存的时候，不断刷新页面的话，这个代码会不断执行，</span></div><div class="line"><span class="comment">		 * 当其实没有必要每次都重新设置权限信息，所以我们需要放到缓存中进行管理；</span></div><div class="line"><span class="comment">		 * 当放到缓存中时，这样的话，doGetAuthorizationInfo就只会执行一次了，</span></div><div class="line"><span class="comment">		 * 缓存过期之后会再次执行。</span></div><div class="line"><span class="comment">		 */</span></div><div class="line">        logger.debug(<span class="string">"权限配置--&gt;MyShiroRealm.doGetAuthorizationInfo()"</span>);</div><div class="line"></div><div class="line">        <span class="type">SimpleAuthorizationInfo</span> authorizationInfo = <span class="keyword">new</span> <span class="type">SimpleAuthorizationInfo</span>();</div><div class="line">        authorizationInfo.addRole(<span class="string">"ACTUATOR"</span>);</div><div class="line"></div><div class="line">        <span class="type">Integer</span> userId = <span class="type">Integer</span>.parseInt(principals.getPrimaryPrincipal().toString());</div><div class="line">        <span class="comment">//实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span></div><div class="line"></div><div class="line">        <span class="type">Set</span>&lt;<span class="type">Integer</span>&gt; roleIds = userRoleService.findRoleIds(userId);</div><div class="line">        <span class="type">Set</span>&lt;<span class="type">Role</span>&gt; roles = roleService.findByIds(roleIds);</div><div class="line">        <span class="keyword">for</span>(<span class="type">Role</span> role : roles)&#123;</div><div class="line">        	authorizationInfo.addRole(role.getCode());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//设置权限信息.</span></div><div class="line">        <span class="type">List</span>&lt;<span class="type">Permission</span>&gt; permissions = rolePermissionService.getPermissions(roleIds);</div><div class="line">        <span class="type">Set</span>&lt;<span class="type">String</span>&gt; set = <span class="keyword">new</span> <span class="type">HashSet</span>&lt;<span class="type">String</span>&gt;(permissions.size()*<span class="number">2</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="type">Permission</span> permission : permissions)&#123;</div><div class="line">        	<span class="keyword">if</span>(<span class="type">StringUtils</span>.isNotBlank(permission.getCode()))&#123;</div><div class="line">        		set.add(permission.getCode());</div><div class="line">        	&#125;</div><div class="line">        &#125;</div><div class="line">        authorizationInfo.setStringPermissions(set);</div><div class="line">        <span class="keyword">return</span> authorizationInfo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<ul>
<li>doGetAuthenticationInfo用于验证用户账号信息，可根据具体业务来调整认证策略</li>
<li>doGetAuthorizationInfo用于获取用户拥有的角色和权限</li>
</ul>
<p>4、创建登录拦截器<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">		Subject currentUser = SecurityUtils.getSubject();</div><div class="line">		<span class="keyword">if</span> (!currentUser.isAuthenticated()) &#123;</div><div class="line">			HttpServletRequest req = (HttpServletRequest) request;</div><div class="line">			HttpServletResponse res = (HttpServletResponse) response;</div><div class="line">			AjaxResponseWriter.write(req, res, ServiceStatusEnum.UNLOGIN, <span class="string">"请登录"</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		chain.doFilter(request, response);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AjaxResponseWriter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 写回数据到前端</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> response</span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> status &#123;<span class="doctag">@link</span> ServiceStatusEnum&#125; </span></div><div class="line"><span class="comment">	 * <span class="doctag">@param</span> message 返回的描述信息</span></div><div class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(HttpServletRequest request,HttpServletResponse response,ServiceStatusEnum status,String message)</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">		String contentType = <span class="string">"application/json"</span>;</div><div class="line">		response.setContentType(contentType);</div><div class="line">		response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">		response.setHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</div><div class="line">		response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>,request.getHeader(<span class="string">"Origin"</span>));</div><div class="line">		</div><div class="line">		Map&lt;String, String&gt; map = Maps.newLinkedHashMap();</div><div class="line">		map.put(<span class="string">"code"</span>, status.code);</div><div class="line">		map.put(<span class="string">"msg"</span>, message);</div><div class="line">		String result = JacksonHelper.toJson(map);</div><div class="line">		PrintWriter out = response.getWriter();</div><div class="line">		<span class="keyword">try</span>&#123;</div><div class="line">			out.print(result);</div><div class="line">			out.flush();</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			out.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 全局性状态码</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> yangwk</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ServiceStatusEnum &#123;</div><div class="line">	UNLOGIN(<span class="string">"0001"</span>), <span class="comment">//未登录</span></div><div class="line">	ILLEGAL_TOKEN(<span class="string">"0002"</span>),<span class="comment">//非法的token</span></div><div class="line">	;</div><div class="line">	<span class="keyword">public</span> String code;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="title">ServiceStatusEnum</span><span class="params">(String code)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.code = code;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<ul>
<li>用户登录状态拦截器，不允许匿名访问的url会经过该filter，如果未登录，则返回未登录提示（未登录处理可根据具体业务进行调整）</li>
</ul>
<h3 id="5、添加登录、退出功能"><a href="#5、添加登录、退出功能" class="headerlink" title="5、添加登录、退出功能"></a>5、添加登录、退出功能</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@Api(value=<span class="string">"用户登录"</span>,tags=&#123;<span class="string">"用户登录"</span>&#125;)</div><div class="line">@RestController</div><div class="line"><span class="keyword">public</span> class LoginController &#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(LoginController.class);</div><div class="line"></div><div class="line">	@Value(<span class="string">"$&#123;server.session.timeout&#125;"</span>)</div><div class="line">	<span class="keyword">private</span> <span class="keyword">String</span> serverSessionTimeout;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 用户登录接口 通过用户名和密码进行登录</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	@ApiOperation(value = <span class="string">"用户登录接口 通过用户名和密码进行登录"</span>, notes = <span class="string">"用户登录接口 通过用户名和密码进行登录"</span>)</div><div class="line">	@ApiImplicitParams(&#123;</div><div class="line">			@ApiImplicitParam(paramType = <span class="string">"query"</span>, name = <span class="string">"username"</span>, value = <span class="string">"用户名"</span>, required = true, dataType = <span class="string">"String"</span>),</div><div class="line">			@ApiImplicitParam(paramType = <span class="string">"query"</span>, name = <span class="string">"pwd"</span>, value = <span class="string">"密码"</span>, required = true, dataType = <span class="string">"String"</span>),</div><div class="line">			@ApiImplicitParam(paramType = <span class="string">"query"</span>, name = <span class="string">"autoLogin"</span>, value = <span class="string">"自动登录"</span>, required = true, dataType = <span class="string">"boolean"</span>)&#125;)</div><div class="line">	@RequestMapping(value = <span class="string">"/login/submit"</span>,method=&#123;RequestMethod.GET,RequestMethod.POST&#125;)</div><div class="line">	<span class="keyword">public</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; subm(HttpServletRequest request,HttpServletResponse response,</div><div class="line">			<span class="keyword">String</span> username,<span class="keyword">String</span> pwd,@RequestParam(value = <span class="string">"autoLogin"</span>, defaultValue = <span class="string">"false"</span>) <span class="keyword">boolean</span> autoLogin) &#123;</div><div class="line">		Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span> = Maps.newLinkedHashMap();</div><div class="line">		Subject currentUser = SecurityUtils.getSubject();</div><div class="line">		User user = userService.findByUsername(username);</div><div class="line">		<span class="built_in">if</span> (user == null) &#123;</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"-1"</span>);</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"账号不存在"</span>);</div><div class="line">			<span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">if</span> (user.getEnable() == <span class="number">0</span>) &#123; <span class="comment">//账号被禁用</span></div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"-1"</span>);</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"账号已被禁用"</span>);</div><div class="line">			<span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">String</span> salt = user.getSalt();</div><div class="line">		UsernamePasswordToken token = null;</div><div class="line">		Integer userId = user.getId();</div><div class="line">		token = <span class="keyword">new</span> UsernamePasswordToken(userId.toString(),SaltMD5Util.encode(pwd, salt));</div><div class="line">		token.setRememberMe(autoLogin);</div><div class="line"></div><div class="line">		loginValid(<span class="built_in">map</span>, currentUser, token);</div><div class="line"></div><div class="line">		<span class="comment">// 验证是否登录成功</span></div><div class="line">		<span class="built_in">if</span> (currentUser.isAuthenticated()) &#123;</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>,<span class="string">"1"</span>);</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"ok"</span>);</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"id"</span>, <span class="keyword">String</span>.valueOf(userId));</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"username"</span>, user.getUsername());</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"name"</span>, user.getName());</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"compnay_id"</span>, <span class="keyword">String</span>.valueOf(user.getCompanyId()));</div><div class="line">			<span class="keyword">String</span> uuidToken = UUID.randomUUID().toString();</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"token"</span>, uuidToken);</div><div class="line">			</div><div class="line">			currentUser.getSession().<span class="built_in">setTimeout</span>(NumberUtils.toLong(serverSessionTimeout, <span class="number">1800</span>)*<span class="number">1000</span>);</div><div class="line">			request.getSession().setAttribute(<span class="string">"token"</span>,uuidToken );</div><div class="line">		&#125; <span class="built_in">else</span> &#123;</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"-1"</span>);</div><div class="line">			token.<span class="built_in">clear</span>();</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	@RequestMapping(value=<span class="string">"logout"</span>,method=RequestMethod.GET)</div><div class="line">	    <span class="keyword">public</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; logout() &#123;</div><div class="line">	        Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span> = Maps.newLinkedHashMap();</div><div class="line">	        Subject currentUser = SecurityUtils.getSubject();</div><div class="line">	        currentUser.logout();</div><div class="line">	        <span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"logout"</span>);</div><div class="line">	        <span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">	    &#125;</div><div class="line">	</div><div class="line">	@RequestMapping(value=<span class="string">"unauth"</span>,method=RequestMethod.GET)</div><div class="line">	    <span class="keyword">public</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; unauth() &#123;</div><div class="line">	        Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span> = Maps.newLinkedHashMap();</div><div class="line">	        <span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"403"</span>);</div><div class="line">	        <span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"msg"</span>, <span class="string">"你没有访问权限"</span>);</div><div class="line">	        <span class="built_in">return</span> <span class="built_in">map</span>;</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> loginValid(Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span>,Subject currentUser, UsernamePasswordToken token) &#123;</div><div class="line">		<span class="keyword">String</span> username = null;</div><div class="line">		<span class="built_in">if</span> (token != null) &#123;</div><div class="line">			username = (<span class="keyword">String</span>) token.getPrincipal();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="built_in">try</span> &#123;</div><div class="line">			<span class="comment">// 在调用了login方法后,SecurityManager会收到AuthenticationToken,并将其发送给已配置的Realm执行必须的认证检查</span></div><div class="line">			<span class="comment">// 每个Realm都能在必要时对提交的AuthenticationTokens作出反应</span></div><div class="line">			<span class="comment">// 所以这一步在调用login(token)方法时,它会走到MyRealm.doGetAuthenticationInfo()方法中,具体验证方式详见此方法</span></div><div class="line">			currentUser.login(token);</div><div class="line">			<span class="built_in">return</span> true;</div><div class="line">		&#125; <span class="built_in">catch</span> (UnknownAccountException | IncorrectCredentialsException ex) &#123;</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"账号或密码错误"</span>);</div><div class="line">		&#125; <span class="built_in">catch</span> (LockedAccountException lae) &#123;</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>,<span class="string">"账户已锁定"</span>);</div><div class="line">		&#125; <span class="built_in">catch</span> (ExcessiveAttemptsException eae) &#123;</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"错误次数过多"</span>);</div><div class="line">		&#125; <span class="built_in">catch</span> (AuthenticationException ae) &#123;</div><div class="line">			<span class="comment">// 通过处理Shiro的运行时AuthenticationException就可以控制用户登录失败或密码错误时的情景</span></div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"description"</span>, <span class="string">"登录失败"</span>);</div><div class="line">			logger.warn(<span class="keyword">String</span>.format(<span class="string">"对用户[%s]进行登录验证..验证未通过"</span>, username),ae);</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">return</span> false;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	@Autowired</div><div class="line">	<span class="keyword">private</span> UserService userService;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<ul>
<li>以上代码是比较通用的登录、退出功能，如果没有特殊需求，可直接使用上述功能</li>
</ul>
<h3 id="6、在接口上添加权限限制"><a href="#6、在接口上添加权限限制" class="headerlink" title="6、在接口上添加权限限制"></a>6、在接口上添加权限限制</h3><p>以UserController为例：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@ApiOperation(value=<span class="meta-string">"获取用户详细信息"</span>, notes=<span class="meta-string">"根据ID查找用户"</span>)</span></div><div class="line">   <span class="meta">@ApiImplicitParam(paramType=<span class="meta-string">"query"</span>,name = <span class="meta-string">"id"</span>, value = <span class="meta-string">"用户ID"</span>, required = true,dataType=<span class="meta-string">"int"</span>)</span></div><div class="line"><span class="meta">@RequiresPermissions(value=&#123;<span class="meta-string">"user:get"</span>&#125;)</span> </div><div class="line"><span class="meta">@RequestMapping(value=<span class="meta-string">"/get"</span>,method=RequestMethod.GET)</span></div><div class="line"><span class="keyword">public</span> User <span class="keyword">get</span>(int id)&#123;</div><div class="line">	User entity = userService.findById(id);</div><div class="line">	entity.setPwd(<span class="literal">null</span>);</div><div class="line">	entity.setSalt(<span class="literal">null</span>);</div><div class="line">	<span class="keyword">return</span> entity;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@ApiOperation(value=<span class="meta-string">"修改密码"</span>, notes=<span class="meta-string">"修改密码"</span>)</span></div><div class="line"><span class="meta">@ApiImplicitParams(&#123;</span></div><div class="line"><span class="meta">	@ApiImplicitParam(paramType = <span class="meta-string">"query"</span>, name = <span class="meta-string">"oldPwd"</span>, value = <span class="meta-string">"旧密码"</span>, required = true, dataType = <span class="meta-string">"String"</span>)</span>,</div><div class="line">	<span class="meta">@ApiImplicitParam(paramType = <span class="meta-string">"query"</span>, name = <span class="meta-string">"pwd"</span>, value = <span class="meta-string">"新密码"</span>, required = true, dataType = <span class="meta-string">"String"</span>)</span>,</div><div class="line">	<span class="meta">@ApiImplicitParam(paramType = <span class="meta-string">"query"</span>, name = <span class="meta-string">"confirmPwd"</span>, value = <span class="meta-string">"新密码(确认)"</span>, required = true, dataType = <span class="meta-string">"String"</span>)</span>&#125;)</div><div class="line"><span class="meta">@RequiresPermissions(value=&#123;<span class="meta-string">"user:reset-pwd"</span>&#125;)</span></div><div class="line"><span class="meta">@RequestMapping(value=<span class="meta-string">"/reset-pwd"</span>,method=RequestMethod.POST)</span></div><div class="line"><span class="keyword">public</span> Return resetPwd(String oldPwd,String pwd,String confirmPwd)&#123;</div><div class="line">	<span class="keyword">if</span>(StringUtils.isBlank(oldPwd) || StringUtils.isBlank(pwd)</div><div class="line">			|| StringUtils.isBlank(confirmPwd) || !pwd.equals(confirmPwd)) &#123;</div><div class="line">		<span class="keyword">return</span> Return.fail(<span class="string">"非法参数"</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	Subject currentUser = SecurityUtils.getSubject();</div><div class="line">	Integer userId=(Integer) currentUser.getPrincipal();</div><div class="line">	User entity = userService.findById(userId);</div><div class="line">	<span class="keyword">if</span>(!entity.getPwd().equals(SaltMD5Util.encode(oldPwd, entity.getSalt())))&#123;</div><div class="line">		<span class="keyword">return</span> Return.fail(<span class="string">"原始密码错误"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> userService.changePwd(entity,pwd);</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<ul>
<li>@RequiresPermissions 和 @RequiresRoles分别用于限制该方法可访问的权限和角色，两者如果同时使用，默认是“&amp;”关系；两者的value参数都可以设置为数组，数组元素间的关系可以通过logical属性来设置，有Logical.AND，Logical.OR两个值可选择</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>spring-boot整合shiro的步骤如下：</p>
<ol>
<li>添加maven依赖</li>
<li>添加ShiroConfigration配置，指定shiro的核心配置</li>
<li>添加MyShiroRealm，指定账户认证策略和角色权限获取方式</li>
<li>添加LoginFilter，即登录拦截器</li>
<li>添加登录、退出功能</li>
<li>通过注解添加接口调用权限限制</li>
</ol>
<p>权限控制基于RBAC模型，涉及的表有：用户（user)、角色（role）、用户角色关系（user_role）、权限（permission）、角色权限关系（role_permission），具体代码可参考github内的示例项目。  </p>
<p>本人搭建好的spring boot web后端开发框架已上传至GitHub，欢迎吐槽！<br><a href="https://github.com/q7322068/rest-base" target="_blank">https://github.com/q7322068/rest-base</a>,已用于多个正式项目，当前可能因为版本问题不是很完善，后续持续优化，希望你能有所收获！</p>

            <div class="article-copyright">
  <i class="fa fa-lightbulb-o"></i>本文由 <a href="http://www.onecoderspace.com/2017/10/02/spring-boot-shiro/index.html">足迹|成长之路</a> 创作，采用
  <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 进行许可。
  可自由转载、引用，但需署名作者且注明文章出处。本文链接为<a href="http://www.onecoderspace.com/2017/10/02/spring-boot-shiro/" target="_blank" rel="external">http://www.onecoderspace.com/2017/10/02/spring-boot-shiro/</a>
</div>

            <div class="article-dashang">
  <span>如果您觉得文章不错,可以请我喝一杯咖啡！</span><br/>
  <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
  <div id="dim-codes" hidden="hidden">
    <ul class="img_box_ul">
      <li><img src="/css/images/weixin.png" /></li>
      <li><img src="/css/images/zhifubao.png" /></li>
    </ul>
  </div>
</div>
<script type="text/javascript">
    $('#btn_donate').click(function(){
      $('#dim-codes').toggle(300);
    })
</script>

        
        </div>
        <footer class="article-footer">

            
    
        <a href="http://www.onecoderspace.com/2017/10/02/spring-boot-shiro/#comments" class="article-comment-link">评论</a>
    


            <div class="share-container">

    <div class="jiathis_style">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_qzone">QQ空间</a>
    <a class="jiathis_button_tsina">新浪微博</a>
    <a class="jiathis_button_tqq">腾讯微博</a>
    <a class="jiathis_button_weixin">微信</a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
    <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<style>
    .jiathis_style div:first-child:not(.jiadiv_01) {
        width: auto !important;
        border: none !important;
    }
    .jiathis_style .jiadiv_01 {
        margin: 10px 0;
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .jiathis_style .jiadiv_01 div:first-child {
        display: none;
    }
    .jiathis_style .jiadiv_02 {
        padding: 7px 0 !important;
    }
    .jiathis_style .jiadiv_02 .jiatitle {
        width: 85px;
        border: none;
        height: auto;
        margin: 3px 10px;
        padding: 6px 10px;
        border-radius: 4px;
    }
    .jiathis_style .jiadiv_02 .jiatitle:hover {
        border: none;
    }
    .jiathis_style .jiadiv_02 .jiatitle:nth-child(even) {
        margin-left: 0;
    }
    .jiathis_style .jtico:hover {
        opacity: 1;
    }
    .jiathis_style .ckepopBottom,
    .jiathis_style .centerBottom {
        width: auto !important;
        padding: 5px;
        background: #f7f7f7;
    }
</style>




</div>

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2017/10/03/git-simple/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    git最简教程
                
            </div>
        </a>
    
    
        <a href="/2017/10/01/spring-boot-redis/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">spring boot项目实战：redis</div>
        </a>
    
</nav>


    
</article>


    
    <section id="comments">
    
        
    <div id="uyan_frame"></div>

    
    </section>



</section>
            
                <aside id="sidebar">
   
        <div class="widget-wrap">
        <h3 class="widget-title">公告</h3>
        <div class="widget">
            <div class="card-front animated col s12 m12 l8 offset-l2 fadeInUp">
                <p class="board">
                    您好，您是第<span id="busuanzi_value_site_uv"></span>位访客<br>
                    602361158<br>
                    微信：sky602361158<br>
                    邮箱：q7322068@126.com<br><br>
                    欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java实战/">java实战</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring-boot实战/">spring boot实战</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">5</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/CORS/" style="font-size: 15px;">CORS</a> <a href="/tags/CSRF/" style="font-size: 10px;">CSRF</a> <a href="/tags/JPA/" style="font-size: 15px;">JPA</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/ajax-post跨域/" style="font-size: 10px;">ajax post跨域</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/html生成页面无法滚动/" style="font-size: 10px;">html生成页面无法滚动</a> <a href="/tags/java实战-spirng-boot-项目高效开发-自动构建-代码生成/" style="font-size: 10px;">java实战 spirng-boot 项目高效开发 自动构建 代码生成</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/shiro/" style="font-size: 15px;">shiro</a> <a href="/tags/shiro-session过期时间/" style="font-size: 10px;">shiro session过期时间</a> <a href="/tags/spring-boot/" style="font-size: 20px;">spring boot</a> <a href="/tags/spring-profile/" style="font-size: 10px;">spring profile</a> <a href="/tags/spring-boot实战/" style="font-size: 10px;">spring-boot实战</a> <a href="/tags/spring-session/" style="font-size: 15px;">spring-session</a> <a href="/tags/swagger2/" style="font-size: 10px;">swagger2</a> <a href="/tags/web基础框架/" style="font-size: 10px;">web基础框架</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/事务/" style="font-size: 15px;">事务</a> <a href="/tags/共享session/" style="font-size: 10px;">共享session</a> <a href="/tags/分布式锁/" style="font-size: 10px;">分布式锁</a> <a href="/tags/分布式锁，redis/" style="font-size: 10px;">分布式锁，redis</a> <a href="/tags/列表数据缓存/" style="font-size: 10px;">列表数据缓存</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a> <a href="/tags/在线接口文档/" style="font-size: 10px;">在线接口文档</a> <a href="/tags/安全/" style="font-size: 10px;">安全</a> <a href="/tags/异常/" style="font-size: 10px;">异常</a> <a href="/tags/异常处理/" style="font-size: 10px;">异常处理</a> <a href="/tags/接口文档/" style="font-size: 10px;">接口文档</a> <a href="/tags/日志/" style="font-size: 15px;">日志</a> <a href="/tags/权限控制/" style="font-size: 15px;">权限控制</a> <a href="/tags/缓存/" style="font-size: 10px;">缓存</a> <a href="/tags/详情页返回列表无刷新/" style="font-size: 10px;">详情页返回列表无刷新</a> <a href="/tags/跨域/" style="font-size: 10px;">跨域</a> <a href="/tags/跨域支持/" style="font-size: 10px;">跨域支持</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://itmuch.com" target="_blank">周立</a>
                    </li>
                
                    <li>
                        <a href="http://blog.didispace.com" target="_blank">程序猿DD</a>
                    </li>
                
                    <li>
                        <a href="http://edisonxu.org" target="_blank">EdisonXu</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 杨文魁<br>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.
        </div>
    </div>
</footer>

        
    
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2144705"></script>



    
      <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <script src="/vendor/lightgallery/js/lightgallery.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-pager.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-hash.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-share.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-video.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>